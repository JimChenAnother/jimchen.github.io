<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[一步步带你理解Laravel请求到响应的生命周期（三）]]></title>
      <url>https://blog.chenjunwu.cn/2017/05/05/Request-to-Response3/</url>
      <content type="html"><![CDATA[<p>Laravel5.1 源码导读系列教程</p>
<a id="more"></a>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><a href="/2017/05/04/Request-to-Response2/">之前</a>我们了解了到请求实例获取的流程，那么当拥有了请求实例对象时，就要对请求进行处理来生成响应，但是接下来并不是直接就开始处理请求，而是又需要一个准备阶段。</p>
<p>还是从入口文件index.php入手，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>我们知道生成请求实例后会直接交给<code>Kernel</code>类对象的<code>handle</code>方法处理，<a href="/2017/05/03/Request-Pipeline-in-Laravel/">之前</a>我们也大致说<code>handle</code>方法处理过程，那么这里我不再复述，而是我们看看到底准备了什么工作。</p>
<h2 id="Bootstrap"><a href="#Bootstrap" class="headerlink" title="Bootstrap"></a>Bootstrap</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Send the given request through the middleware / router.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span><br><span class="line"> * <span class="doctag">@return</span> \Illuminate\Http\Response</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendRequestThroughRouter</span><span class="params">($request)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $this-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</span><br><span class="line"></span><br><span class="line">    Facade::clearResolvedInstance(<span class="string">'request'</span>);</span><br><span class="line">    <span class="comment">// 关注</span></span><br><span class="line">    $this-&gt;bootstrap();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline($this-&gt;app))</span><br><span class="line">                -&gt;send($request)</span><br><span class="line">                -&gt;through($this-&gt;app-&gt;shouldSkipMiddleware() ? [] : $this-&gt;middleware)</span><br><span class="line">                -&gt;then($this-&gt;dispatchToRouter());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="/2017/05/03/Request-Pipeline-in-Laravel/">之前</a>我们并没有讲到<code>bootstrap</code>方法的作用，那么现在我们可以说了，它就是在我们进入请求处理管道时准备工作，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * The bootstrap classes for the application.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@var</span> array</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> $bootstrappers = [</span><br><span class="line">    <span class="string">'Illuminate\Foundation\Bootstrap\DetectEnvironment'</span>,</span><br><span class="line">    <span class="string">'Illuminate\Foundation\Bootstrap\LoadConfiguration'</span>,</span><br><span class="line">    <span class="string">'Illuminate\Foundation\Bootstrap\ConfigureLogging'</span>,</span><br><span class="line">    <span class="string">'Illuminate\Foundation\Bootstrap\HandleExceptions'</span>,</span><br><span class="line">    <span class="string">'Illuminate\Foundation\Bootstrap\RegisterFacades'</span>,</span><br><span class="line">    <span class="string">'Illuminate\Foundation\Bootstrap\RegisterProviders'</span>,</span><br><span class="line">    <span class="string">'Illuminate\Foundation\Bootstrap\BootProviders'</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Bootstrap the application for HTTP requests.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> void</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (! $this-&gt;app-&gt;hasBeenBootstrapped()) &#123;</span><br><span class="line">        $this-&gt;app-&gt;bootstrapWith($this-&gt;bootstrappers());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Get the bootstrap classes for the application.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> array</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrappers</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $this-&gt;bootstrappers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从这里我们就可以清楚了解到了，在准备阶段中我们有七个阶段，每个阶段都交由一个类来处理，在<code>Kernel</code>类中使用<code>$bootstrappers</code>数组维护着类名称，当进行<code>bootstrap</code>调用时，就会通过类名向服务容器请求启动七个阶段，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Run the given array of bootstrap classes.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  array  $bootstrappers</span><br><span class="line"> * <span class="doctag">@return</span> void</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrapWith</span><span class="params">(array $bootstrappers)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $this-&gt;hasBeenBootstrapped = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($bootstrappers <span class="keyword">as</span> $bootstrapper) &#123;</span><br><span class="line">        $this[<span class="string">'events'</span>]-&gt;fire(<span class="string">'bootstrapping: '</span>.$bootstrapper, [$this]);</span><br><span class="line">        <span class="comment">// 注意这里</span></span><br><span class="line">        $this-&gt;make($bootstrapper)-&gt;bootstrap($this);</span><br><span class="line"></span><br><span class="line">        $this[<span class="string">'events'</span>]-&gt;fire(<span class="string">'bootstrapped: '</span>.$bootstrapper, [$this]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从<code>Application</code>类可以看到，通过<code>make($bootstrapper)</code>对<code>$bootstrappers</code>里七个阶段的类进行实例化并调用它们各自的<code>bootstrap</code>方法来启动，实现准备工作。</p>
<h2 id="环境检测和配置加载"><a href="#环境检测和配置加载" class="headerlink" title="环境检测和配置加载"></a>环境检测和配置加载</h2><p>那么首先我们先看看前两个阶段，分别找到<code>DetectEnvironment</code>类和<code>LoadConfiguration</code>类。</p>
<p>在我们之前的<a href="/2017/04/29/env-in-Laravel5-1/">博文</a>有介绍过环境检测相关，其实就是把根目录下.env文件的key-valu值直接加载到环境变量中，是对程序运行的环境进行总体配置。</p>
<p>配置加载，与环境检测类似，都是对应用程序运行时需要的配置进行加载，包括系统配置，数据库配置，session配置等，我们具体看看<code>LoadConfiguration</code>类的<code>bootstrap</code>方法。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Bootstrap the given application.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  \Illuminate\Contracts\Foundation\Application  $app</span><br><span class="line"> * <span class="doctag">@return</span> void</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span><span class="params">(Application $app)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $items = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// First we will see if we have a cache configuration file. If we do, we'll load</span></span><br><span class="line">    <span class="comment">// the configuration items from that file so that it is very quick. Otherwise</span></span><br><span class="line">    <span class="comment">// we will need to spin through every configuration file and load them all.</span></span><br><span class="line">    <span class="keyword">if</span> (file_exists($cached = $app-&gt;getCachedConfigPath())) &#123;</span><br><span class="line">        $items = <span class="keyword">require</span> $cached;</span><br><span class="line"></span><br><span class="line">        $loadedFromCache = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $app-&gt;instance(<span class="string">'config'</span>, $config = <span class="keyword">new</span> Repository($items));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Next we will spin through all of the configuration files in the configuration</span></span><br><span class="line">    <span class="comment">// directory and load each one into the repository. This will make all of the</span></span><br><span class="line">    <span class="comment">// options available to the developer for use in various parts of this app.</span></span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">isset</span>($loadedFromCache)) &#123;</span><br><span class="line">        $this-&gt;loadConfigurationFiles($app, $config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    date_default_timezone_set($config[<span class="string">'app.timezone'</span>]);</span><br><span class="line"></span><br><span class="line">    mb_internal_encoding(<span class="string">'UTF-8'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先是判断一下缓存文件文件存在，此缓存文件就是在根目录下<code>app/bootstrap/cache/config.php</code>文件，该文件将所有配置文件都加载到同一个文件中，这样可以提高配置加载过程的速度，也算是框架的一个优化手段。如果存在此文件就会加载进来，由于此文件是返回一个配置数组，所以使用一个变量可以接受，然后注册到服务容器的共享数组，便于共享使用配置，这里我们可以看到，对于各项配置，Laravel会把它存放在一个仓库（Repository）中，然后共享数组保存的是这个仓库的一个实例，在<code>Repository</code>类，我们可以看到，它提供了更多的操作方法，这就是面向对象编程的好处–封装性。</p>
<p>紧接着，如果根目录下<code>app/bootstrap/cache/config.php</code>文件不存在的话，我们就看到<code>loadConfigurationFiles($app, $config)</code>要执行加载配置文件了，这是程序第一次运行时必须要进行的操作，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Load the configuration items from all of the files.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  \Illuminate\Contracts\Foundation\Application  $app</span><br><span class="line"> * <span class="doctag">@param</span>  \Illuminate\Contracts\Config\Repository  $repository</span><br><span class="line"> * <span class="doctag">@return</span> void</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">loadConfigurationFiles</span><span class="params">(Application $app, RepositoryContract $repository)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($this-&gt;getConfigurationFiles($app) <span class="keyword">as</span> $key =&gt; $path) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过仓库包装提供的方法可以进行配置，有效地进行操作</span></span><br><span class="line">        $repository-&gt;set($key, <span class="keyword">require</span> $path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Get all of the configuration files for the application.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  \Illuminate\Contracts\Foundation\Application  $app</span><br><span class="line"> * <span class="doctag">@return</span> array</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getConfigurationFiles</span><span class="params">(Application $app)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $files = [];</span><br><span class="line"></span><br><span class="line">    $configPath = realpath($app-&gt;configPath());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (Finder::create()-&gt;files()-&gt;name(<span class="string">'*.php'</span>)-&gt;in($configPath) <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        $nesting = $this-&gt;getConfigurationNesting($file, $configPath);</span><br><span class="line"></span><br><span class="line">        $files[$nesting.basename($file-&gt;getRealPath(), <span class="string">'.php'</span>)] = $file-&gt;getRealPath();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $files;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Get the configuration file nesting path.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  \Symfony\Component\Finder\SplFileInfo  $file</span><br><span class="line"> * <span class="doctag">@param</span>  string  $configPath</span><br><span class="line"> * <span class="doctag">@return</span> string</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getConfigurationNesting</span><span class="params">(SplFileInfo $file, $configPath)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $directory = dirname($file-&gt;getRealPath());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($tree = trim(str_replace($configPath, <span class="string">''</span>, $directory), DIRECTORY_SEPARATOR)) &#123;</span><br><span class="line">        $tree = str_replace(DIRECTORY_SEPARATOR, <span class="string">'.'</span>, $tree).<span class="string">'.'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $tree;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文件Illuminate\Config\Repository.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Set a given configuration value.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  array|string  $key</span><br><span class="line"> * <span class="doctag">@param</span>  mixed   $value</span><br><span class="line"> * <span class="doctag">@return</span> void</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">($key, $value = null)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_array($key)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($key <span class="keyword">as</span> $innerKey =&gt; $innerValue) &#123;</span><br><span class="line">            Arr::set($this-&gt;items, $innerKey, $innerValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Arr::set($this-&gt;items, $key, $value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们首先看看<code>getConfigurationFiles($app)</code>会返回什么，其实就是通过服务容器在<a href="/2017/05/04/Request-to-Response1/">之前</a>提到的基础路径绑定中，先获取配置的目录，然后通过Symfony组件的<code>Finder</code>类实现文件识别，最终通过<code>getConfigurationNesting($file, $configPath)</code>获得文件路径，然后将文件名和文件路径通过关联数组的形式存储到<code>$files</code>数组中返回，所以<code>getConfigurationFiles($app)</code>会返回一个数组，key代表配置文件的名称，value代表文件路径，所以通过遍历，就可以获取到文件路径，通过<code>require</code>可以把文件加载，由于配置文件都是返回一个数组，所以<code>require</code>得到的都是一个数组。然后通过<code>set($key, $value)</code>保存到仓库中。</p>
<p><strong>后话：当我们加载配置之后，我们就可以很方便的通过服务容器获取这些配置，比如<code>$app[&#39;config&#39;][&#39;app.debug&#39;]</code>或者<code>$app-&gt;make(&#39;config&#39;)-&gt;get(&#39;app.debug&#39;)</code>获取，至于为什么第一种方式是可以的呢，是因为服务容器<code>Container</code>类和<code>Repository</code>类都实现了<code>ArrayAccess</code>（数组访问）原生接口，只要实现接口的<code>offsetGet($key)</code>方法，当通过<code>$app[&#39;config&#39;]</code>使用时就会自动调用该方法执行<code>$app-&gt;make(&#39;config&#39;)</code>类似的操作，具体查看源代码可知。</strong></p>
<p><strong>由于篇幅过大，七个阶段将分开介绍，这次就只介绍两个阶段：环境检测和配置加载。</strong></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[一步步带你理解Laravel请求到响应的生命周期（二）]]></title>
      <url>https://blog.chenjunwu.cn/2017/05/04/Request-to-Response2/</url>
      <content type="html"><![CDATA[<p>Laravel5.1 源码导读系列教程</p>
<a id="more"></a>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在这次我们知道了生成请求实例之前的准备工作具有五个步骤，那么接下来，我们将看看，请求实例会如何生成。</p>
<h2 id="请求实例化"><a href="#请求实例化" class="headerlink" title="请求实例化"></a>请求实例化</h2><p>我们都知道请求，其实就是一个客户端发起的HTTP报文，其中包含请求行，请求首部和请求实体，那么在Laravel中会将其分类保存在<code>Illuminate/Http/Request</code>类的实例对象中，那么我们一起看看源码是怎么进行的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br><span class="line"></span><br><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>还是从入口文件看，这里我们看到的是请求实例的生成是通过<code>Illuminate\Http\Request</code>类的静态方法<code>capture()</code>生成的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Create a new Illuminate HTTP request from server variables.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> static</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">capture</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span>::enableHttpMethodParameterOverride();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">static</span>::createFromBase(SymfonyRequest::createFromGlobals());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Create an Illuminate request from a Symfony instance.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  \Symfony\Component\HttpFoundation\Request  $request</span><br><span class="line"> * <span class="doctag">@return</span> \Illuminate\Http\Request</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">createFromBase</span><span class="params">(SymfonyRequest $request)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($request <span class="keyword">instanceof</span> <span class="keyword">static</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> $request;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $content = $request-&gt;content;</span><br><span class="line"></span><br><span class="line">    $request = (<span class="keyword">new</span> <span class="keyword">static</span>)-&gt;duplicate(</span><br><span class="line"></span><br><span class="line">        $request-&gt;query-&gt;all(), $request-&gt;request-&gt;all(), $request-&gt;attributes-&gt;all(),</span><br><span class="line"></span><br><span class="line">        $request-&gt;cookies-&gt;all(), $request-&gt;files-&gt;all(), $request-&gt;server-&gt;all()</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    $request-&gt;content = $content;</span><br><span class="line"></span><br><span class="line">    $request-&gt;request = $request-&gt;getInputSource();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $request;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>capture()</code>中，首先是调用一个静态方法<code>enableHttpMethodParameterOverride()</code>，该方法作用就是CSRF验证，为POST请求添加<a href="https://zh.wikipedia.org/zh/%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0" target="_blank" rel="external">CSRF</a>保护，然后我们可以看到请求实例生成是在Symfony框架的请求实例上建立起来的，那么我们看看Symfony是怎么生成请求实例的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Creates a new request with values from PHP's super globals.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> Request A new request</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">createFromGlobals</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">// With the php's bug #66606, the php's built-in web server</span></span><br><span class="line">    <span class="comment">// stores the Content-Type and Content-Length header values in</span></span><br><span class="line">    <span class="comment">// HTTP_CONTENT_TYPE and HTTP_CONTENT_LENGTH fields.</span></span><br><span class="line">    $server = $_SERVER;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'cli-server'</span> === PHP_SAPI) &#123;</span><br><span class="line">        <span class="keyword">if</span> (array_key_exists(<span class="string">'HTTP_CONTENT_LENGTH'</span>, $_SERVER)) &#123;</span><br><span class="line">            $server[<span class="string">'CONTENT_LENGTH'</span>] = $_SERVER[<span class="string">'HTTP_CONTENT_LENGTH'</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (array_key_exists(<span class="string">'HTTP_CONTENT_TYPE'</span>, $_SERVER)) &#123;</span><br><span class="line">            $server[<span class="string">'CONTENT_TYPE'</span>] = $_SERVER[<span class="string">'HTTP_CONTENT_TYPE'</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $request = <span class="keyword">self</span>::createRequestFromFactory($_GET, $_POST, <span class="keyword">array</span>(), $_COOKIE, $_FILES, $server);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> === strpos($request-&gt;headers-&gt;get(<span class="string">'CONTENT_TYPE'</span>), <span class="string">'application/x-www-form-urlencoded'</span>)</span><br><span class="line">        &amp;&amp; in_array(strtoupper($request-&gt;server-&gt;get(<span class="string">'REQUEST_METHOD'</span>, <span class="string">'GET'</span>)), <span class="keyword">array</span>(<span class="string">'PUT'</span>, <span class="string">'DELETE'</span>, <span class="string">'PATCH'</span>))</span><br><span class="line">    ) &#123;</span><br><span class="line">        parse_str($request-&gt;getContent(), $data);</span><br><span class="line">        $request-&gt;request = <span class="keyword">new</span> ParameterBag($data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $request;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>createFromGlobals()</code>中，一开始通过注释也可以知道，这里为了解决PHP语言本身的一个BUG，做一次处理，即是当PHP的接口类型是cli-server时，那么就会将Content-Length和Content-Type的值保存在HTTP_CONTENT_LENGTH和HTTP_CONTENT_TYPE中，所以需要处理一下，紧接着请求创建工厂。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Sets a callable able to create a Request instance.</span><br><span class="line"> *</span><br><span class="line"> * This is mainly useful when you need to override the Request class</span><br><span class="line"> * to keep BC with an existing system. It should not be used for any</span><br><span class="line"> * other purpose.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> callable|null $callable A PHP callable</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">setFactory</span><span class="params">($callable)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">self</span>::$requestFactory = $callable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">createRequestFromFactory</span><span class="params">(array $query = array<span class="params">()</span>, array $request = array<span class="params">()</span>, array $attributes = array<span class="params">()</span>, array $cookies = array<span class="params">()</span>, array $files = array<span class="params">()</span>, array $server = array<span class="params">()</span>, $content = null)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>::$requestFactory) &#123;</span><br><span class="line">        $request = call_user_func(<span class="keyword">self</span>::$requestFactory, $query, $request, $attributes, $cookies, $files, $server, $content);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!$request <span class="keyword">instanceof</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> \LogicException(<span class="string">'The Request factory must return an instance of Symfony\Component\HttpFoundation\Request.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $request;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">static</span>($query, $request, $attributes, $cookies, $files, $server, $content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在此方法中，如果需要自定义请求工厂方法，则可将自定义工厂方法赋值静态变量<code>$requestFactory</code>，通过<code>setFactory($callable)</code>方法传入回调函数。否则就会通过<a href="/2017/04/08/php-Q-A-2/">new static</a>的语法进行创建请求实例。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(array $query = array<span class="params">()</span>, array $request = array<span class="params">()</span>, array $attributes = array<span class="params">()</span>, array $cookies = array<span class="params">()</span>, array $files = array<span class="params">()</span>, array $server = array<span class="params">()</span>, $content = null)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $this-&gt;initialize($query, $request, $attributes, $cookies, $files, $server, $content);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">initialize</span><span class="params">(array $query = array<span class="params">()</span>, array $request = array<span class="params">()</span>, array $attributes = array<span class="params">()</span>, array $cookies = array<span class="params">()</span>, array $files = array<span class="params">()</span>, array $server = array<span class="params">()</span>, $content = null)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $this-&gt;request = <span class="keyword">new</span> ParameterBag($request);</span><br><span class="line">    $this-&gt;query = <span class="keyword">new</span> ParameterBag($query);</span><br><span class="line">    $this-&gt;attributes = <span class="keyword">new</span> ParameterBag($attributes);</span><br><span class="line">    $this-&gt;cookies = <span class="keyword">new</span> ParameterBag($cookies);</span><br><span class="line">    $this-&gt;files = <span class="keyword">new</span> FileBag($files);</span><br><span class="line">    $this-&gt;server = <span class="keyword">new</span> ServerBag($server);</span><br><span class="line">    $this-&gt;headers = <span class="keyword">new</span> HeaderBag($this-&gt;server-&gt;getHeaders());</span><br><span class="line"></span><br><span class="line">    $this-&gt;content = $content;</span><br><span class="line">    $this-&gt;languages = <span class="keyword">null</span>;</span><br><span class="line">    $this-&gt;charsets = <span class="keyword">null</span>;</span><br><span class="line">    $this-&gt;encodings = <span class="keyword">null</span>;</span><br><span class="line">    $this-&gt;acceptableContentTypes = <span class="keyword">null</span>;</span><br><span class="line">    $this-&gt;pathInfo = <span class="keyword">null</span>;</span><br><span class="line">    $this-&gt;requestUri = <span class="keyword">null</span>;</span><br><span class="line">    $this-&gt;baseUrl = <span class="keyword">null</span>;</span><br><span class="line">    $this-&gt;basePath = <span class="keyword">null</span>;</span><br><span class="line">    $this-&gt;method = <span class="keyword">null</span>;</span><br><span class="line">    $this-&gt;format = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以从构造函数到<code>initialize</code>方法看，请求相关的参数都经过了<code>ParameterBag</code>类或者<code>FileBag</code>类，<code>ServerBag</code>类，<code>HeaderBag</code>类进行封装（后三者均是<code>ParameterBag</code>类的子类），添加更多的处理方法。</p>
<p><strong>总结：于是乎我们把Laravel请求实例获得的流程走了一遍，大概清楚了Laravel请求实例是构建在Symfony框架请求实例之上，所以在这一部分，想要详细了解可以深入了解Symfont的请求类。</strong></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[一步步带你理解Laravel请求到响应的生命周期（一）]]></title>
      <url>https://blog.chenjunwu.cn/2017/05/04/Request-to-Response1/</url>
      <content type="html"><![CDATA[<p>Laravel5.1 源码导读系列教程</p>
<a id="more"></a>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Laravel的整个流程我们通过入口文件可以一览无余：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">| Register The Auto Loader</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">|</span><br><span class="line">| Composer provides a convenient, automatically generated class loader for</span><br><span class="line">| our application. We just need to utilize it! We'll simply require it</span><br><span class="line">| into the script here so that we don't have to worry about manual</span><br><span class="line">| loading any of our classes later on. It feels nice to relax.</span><br><span class="line">|</span><br><span class="line">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">| Turn On The Lights</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">|</span><br><span class="line">| We need to illuminate PHP development, so let us turn on the lights.</span><br><span class="line">| This bootstraps the framework and gets it ready for use, then it</span><br><span class="line">| will load up this application so that we can run it and send</span><br><span class="line">| the responses back to the browser and delight our users.</span><br><span class="line">|</span><br><span class="line">*/</span></span><br><span class="line"></span><br><span class="line">$app = <span class="keyword">require_once</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/app.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">| Run The Application</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">|</span><br><span class="line">| Once we have the application, we can handle the incoming request</span><br><span class="line">| through the kernel, and send the associated response back to</span><br><span class="line">| the client's browser allowing them to enjoy the creative</span><br><span class="line">| and wonderful application we have prepared for them.</span><br><span class="line">|</span><br><span class="line">*/</span></span><br><span class="line"></span><br><span class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br><span class="line"></span><br><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$response-&gt;send();</span><br><span class="line"></span><br><span class="line">$kernel-&gt;terminate($request, $response);</span><br></pre></td></tr></table></figure>
<p>那么在这个流程的生命周期里，请求经过什么工序处理，然后生成响应返回客户端，在这里通过一张图为你描述生命周期中<strong>准备阶段</strong>认知脉络：</p>
<p><img src="/images/asset/2017/2017-05-04_0947.png" alt="流程框架"></p>
<h2 id="服务容器实例化"><a href="#服务容器实例化" class="headerlink" title="服务容器实例化"></a>服务容器实例化</h2><p>在这部分，我们在这<a href="/2017/04/29/env-in-Laravel5-1/">之前</a>曾经提到过，这里再复习一遍：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注意这里，就是获取一个服务容器实例，那么容器的实例化就在app.php文件中得到</span></span><br><span class="line">$app = <span class="keyword">require_once</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/app.php'</span>;</span><br></pre></td></tr></table></figure>
<p>在~/app/bootstrap/app.php文件中，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$app = <span class="keyword">new</span> Illuminate\Foundation\Application(</span><br><span class="line">    realpath(<span class="keyword">__DIR__</span>.<span class="string">'/../'</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>这里就是实例化一个容器，这里的需要传入的参数就是项目的根目录，我们可以看看<code>Application</code>类的构造函数，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Create a new Illuminate application instance.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  string|null  $basePath</span><br><span class="line"> * <span class="doctag">@return</span> void</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($basePath = null)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $this-&gt;registerBaseBindings();</span><br><span class="line"></span><br><span class="line">    $this-&gt;registerBaseServiceProviders();</span><br><span class="line"></span><br><span class="line">    $this-&gt;registerCoreContainerAliases();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($basePath) &#123;</span><br><span class="line">        $this-&gt;setBasePath($basePath);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以在这里，我们又可以看到了，在实例化服务容器时，经过了四个步骤，而这四个步骤将是我们接下来所讲。</p>
<h2 id="注册服务容器本身"><a href="#注册服务容器本身" class="headerlink" title="注册服务容器本身"></a>注册服务容器本身</h2><p>在第一步中注册基础绑定，其实就是将服务容器实例注册到服务容器中，说白就是自己维护自己一个实例，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Register the basic bindings into the container.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> void</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerBaseBindings</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">// 在服务容器类Container中，它维护这一个静态变量$instance保存服务容器实例</span></span><br><span class="line">    <span class="keyword">static</span>::setInstance($this);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册一个可共享的服务容器实例</span></span><br><span class="line">    $this-&gt;instance(<span class="string">'app'</span>, $this);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册另一个别名可共享的服务容器实例</span></span><br><span class="line">    $this-&gt;instance(<span class="string">'Illuminate\Container\Container'</span>, $this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面，或许我们在<a href="/2017/05/01/Service-provider/">服务提供者</a>一节没有提及以上，但是在Laravel确实存在，除了拥有一个静态实例对象，还维护一个<code>$instances</code>数组负责保存可共享实例（如果还记得，我们也有提及过<code>bind</code>第三个参数<code>$shared</code>就是与可共享实例有关，一种单例模式的实现方法）。<code>instance()</code>方法就是负责把实例注册到<code>$instance</code>数组中。</p>
<h2 id="注册基础服务提供者"><a href="#注册基础服务提供者" class="headerlink" title="注册基础服务提供者"></a>注册基础服务提供者</h2><p>在第二步中注册基础服务提供者，其实就是将路由和事件的提供者的功能加载到服务容器上，这两者最为基础是因为一个现代框架最基本的需要是路由分发，而路由分发也离不开事件分发功能。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Register all of the base service providers.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> void</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerBaseServiceProviders</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $this-&gt;register(<span class="keyword">new</span> EventServiceProvider($this));</span><br><span class="line"></span><br><span class="line">    $this-&gt;register(<span class="keyword">new</span> RoutingServiceProvider($this));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Register a service provider with the application.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  \Illuminate\Support\ServiceProvider|string  $provider</span><br><span class="line"> * <span class="doctag">@param</span>  array  $options</span><br><span class="line"> * <span class="doctag">@param</span>  bool   $force</span><br><span class="line"> * <span class="doctag">@return</span> \Illuminate\Support\ServiceProvider</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">($provider, $options = [], $force = false)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (($registered = $this-&gt;getProvider($provider)) &amp;&amp; ! $force) &#123;</span><br><span class="line">        <span class="keyword">return</span> $registered;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the given "provider" is a string, we will resolve it, passing in the</span></span><br><span class="line">    <span class="comment">// application instance automatically for the developer. This is simply</span></span><br><span class="line">    <span class="comment">// a more convenient way of specifying your service provider classes.</span></span><br><span class="line">    <span class="keyword">if</span> (is_string($provider)) &#123;</span><br><span class="line">        $provider = $this-&gt;resolveProviderClass($provider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $provider-&gt;register();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Once we have registered the service we will iterate through the options</span></span><br><span class="line">    <span class="comment">// and set each of them on the application so they will be available on</span></span><br><span class="line">    <span class="comment">// the actual loading of the service objects and for developer usage.</span></span><br><span class="line">    <span class="keyword">foreach</span> ($options <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">        $this[$key] = $value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $this-&gt;markAsRegistered($provider);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the application has already booted, we will call this boot method on</span></span><br><span class="line">    <span class="comment">// the provider class so it has an opportunity to do its boot logic and</span></span><br><span class="line">    <span class="comment">// will be ready for any usage by the developer's application logics.</span></span><br><span class="line">    <span class="keyword">if</span> ($this-&gt;booted) &#123;</span><br><span class="line">        $this-&gt;bootProvider($provider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $provider;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>registerBaseServiceProviders()</code>中向注册方法两个提供者的实例，那么我们进入<code>register()</code>方法查看就可以知道，会直接调用提供者的<code>register($provider, $options, $force)</code>方法将服务注册到容器中，当注册完毕之后就会通过<code>bootProvider($provider)</code>来调用提供者的<code>boot()</code>方法启动服务，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Boot the given service provider.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  \Illuminate\Support\ServiceProvider  $provider</span><br><span class="line"> * <span class="doctag">@return</span> mixed</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">bootProvider</span><span class="params">(ServiceProvider $provider)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (method_exists($provider, <span class="string">'boot'</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> $this-&gt;call([$provider, <span class="string">'boot'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取你会有疑问，有时候我去看看别人的提供者的时候，怎么都没有<code>boot</code>方法的？如果调用不是会出错吗？恩，但是在Laravel中写自己的提供者需要遵循一个规范，就是要继承<code>ServiceProvider</code>类，而这个类中恰恰通过魔术方法对<code>boot</code>的不存在调用进行了处理，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Dynamically handle missing method calls.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  string  $method</span><br><span class="line"> * <span class="doctag">@param</span>  array  $parameters</span><br><span class="line"> * <span class="doctag">@return</span> mixed</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $parameters)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($method == <span class="string">'boot'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BadMethodCallException(<span class="string">"Call to undefined method [&#123;$method&#125;]"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果<code>boot</code>方法不存在就会调用<code>__call($method, $parameters)</code>，在这里处理了<code>boot</code>方法不存在的情况。</p>
<h2 id="注册核心类别名"><a href="#注册核心类别名" class="headerlink" title="注册核心类别名"></a>注册核心类别名</h2><p>在现代PHP框架中，一般我们都是通过命名空间来对类和接口进行分类，那么如果想通过自动加载来获得对应的类时，必须使用完整的路径，也就是命名空间加类名（狭义），正因为要这样，那么有时候名字会很长，为此Laravel在容器中为一些常用的服务注册了别名来替代。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Register the core class aliases in the container.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> void</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">registerCoreContainerAliases</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $aliases = [</span><br><span class="line">        <span class="string">'app'</span>                  =&gt; [<span class="string">'Illuminate\Foundation\Application'</span>, <span class="string">'Illuminate\Contracts\Container\Container'</span>, <span class="string">'Illuminate\Contracts\Foundation\Application'</span>],</span><br><span class="line">        <span class="string">'auth'</span>                 =&gt; <span class="string">'Illuminate\Auth\AuthManager'</span>,</span><br><span class="line">        <span class="comment">// ...以下省略</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($aliases <span class="keyword">as</span> $key =&gt; $aliases) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ((<span class="keyword">array</span>) $aliases <span class="keyword">as</span> $alias) &#123;</span><br><span class="line">            $this-&gt;alias($key, $alias);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里又涉及了容器提供的一个<code>alias($key, $alias)</code>方法，这是服务容器提供别名注册的API，在Laravel服务容器内部也会维护<code>$aliases</code>数组，专门负责保存所有的别名和对应类的完整类名。</p>
<h2 id="基础路径设置"><a href="#基础路径设置" class="headerlink" title="基础路径设置"></a>基础路径设置</h2><p>最后一部分准备，就是保存框架中各个部分的路径，方便以后需要加载其他文件时可以获取其对应的路径。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Set the base path for the application.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  string  $basePath</span><br><span class="line"> * <span class="doctag">@return</span> $this</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setBasePath</span><span class="params">($basePath)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $this-&gt;basePath = rtrim($basePath, <span class="string">'\/'</span>);</span><br><span class="line"></span><br><span class="line">    $this-&gt;bindPathsInContainer();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $this;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Bind all of the application paths in the container.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> void</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">bindPathsInContainer</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $this-&gt;instance(<span class="string">'path'</span>, $this-&gt;path());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ([<span class="string">'base'</span>, <span class="string">'config'</span>, <span class="string">'database'</span>, <span class="string">'lang'</span>, <span class="string">'public'</span>, <span class="string">'storage'</span>] <span class="keyword">as</span> $path) &#123;</span><br><span class="line">        $this-&gt;instance(<span class="string">'path.'</span>.$path, $this-&gt;&#123;$path.<span class="string">'Path'</span>&#125;());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里可以看到，先是保存了根路径目录，然后通过调用<code>bindPathsInContainer()</code>方法对根目录下所有文件夹路径进行了基础路径共享绑定，而这个过程是通过动态调用相应的方法进行绑定，所以你在此类中会发现如下这些方法：<code>basePath()</code>，<code>configPath()</code>，<code>databasePath()</code>，<code>langPath()</code>，<code>publicPath()</code>，<code>storagePath()</code>。</p>
<p><strong>后话：至此我们搞清楚了在生成请求实例前Laravel框架到底准备了，概括起来就是前言中的脉络图五点：</strong></p>
<ul>
<li><strong>服务容器实例化</strong></li>
<li><strong>注册基础绑定</strong></li>
<li><strong>注册基础服务提供者</strong></li>
<li><strong>注册核心类别名</strong></li>
<li><strong>绑定基础路径</strong></li>
</ul>
<p><strong>那么接下来就可以看看Laravel在请求进来时怎么为请求生成实例。</strong></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[一步步带你理解Laravel中的请求管道]]></title>
      <url>https://blog.chenjunwu.cn/2017/05/03/Request-Pipeline-in-Laravel/</url>
      <content type="html"><![CDATA[<p>Laravel5.1 源码导读系列教程</p>
<a id="more"></a>
<h2 id="大致请求流程"><a href="#大致请求流程" class="headerlink" title="大致请求流程"></a>大致请求流程</h2><p>如果我们从入口文件index.php看，就可以看到大致的流程了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自动加载</span></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得应用的容器实例</span></span><br><span class="line">$app = <span class="keyword">require_once</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/app.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从容器中生成kernel类的实例</span></span><br><span class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理请求，生成响应</span></span><br><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送响应给客户端</span></span><br><span class="line">$response-&gt;send();</span><br><span class="line"></span><br><span class="line">$kernel-&gt;terminate($request, $response);</span><br></pre></td></tr></table></figure>
<p>所以我们大致看到流程，那么关注点在这</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>我们看到了<code>handle</code>方法，是不是想起什么？</p>
<h2 id="深入Kernel类"><a href="#深入Kernel类" class="headerlink" title="深入Kernel类"></a>深入Kernel类</h2><p>文件 <code>Illuminate\Foundation\Http\Kernel.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Handle an incoming HTTP request.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span><br><span class="line"> * <span class="doctag">@return</span> \Illuminate\Http\Response</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $request-&gt;enableHttpMethodParameterOverride();</span><br><span class="line"></span><br><span class="line">        $response = $this-&gt;sendRequestThroughRouter($request);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        $this-&gt;reportException($e);</span><br><span class="line"></span><br><span class="line">        $response = $this-&gt;renderException($request, $e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable $e) &#123;</span><br><span class="line">        $e = <span class="keyword">new</span> FatalThrowableError($e);</span><br><span class="line"></span><br><span class="line">        $this-&gt;reportException($e);</span><br><span class="line"></span><br><span class="line">        $response = $this-&gt;renderException($request, $e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $this-&gt;app[<span class="string">'events'</span>]-&gt;fire(<span class="string">'kernel.handled'</span>, [$request, $response]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从注释我们可以明白，当请求进来时，这是首先处理的方法，我们注意到<code>sendRequestThroughRouter($request)</code>，这里把请求传入，通过路由匹配进行调度处理</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Send the given request through the middleware / router.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span><br><span class="line"> * <span class="doctag">@return</span> \Illuminate\Http\Response</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendRequestThroughRouter</span><span class="params">($request)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $this-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</span><br><span class="line"></span><br><span class="line">    Facade::clearResolvedInstance(<span class="string">'request'</span>);</span><br><span class="line"></span><br><span class="line">    $this-&gt;bootstrap();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline($this-&gt;app))</span><br><span class="line">                -&gt;send($request)</span><br><span class="line">                -&gt;through($this-&gt;app-&gt;shouldSkipMiddleware() ? [] : $this-&gt;middleware)</span><br><span class="line">                -&gt;then($this-&gt;dispatchToRouter());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>于是我们可以看到返回值，新建一个<code>Pipeline</code>类，并依此调用<code>send()</code>，<code>through()</code>，<code>then()</code></p>
<p>前两个方法比较好理解，分别将$request和中间件数组向<code>Pipeline</code>类实例传递，我们也看一下这里调用到的方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Determine if middleware has been disabled for the application.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> bool</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">shouldSkipMiddleware</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $this-&gt;bound(<span class="string">'middleware.disable'</span>) &amp;&amp;</span><br><span class="line">           $this-&gt;make(<span class="string">'middleware.disable'</span>) === <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Get the route dispatcher callback.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> \Closure</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToRouter</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($request)</span> </span>&#123;</span><br><span class="line">        $this-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $this-&gt;router-&gt;dispatch($request);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，以上两个方法并不在同一个类中，这里只是为了演示效果放在同一个地方展示，<code>shouldSkipMiddleware()</code>就是判断应用是不是需要调用中间件，需要返回真，并通过<code>through()</code>向<code>Pipeline</code>实例传递该类包含的中间件数组<code>$middleware</code>。而<code>dispatchToRouter()</code>由注释我们得知该方法作用是获得路由分发的回调函数，如果我们继续分析，其实这就是我们<a href="/2017/05/01/Service-provider/">上一节</a>所说到的默认匿名函数，两者异曲同工之妙。</p>
<h2 id="请求管道处理分析"><a href="#请求管道处理分析" class="headerlink" title="请求管道处理分析"></a>请求管道处理分析</h2><p>我们继续深入<code>Pipeline</code>类，只关注几个重要的API方法和属性</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * The object being passed through the pipeline.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@var</span> mixed</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> $passable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * The array of class pipes.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@var</span> array</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> $pipes = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * The method to call on each pipe.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@var</span> string</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> $method = <span class="string">'handle'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Set the object being sent through the pipeline.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  mixed  $passable</span><br><span class="line"> * <span class="doctag">@return</span> $this</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">($passable)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $this-&gt;passable = $passable;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $this;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Set the array of pipes.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  array|mixed  $pipes</span><br><span class="line"> * <span class="doctag">@return</span> $this</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">through</span><span class="params">($pipes)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $this-&gt;pipes = is_array($pipes) ? $pipes : func_get_args();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $this;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Run the pipeline with a final destination callback.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  \Closure  $destination</span><br><span class="line"> * <span class="doctag">@return</span> mixed</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">then</span><span class="params">(Closure $destination)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $firstSlice = $this-&gt;getInitialSlice($destination);</span><br><span class="line"></span><br><span class="line">    $pipes = array_reverse($this-&gt;pipes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> call_user_func(</span><br><span class="line">        array_reduce($pipes, $this-&gt;getSlice(), $firstSlice), $this-&gt;passable</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Get a Closure that represents a slice of the application onion.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> \Closure</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getSlice</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($stack, $pipe)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($passable)</span> <span class="title">use</span> <span class="params">($stack, $pipe)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// If the pipe is an instance of a Closure, we will just call it directly but</span></span><br><span class="line">            <span class="comment">// otherwise we'll resolve the pipes out of the container and call it with</span></span><br><span class="line">            <span class="comment">// the appropriate method and arguments, returning the results back out.</span></span><br><span class="line">            <span class="keyword">if</span> ($pipe <span class="keyword">instanceof</span> Closure) &#123;</span><br><span class="line">                <span class="keyword">return</span> call_user_func($pipe, $passable, $stack);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">list</span>($name, $parameters) = $this-&gt;parsePipeString($pipe);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> call_user_func_array([$this-&gt;container-&gt;make($name), $this-&gt;method],</span><br><span class="line">                                            array_merge([$passable, $stack], $parameters));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Get the initial slice to begin the stack call.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  \Closure  $destination</span><br><span class="line"> * <span class="doctag">@return</span> \Closure</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getInitialSlice</span><span class="params">(Closure $destination)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($passable)</span> <span class="title">use</span> <span class="params">($destination)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> call_user_func($destination, $passable);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>是不是突然有点混乱了？不急，接下来我们慢慢解释。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * The object being passed through the pipeline.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@var</span> mixed</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> $passable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * The array of class pipes.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@var</span> array</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> $pipes = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Set the object being sent through the pipeline.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  mixed  $passable</span><br><span class="line"> * <span class="doctag">@return</span> $this</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">($passable)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $this-&gt;passable = $passable;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $this;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Set the array of pipes.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  array|mixed  $pipes</span><br><span class="line"> * <span class="doctag">@return</span> $this</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">through</span><span class="params">($pipes)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">// func_get_args()具体可以查看PHP文档，大致含义返回该函数的参数列表数组，</span></span><br><span class="line">    <span class="comment">// 也就是该方法提供给调用者有更多调用形式，可以使用参数列表代替数组传递</span></span><br><span class="line">    $this-&gt;pipes = is_array($pipes) ? $pipes : func_get_args();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $this;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里由注释可见其含义，<code>$passable</code>和<code>$pipes</code>就是在<code>Pipeline</code>类中分别负责维护在<code>Kernel</code>类中传递进来的<code>$request</code>请求和中间件数组，分别由<code>send()</code>和<code>through()</code>进行操作。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Run the pipeline with a final destination callback.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  \Closure  $destination</span><br><span class="line"> * <span class="doctag">@return</span> mixed</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">then</span><span class="params">(Closure $destination)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $firstSlice = $this-&gt;getInitialSlice($destination);</span><br><span class="line"></span><br><span class="line">    $pipes = array_reverse($this-&gt;pipes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> call_user_func(</span><br><span class="line">        array_reduce($pipes, $this-&gt;getSlice(), $firstSlice), $this-&gt;passable</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>then()</code>方法我们再熟悉不过了，这不就和<a href="/2017/05/01/Service-provider/">上一节</a>看到的<code>then()</code>方法如出一辙吗？这里只是有个小细节<code>$pipes = array_reverse($this-&gt;pipes);</code>，这里只是将<code>$this-&gt;pipes</code>倒置了而已，为什么要这样呢？让我们回想<a href="/2017/05/01/Service-provider/">上一节</a>我们没有这样做会怎么样？即使我们的数组是这样排序：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> $pipes = [</span><br><span class="line">    <span class="string">'Request1'</span>,</span><br><span class="line">    <span class="string">'Request2'</span>,</span><br><span class="line">    <span class="string">'Request3'</span>,</span><br><span class="line">    <span class="string">'Request4'</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>但是最终调用顺序是这样的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Request4::handle(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Request3::handle(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Request2::handle(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">return</span> Reuqest1::handle(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span>&#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">'请求处理中...'</span> . <span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以将数组倒置的作用就在此，能够按数组的顺序进行请求处理。</p>
<p>那么最初的堆栈调用片段，究竟是怎么回事呢？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Get the initial slice to begin the stack call.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  \Closure  $destination</span><br><span class="line"> * <span class="doctag">@return</span> \Closure</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getInitialSlice</span><span class="params">(Closure $destination)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($passable)</span> <span class="title">use</span> <span class="params">($destination)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> call_user_func($destination, $passable);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结合<code>then()</code>，从这里看到，匿名函数<code>$destination</code>其实就是<code>Kernel</code>类中的<code>dispatchToRouter()</code>方法，这里这个方法在返回的闭包函数中进行了调用并返回，实质就是一个回调函数，所以<code>$firstSlice</code>其实就是一个会返回<code>Kernel</code>类<code>dispatchToRouter()</code>方法中返回值的闭包函数，只是这里为回调函数传入参数，参数为请求实例。</p>
<h2 id="请求管道处理关键"><a href="#请求管道处理关键" class="headerlink" title="请求管道处理关键"></a>请求管道处理关键</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * The method to call on each pipe.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@var</span> string</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> $method = <span class="string">'handle'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Get a Closure that represents a slice of the application onion.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> \Closure</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getSlice</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($stack, $pipe)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($passable)</span> <span class="title">use</span> <span class="params">($stack, $pipe)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// If the pipe is an instance of a Closure, we will just call it directly but</span></span><br><span class="line">            <span class="comment">// otherwise we'll resolve the pipes out of the container and call it with</span></span><br><span class="line">            <span class="comment">// the appropriate method and arguments, returning the results back out.</span></span><br><span class="line">            <span class="keyword">if</span> ($pipe <span class="keyword">instanceof</span> Closure) &#123;</span><br><span class="line">                <span class="keyword">return</span> call_user_func($pipe, $passable, $stack);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">list</span>($name, $parameters) = $this-&gt;parsePipeString($pipe);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> call_user_func_array([$this-&gt;container-&gt;make($name), $this-&gt;method],</span><br><span class="line">                                            array_merge([$passable, $stack], $parameters));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这和<a href="/2017/05/01/Service-provider/">上一节</a>的关键一样，同样可以获得一个闭包函数，用来处理中间件类，而这个闭包函数的参数正是请求实例。我们更加关注else的实现，因为这里是对应中间件类处理的过程，我们解读一下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> call_user_func_array([$this-&gt;container-&gt;make($name), $this-&gt;method], array_merge([$passable, $stack], $parameters));</span><br></pre></td></tr></table></figure>
<p>首先<code>call_user_func_array()</code>是执行一个方法，而这个方法是从容器中实例化对应的中间件类并从中调用<code>handle</code>方法处理<code>array_merge([$passable, $stack], $parameters)</code>这里返回的数组参数，如果你去查看中间件类，一定会看到<code>handle</code>方法的签名一般是这样的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Handle an incoming request.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span><br><span class="line"> * <span class="doctag">@param</span>  \Closure  $next</span><br><span class="line"> * <span class="doctag">@return</span> mixed</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 处理</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $next($request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就正如装饰者模式所描述一样，请求每经过一个中间件就会进行一次包装，然后返回包装后的闭包函数执行结果，此<code>$next</code>正是<code>getSlice</code>所返回的匿名函数返回的闭包函数。</p>
<p><strong>后话：正是这个请求管道处理类，使得Laravel对请求的处理显得如此的“优雅”，每一个请求进来，一道道的工序复杂处理，这些都对开发者进行了隐藏，使得开发者只需要关注每一道工序中我们需要干什么，怎么做，不用去关心工序的执行，全都交给框架进行处理，使得开发者关注点更加关心应用的业务而不是实现流程细节，就像<a href="https://github.com/JimChenWYU/my-php-awesome/tree/master/learning-php-design-patterns/TemplateMethod" target="_blank" rel="external">模板方法模式</a>一样，这就是我所理解的“优雅”</strong>。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[一步步带你理解请求处理管道]]></title>
      <url>https://blog.chenjunwu.cn/2017/05/02/Request-pipeline/</url>
      <content type="html"><![CDATA[<p>Laravel5.1 源码导读系列教程</p>
<a id="more"></a>
<h2 id="理解装饰器模式"><a href="#理解装饰器模式" class="headerlink" title="理解装饰器模式"></a>理解装饰器模式</h2><p>对于关于理解装饰器模式，大家可以看一下<a href="https://github.com/JimChenWYU/my-php-awesome/tree/master/learning-php-design-patterns/Decorator" target="_blank" rel="external">这里</a>或者找相关书籍查看和理解，简单来说就是不改变原有代码基础上通过不同类来对实例对象进行包装，增添更多功能。</p>
<h2 id="请求处理管道的思维导图"><a href="#请求处理管道的思维导图" class="headerlink" title="请求处理管道的思维导图"></a>请求处理管道的思维导图</h2><p><img src="/images/asset/2017/2017-05-02_154419.png" alt="思维导图"></p>
<p>这里通过简化模拟一下请求处理的管道，发现本质。</p>
<h2 id="通过思维导图实现代码"><a href="#通过思维导图实现代码" class="headerlink" title="通过思维导图实现代码"></a>通过思维导图实现代码</h2><p>从图中我们可以知道类Request都具有相同的接口，那么我们可以约定一个接口规范</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">RequestInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">// 我们之前讲过装饰者模式，这里是通过闭包函数实现</span></span><br><span class="line">    <span class="comment">// 通过之后实现类及调用就可以看出</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(Closure $next)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接口有了那么我们就遵循接口开始实现</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request1</span> <span class="keyword">implements</span> <span class="title">RequestInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(Closure $next)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Request1 Begin."</span> . <span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line">        $next();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Request1 End."</span> . <span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request2</span> <span class="keyword">implements</span> <span class="title">RequestInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(Closure $next)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Request2 Begin."</span> . <span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line">        $next();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Request2 End."</span> . <span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request3</span> <span class="keyword">implements</span> <span class="title">RequestInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(Closure $next)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Request3 Begin."</span> . <span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line">        $next();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Request3 End."</span> . <span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request4</span> <span class="keyword">implements</span> <span class="title">RequestInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(Closure $next)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Request4 Begin."</span> . <span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line">        $next();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Request4 End."</span> . <span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>四种请求处理过程我们均已实现，为了简化都是打印一句话，可以在浏览器上直观显示流程；<br>我们还需要一个客户端来发出请求</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">// 这里包含了所有的请求</span></span><br><span class="line">    <span class="keyword">private</span> $pipes = [</span><br><span class="line">        <span class="string">'Request1'</span>,</span><br><span class="line">        <span class="string">'Request2'</span>,</span><br><span class="line">        <span class="string">'Request3'</span>,</span><br><span class="line">        <span class="string">'Request4'</span>,</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里就是思维导图中默认返回的匿名回调函数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">defaultClosure</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'请求处理中...'</span> . <span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里就是整个请求处理管道的关键</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getSlice</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($stack, $pipe)</span></span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($stack, $pipe)</span></span><br><span class="line">            </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> $pipe::handle($stack);</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里是负责发起请求处理</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">then</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        call_user_func(array_reduce($this-&gt;pipes, $this-&gt;getSlice(), $this-&gt;defaultClosure()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们调用时：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$worker = <span class="keyword">new</span> Client();</span><br><span class="line">$worker-&gt;then();</span><br></pre></td></tr></table></figure></p>
<p>浏览器就会显示：<br><img src="/images/asset/2017/2017-05-02_162511.png" alt="显示结果"></p>
<p>那么我来解释一下整个流程吧，在代码注释说了<code>getSlice</code>是关键，那么我们来解读一下代码</p>
<h2 id="解析代码"><a href="#解析代码" class="headerlink" title="解析代码"></a>解析代码</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getSlice</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($stack, $pipe)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($stack, $pipe)</span></span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $pipe::handle($stack);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是返回一个匿名函数，匿名函数就会返回一个闭包函数，看清楚闭包函数，它会返回<code>$pipe::handle($stack)</code>，是不是很相识，没错，这里就是调用了请求处理类中的<code>handle</code>方法，那么<code>$stack</code>又是什么呢？这里我们就要看到<code>then</code>方法的<code>array_reduce($this-&gt;pipes, $this-&gt;getSlice(), $this-&gt;defaultClosure())</code>，<code>array_reduce</code>是PHP原生的操作数组的API，<a href="http://php.net/manual/zh/function.array-reduce.php" target="_blank" rel="external">文档在此</a>，通过文档中的例子你应该可以很清楚的了解，就是将第一个参数的数组的元素迭代的作为第二个参数的匿名函数的参数进行调用，然后匿名函数的返回结果又会与下一个元素进行迭代，如此类推，而第三个参数默认作为第一个元素进行迭代。</p>
<p>那么在这里，这里<code>$pipes</code>数组就是包含所有请求处理类，匿名函数就是<code>getSlice()</code>返回的匿名函数，第三个参数就是<code>defaultClosure()</code>返回的匿名函数。</p>
<p><code>array_reduce</code>第一次调用执行匿名函数时，<code>$stack</code>就是<code>defaultClosure()</code>返回的匿名函数，<code>$pipe</code>就是<code>$this-&gt;pipes</code>第一个元素<code>Request1</code>，所以是调用了<code>Request1</code>的<code>handle</code>方法。</p>
<p>所以此时<code>array_reduce</code>实际返回的是（我们假设用一个变量<code>$go1</code>存放</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$go1 = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Request1::handle(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'请求处理中...'</span> . <span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line">    &#125;)；</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>array_reduce</code>第二次调用执行匿名函数时，根据之前所说，<code>$go1</code>会与下一个元素迭代，意思就是<code>$go1</code>作为<code>$stack</code>，下一个元素作为<code>$pipe</code>调用匿名函数，那么此时<code>array_reduce</code>实际返回的是（我们假设用一个变量<code>$go2</code>存放<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$go2 = <span class="function"><span class="keyword">function</span> <span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Request2::handle($go1)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如此类推，最终<code>array_reduce</code>返回一个匿名函数，这就像上面思维导图最终所描述的一样</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Request4::handle(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Request3::handle(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Request2::handle(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">return</span> Reuqest1::handle(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span>&#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">'请求处理中...'</span> . <span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以当调用<code>call_user_func</code>时就是执行<code>array_reduce</code>返回的匿名函数，我们从各个请求处理类的<code>handle</code>方法也得知，会直接调用传入的匿名函数，注意顺序即可理解浏览器的输出。</p>
<h2 id="与装饰者模式的关系"><a href="#与装饰者模式的关系" class="headerlink" title="与装饰者模式的关系"></a>与装饰者模式的关系</h2><p>这里没有用到类来对实例对象进行包装，而是通过闭包函数完成，每一次处理在上一次处理之上进行包装，最后获得响应，就像流水线一样，一个请求进来通过一道道工序加工（包装）最后生成响应。</p>
<p><strong>后话：了解了请求处理管道的大致流程之后，那么之后当我们去读Laravel中请求处理时，大致的脉络也可以找到。</strong></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[一步步带你实现一个服务提供者]]></title>
      <url>https://blog.chenjunwu.cn/2017/05/01/Service-provider/</url>
      <content type="html"><![CDATA[<p>Laravel5.1 源码导读系列教程</p>
<a id="more"></a>
<h2 id="思维导图"><a href="#思维导图" class="headerlink" title="思维导图"></a>思维导图</h2><p><img src="/images/asset/2017/2017-05-01_1631.png" alt=""></p>
<h2 id="接口约定"><a href="#接口约定" class="headerlink" title="接口约定"></a>接口约定</h2><p>根据思维导图，我们需要对如下几个方法进行接口约定：</p>
<blockquote>
<p><code>bind</code>: 绑定接口和生成相应的实例回调函数<br><code>make</code>: 生成实例对象，但会首先解决接口和实例化之间的依赖关系<br><code>getConcrete</code>: 获取绑定的回调函数<br><code>build</code>: 实例化对象<br><code>getDependencies</code>: 解决实例化对象时的参数依赖</p>
</blockquote>
<p>搞清楚之后就可以开始写接口(Interface)，创建<code>ContainerInterface.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Interface ContainerInterface</span><br><span class="line"> * <span class="doctag">@package</span> Core\Contracts\Container</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ContainerInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 绑定接口和生成相应的实例回调函数</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> $abstract 需要绑定回调函数的标志</span><br><span class="line">     * <span class="doctag">@param</span> null $concrete 回调函数</span><br><span class="line">     * <span class="doctag">@param</span> bool $shared 是否是共享实例(单例的实现途径)</span><br><span class="line">     * <span class="doctag">@return</span> mixed</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bind</span><span class="params">($abstract, $concrete = null, $shared = false)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 生成实例对象，首先解决接口和要实例化对象之间的依赖关系</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> $abstract</span><br><span class="line">     * <span class="doctag">@return</span> mixed</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">($abstract)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 获取绑定的回调函数</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> $abstract</span><br><span class="line">     * <span class="doctag">@return</span> mixed</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getConcrete</span><span class="params">($abstract)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 实例化对象</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> $concrete</span><br><span class="line">     * <span class="doctag">@return</span> mixed</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">build</span><span class="params">($concrete)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 通过反射解决实例化对象时的参数依赖</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> $parameters 我们在调用之前可以通过反射机制获取构造函数的参数，形成参数数组在此进行处理</span><br><span class="line">     * <span class="doctag">@return</span> mixed</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDependencies</span><span class="params">($parameters)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实现接口"><a href="#实现接口" class="headerlink" title="实现接口"></a>实现接口</h2><p>有了接口自然我们需要实现接口方法，我们可以创建真正的实现类来实现接口，创建<code>Container.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Container</span> <span class="keyword">implements</span> <span class="title">ContainerInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">// 实现我们需要内部维护一个数组，</span></span><br><span class="line">    <span class="comment">// 专门存放绑定的服务</span></span><br><span class="line">    <span class="keyword">protected</span> $bindings = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绑定</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bind</span><span class="params">($abstract, $concrete = null, $shared = false)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">// 判断$concrete 是否是一个回调匿名函数</span></span><br><span class="line">        <span class="keyword">if</span> (! $concrete <span class="keyword">instanceof</span> Closure) &#123;</span><br><span class="line">            <span class="comment">// 如果不是匿名函数就通过另外的API获得一个默认的回调匿名函数</span></span><br><span class="line">            $concrete = getClosure($abstract, $concrete);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 绑定</span></span><br><span class="line">        $this-&gt;bindings[$abstract] = compact(<span class="string">'concrete'</span>, <span class="string">'shared'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取默认的回调函数</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getClosure</span><span class="params">($abstract, $concrete)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">// 这里回调函数的参数就是服务容器的实例</span></span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($container)</span> <span class="title">use</span> <span class="params">($abstract, $concrete)</span></span><br><span class="line">        </span>&#123;</span><br><span class="line">            $method = ($abstract == $concrete) ? <span class="string">'build'</span> : <span class="string">'make'</span>;</span><br><span class="line">            <span class="keyword">return</span> $container-&gt;$method($concrete);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">($abstract)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">// 在实例对象前，我们首先根据标识查找服务的回调函数</span></span><br><span class="line">        $concrete = getConcrete($abstract);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据查找的回调函数查看是否可以实例化</span></span><br><span class="line">        <span class="comment">// 如果不可以就会根据当前获得$concrete继续他通过make来查找，</span></span><br><span class="line">        <span class="comment">// 也就是之前所说，make会在实例化前解决接口和要实例化对象之间的依赖关系</span></span><br><span class="line">        <span class="keyword">if</span> ($this-&gt;isBuildable($abstract, $concrete)) &#123;</span><br><span class="line">            $object = $this-&gt;build($concrete);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $object = $this-&gt;make($concrete);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可以看出这里就是返回绑定时的回调匿名函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getConcrete</span><span class="params">($abstract)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">isset</span>($this-&gt;bindings[$abstract])) &#123;</span><br><span class="line">            <span class="keyword">return</span> $abstract;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $this-&gt;bindings[$abstract][<span class="string">'concrete'</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断是否可以实例化，其实就是$concrete必须是匿名函数或者与字符串标志吻合，</span></span><br><span class="line">    <span class="comment">// 但是标志需要有一定命名规则，要与绑定服务类名吻合，这可以从build方法中看出</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">isBuildable</span><span class="params">($abstract, $concrete)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ($abstract === $concrete || $concrete <span class="keyword">instanceof</span> Closure);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实例化</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">build</span><span class="params">($concrete)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($concrete <span class="keyword">instanceof</span> Closure) &#123;</span><br><span class="line">            <span class="comment">// 从这里我们就可以看出，当我们对服务绑定了回调匿名函数时，</span></span><br><span class="line">            <span class="comment">// 这里调用时就会向匿名函数传递当前服务容器的实例</span></span><br><span class="line">            <span class="keyword">return</span> $concrete($this);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 不是匿名函数时，通过反射来解决实例化问题</span></span><br><span class="line">        $reflector = <span class="keyword">new</span> ReflectionClass($concrete);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否可以实例化</span></span><br><span class="line">        <span class="keyword">if</span> (! $reflector-&gt;isInstantiable()) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> 无法实例化时需要自己异常处理，这里省略</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取构造函数</span></span><br><span class="line">        $constructor = $reflector-&gt;getConstructor();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_null($constructor)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> $concrete;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取构造函数的参数</span></span><br><span class="line">        $dependencies = $constructor-&gt;getParameters();</span><br><span class="line">        <span class="comment">// 把所有依赖参数都组成一个数组</span></span><br><span class="line">        $instances = $this-&gt;getDependencies($dependencies);</span><br><span class="line">        <span class="comment">// newInstanceArgs才可以向构造函数传递参数数组</span></span><br><span class="line">        <span class="keyword">return</span> $reflector-&gt;newInstanceArgs($instances);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理两类构造函数参数</span></span><br><span class="line">    <span class="comment">// 1. 非类对象参数</span></span><br><span class="line">    <span class="comment">// 2. 类对象参数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDependencies</span><span class="params">($parameters)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $dependencies = [];</span><br><span class="line">        <span class="keyword">foreach</span>($parameters <span class="keyword">as</span> $parameter) &#123;</span><br><span class="line">            $dependency = $parameter-&gt;getClass();</span><br><span class="line">            <span class="keyword">if</span> (is_null($dependency)) &#123;</span><br><span class="line">                $dependencies[] = resolveNonClass($parameter);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $dependencies[] = resolveClass($parameter);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">array</span>) $dependencies;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 继续通过容器来解决参数依赖</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveClass</span><span class="params">(ReflectionParameter $parameter)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> $this-&gt;make($parameter-&gt;getClass()-&gt;name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 捕捉build时类无法实例化的异常情况</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解决基本类型的参数依赖</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveNonClass</span><span class="params">(\ReflectionParameter $parameter)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($parameter-&gt;isDefaultValueAvailable()) &#123;</span><br><span class="line">            <span class="keyword">return</span> $parameter-&gt;getDefaultValue();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 在没有构造函数参数没有默认值造成实例化时参数缺失情况的异常处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此我们就简单实现了一个容器，然后我们需要简单测试一下是不是可行的。</p>
<h2 id="测试容器"><a href="#测试容器" class="headerlink" title="测试容器"></a>测试容器</h2><p>采用PHPUnit写一个单元测试进行测试，至于怎么使用自行Google即可</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Core</span>\<span class="title">Container</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">PHPUnit_Framework_TestCase</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContainerTest</span> <span class="keyword">extends</span> <span class="title">PHPUnit_Framework_TestCase</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testClosureResolution</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $container = <span class="keyword">new</span> Container();</span><br><span class="line">        $container-&gt;bind(<span class="string">'name'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'JimChen'</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        $this-&gt;assertEquals(<span class="string">'JimChen'</span>, $container-&gt;make(<span class="string">'name'</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testClosureResolutionClass</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $container = <span class="keyword">new</span> Container();</span><br><span class="line">        $testClass = <span class="keyword">new</span> TestClass();</span><br><span class="line"></span><br><span class="line">        $container-&gt;bind(<span class="string">'TestClass'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($testClass)</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $testClass;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        $this-&gt;assertEquals($testClass, $container-&gt;make(<span class="string">'TestClass'</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testGetDependencies</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $container = <span class="keyword">new</span> Container();</span><br><span class="line">        $reflector = <span class="keyword">new</span> \ReflectionClass(<span class="string">'\Core\Container\Test2'</span>);</span><br><span class="line">        $constructor = $reflector-&gt;getConstructor();</span><br><span class="line">        $parameters = $constructor-&gt;getParameters();</span><br><span class="line">        $dependencies = $container-&gt;getDependencies($parameters);</span><br><span class="line">        $parameter1 = $dependencies[<span class="number">0</span>];</span><br><span class="line">        $parameter2 = $dependencies[<span class="number">1</span>];</span><br><span class="line">        $this-&gt;assertEquals([], $parameter1);</span><br><span class="line">        $this-&gt;assertEquals(<span class="string">'TestClass'</span>, $parameter2-&gt;test());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testClosureResolutionName</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $container = <span class="keyword">new</span> Container();</span><br><span class="line"></span><br><span class="line">        $container-&gt;bind(<span class="string">'Test2'</span>, <span class="string">'\Core\Container\Test2'</span>);</span><br><span class="line"></span><br><span class="line">        $test = $container-&gt;make(<span class="string">'Test2'</span>);</span><br><span class="line"></span><br><span class="line">        $this-&gt;assertEquals(<span class="string">'Test2'</span>, $test-&gt;test());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestClass</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'TestClass'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(array $parameter1 = [], TestClass $parameter3)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Test2'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置好phpunit之后run一下，如果全pass会这样<br><img src="/images/asset/2017/2017-05-01_205404.png" alt="phpunit pass"></p>
<p><strong>后话：其实测试没有那么简单，为了保证测试的覆盖率，应该还要有更多的测试，比如每一个方法都必须通过单元测试，而这里为了演示效果省略了很多测试用例（还有作者意念其他测试肯定可以通过</strong></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[.env in Laravel5.1]]></title>
      <url>https://blog.chenjunwu.cn/2017/04/29/env-in-Laravel5-1/</url>
      <content type="html"><![CDATA[<p>今天我就谈谈Laravel中.env环境变量的实现，在此，我们不会具体讨论框架内核怎么调用具体的API从而实现.env加载到PHP中的$_ENV变量，我们只会关注这个过程怎么实现。</p>
<a id="more"></a>
<h2 id="找寻API调用的轨迹"><a href="#找寻API调用的轨迹" class="headerlink" title="找寻API调用的轨迹"></a>找寻API调用的轨迹</h2><p>从入口文件我们可以看到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">| Turn On The Lights</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">|</span><br><span class="line">| We need to illuminate PHP development, so let us turn on the lights.</span><br><span class="line">| This bootstraps the framework and gets it ready for use, then it</span><br><span class="line">| will load up this application so that we can run it and send</span><br><span class="line">| the responses back to the browser and delight our users.</span><br><span class="line">|</span><br><span class="line">*/</span></span><br><span class="line"></span><br><span class="line">$app = <span class="keyword">require_once</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/app.php'</span>;</span><br></pre></td></tr></table></figure>
<p>加载框架Application的引导启动，这是启动框架运行的首要第一步，我们进去<code>app.php</code>文件看看。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">| Create The Application</span><br><span class="line">|--------------------------------------------------------------------------</span><br><span class="line">|</span><br><span class="line">| The first thing we will do is create a new Laravel application instance</span><br><span class="line">| which serves as the "glue" for all the components of Laravel, and is</span><br><span class="line">| the IoC container for the system binding all of the various parts.</span><br><span class="line">|</span><br><span class="line">*/</span></span><br><span class="line"></span><br><span class="line">$app = <span class="keyword">new</span> Illuminate\Foundation\Application(</span><br><span class="line">    realpath(<span class="keyword">__DIR__</span>.<span class="string">'/../'</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>首先我们关注开始的实例化，创建一个Application的实例，我们深究可以得知Application继承于Container，也就是Application可以说是Laravel应用的一个容器类，这里相当于实例一个容器。</p>
<p>让我们恢复我们的关注点.env的实现，我们在进去查看以下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Register a callback to run after loading the environment.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  \Closure  $callback</span><br><span class="line"> * <span class="doctag">@return</span> void</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">afterLoadingEnvironment</span><span class="params">(Closure $callback)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $this-&gt;afterBootstrapping(</span><br><span class="line">        <span class="string">'Illuminate\Foundation\Bootstrap\DetectEnvironment'</span>, $callback</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是加载环境变量，我们点进去<code>DetectEnvironment</code>类可以看到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Bootstrap the given application.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  \Illuminate\Contracts\Foundation\Application  $app</span><br><span class="line"> * <span class="doctag">@return</span> void</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span><span class="params">(Application $app)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Dotenv::load($app-&gt;environmentPath(), $app-&gt;environmentFile());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvalidArgumentException $e) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $app-&gt;detectEnvironment(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> env(<span class="string">'APP_ENV'</span>, <span class="string">'production'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关注这里<code>Dotenv::load($app-&gt;environmentPath(), $app-&gt;environmentFile());</code>，就是加载.env文件的API，两个参数分别代表.env文件的根路径和文件名（具体可以回去看看<code>Application</code>），好，继续进去</p>
<h2 id="加载-env文件"><a href="#加载-env文件" class="headerlink" title="加载.env文件"></a>加载.env文件</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Load `.env` file in given directory.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> string $path</span><br><span class="line"> * <span class="doctag">@param</span> string $file</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> void</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span><span class="params">($path, $file = <span class="string">'.env'</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!is_string($file)) &#123;</span><br><span class="line">        $file = <span class="string">'.env'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $filePath = rtrim($path, <span class="string">'/'</span>).<span class="string">'/'</span>.$file;</span><br><span class="line">    <span class="keyword">if</span> (!is_readable($filePath) || !is_file($filePath)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read file into an array of lines with auto-detected line endings</span></span><br><span class="line">    $autodetect = ini_get(<span class="string">'auto_detect_line_endings'</span>);</span><br><span class="line">    ini_set(<span class="string">'auto_detect_line_endings'</span>, <span class="string">'1'</span>);</span><br><span class="line">    $lines = file($filePath, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);</span><br><span class="line">    ini_set(<span class="string">'auto_detect_line_endings'</span>, $autodetect);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($lines <span class="keyword">as</span> $line) &#123;</span><br><span class="line">        <span class="comment">// Disregard comments</span></span><br><span class="line">        <span class="keyword">if</span> (strpos(trim($line), <span class="string">'#'</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Only use non-empty lines that look like setters</span></span><br><span class="line">        <span class="keyword">if</span> (strpos($line, <span class="string">'='</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">static</span>::setEnvironmentVariable($line);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里我们关注到一开始是常规的判断文件名是否是合法的字符串以及文件是否存在（我们省略文件不存在的异常处理代码），然后就通过<code>file()</code>读取文件的内容，返回一个数组，文件内容的每一行就是这个数组的一个元素，然后把注释的过滤掉，剩下通过setEnvironmentVariable($line)加载</p>
<h2 id="处理-env文件内容"><a href="#处理-env文件内容" class="headerlink" title="处理.env文件内容"></a>处理.env文件内容</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Set a variable.</span><br><span class="line"> *</span><br><span class="line"> * Variable set using:</span><br><span class="line"> * - putenv</span><br><span class="line"> * - $_ENV</span><br><span class="line"> * - $_SERVER.</span><br><span class="line"> *</span><br><span class="line"> * The environment variable value is stripped of single and double quotes.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> string      $name</span><br><span class="line"> * <span class="doctag">@param</span> string|null $value</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> void</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">setEnvironmentVariable</span><span class="params">($name, $value = null)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">list</span>($name, $value) = <span class="keyword">static</span>::normaliseEnvironmentVariable($name, $value);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Don't overwrite existing environment variables if we're immutable</span></span><br><span class="line">    <span class="comment">// Ruby's dotenv does this with `ENV[key] ||= value`.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">static</span>::$immutable === <span class="keyword">true</span> &amp;&amp; !is_null(<span class="keyword">static</span>::findEnvironmentVariable($name))) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    putenv(<span class="string">"$name=$value"</span>);</span><br><span class="line">    $_ENV[$name] = $value;</span><br><span class="line">    $_SERVER[$name] = $value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从这里可以看到，会直接将.env文件的内容加载到$_ENV，\$_SERVER和环境变量中，我们往上看可以知道</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Don't overwrite existing environment variables if we're immutable</span></span><br><span class="line"><span class="comment">// Ruby's dotenv does this with `ENV[key] ||= value`.</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">static</span>::$immutable === <span class="keyword">true</span> &amp;&amp; !is_null(<span class="keyword">static</span>::findEnvironmentVariable($name))) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果本来就存在的环境变量一般不会进行替换，当然也可以通过<code>$immutable</code>设置替换，我们再往上看</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">list</span>($name, $value) = <span class="keyword">static</span>::normaliseEnvironmentVariable($name, $value);</span><br></pre></td></tr></table></figure>
<p>如果还记得，这里通过处理我们通过<code>load($path, $file = &#39;.env&#39;)</code>调用只传入每一行<code>key-value</code>对应的字符串，所以<code>normaliseEnvironmentVariable($name, $value)</code>就进行处理，<code>$value</code>可以看作是一种默认值（这里是null），我们继续看看<code>normaliseEnvironmentVariable($name, $value)</code>的实现</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Takes value as passed in by developer.</span><br><span class="line"> *</span><br><span class="line"> * We're also:</span><br><span class="line"> * - ensuring we're dealing with a separate name and value, breaking apart the name string if needed</span><br><span class="line"> * - cleaning the value of quotes</span><br><span class="line"> * - cleaning the name of quotes</span><br><span class="line"> * - resolving nested variables</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> string $name</span><br><span class="line"> * <span class="doctag">@param</span> string $value</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> array</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">normaliseEnvironmentVariable</span><span class="params">($name, $value)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">list</span>($name, $value) = <span class="keyword">static</span>::splitCompoundStringIntoParts($name, $value);</span><br><span class="line">    $name = <span class="keyword">static</span>::sanitiseVariableName($name);</span><br><span class="line">    $value = <span class="keyword">static</span>::sanitiseVariableValue($value);</span><br><span class="line">    $value = <span class="keyword">static</span>::resolveNestedVariables($value);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">array</span>($name, $value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们看到返回<code>array($name, $value)</code>，往上看</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$name = <span class="keyword">static</span>::sanitiseVariableName($name);</span><br><span class="line">$value = <span class="keyword">static</span>::sanitiseVariableValue($value);</span><br><span class="line">$value = <span class="keyword">static</span>::resolveNestedVariables($value);</span><br></pre></td></tr></table></figure>
<p>这里只是对<code>$name</code>和<code>$value</code>进行过滤，我们着重关注如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">list</span>($name, $value) = <span class="keyword">static</span>::splitCompoundStringIntoParts($name, $value);</span><br></pre></td></tr></table></figure>
<p>再进去<code>splitCompoundStringIntoParts($name, $value)</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * If the $name contains an = sign, then we split it into 2 parts, a name &amp; value.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> string $name</span><br><span class="line"> * <span class="doctag">@param</span> string $value</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@return</span> array</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">splitCompoundStringIntoParts</span><span class="params">($name, $value)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (strpos($name, <span class="string">'='</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="keyword">list</span>($name, $value) = array_map(<span class="string">'trim'</span>, explode(<span class="string">'='</span>, $name, <span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">array</span>($name, $value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就可以看到直接对<code>$name</code>处理，把<code>$name</code>以<code>=</code>进行字符分割然后分别得到<code>$name</code>和<code>$value</code>，通过<code>array($name, $value)</code>返回便于通过<code>list($name, $value)</code>处理。</p>
<h2 id="使用-env文件定义的量"><a href="#使用-env文件定义的量" class="headerlink" title="使用.env文件定义的量"></a>使用.env文件定义的量</h2><p>至此我们搞清楚了.env文件加载流程，那怎么使用呢？这个也很简单，注意<code>putenv(&quot;$name=$value&quot;)</code>，我们已经加载到了PHP的环境变量中，然后可以通过<code>getenv($name)</code>来获取对应的值，以下是Laravel提供帮助函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Gets the value of an environment variable. Supports boolean, empty and null.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span>  string  $key</span><br><span class="line"> * <span class="doctag">@param</span>  mixed   $default</span><br><span class="line"> * <span class="doctag">@return</span> mixed</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">env</span><span class="params">($key, $default = null)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">// 通过getenv获取对应的量</span></span><br><span class="line">    $value = getenv($key);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果量不存在，就返回默认值(这里通过value()处理允许默认值是一个回调函数)</span></span><br><span class="line">    <span class="keyword">if</span> ($value === <span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> value($default);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 对$value的特殊值处理</span></span><br><span class="line">    <span class="keyword">switch</span> (strtolower($value)) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'true'</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'(true)'</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'false'</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'(false)'</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'empty'</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'(empty)'</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'null'</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'(null)'</span>:</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 过滤字符串两边包含的引号</span></span><br><span class="line">    <span class="keyword">if</span> (strlen($value) &gt; <span class="number">1</span> &amp;&amp; Str::startsWith($value, <span class="string">'"'</span>) &amp;&amp; Str::endsWith($value, <span class="string">'"'</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> substr($value, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过以上注释可以清楚知道怎么调用了，那么使用.env有什么好处呢？最直观好处就是分离线上线下环境配置，把线上线下可变环境都通过.env处理将大大简单化线上线下环境配置，典型的如生产环境使用的数据库配置和线下测试时的使用的数据库配置大多数情况会不一样。而且通过git的.gitignore功能可以区别线上线下.env配置文件，大大简化部署时因为配置改动带来不可预知的问题，一次配置之后，项目再部署就不需要再改动配置。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[php-Q&A-2]]></title>
      <url>https://blog.chenjunwu.cn/2017/04/08/php-Q-A-2/</url>
      <content type="html"><![CDATA[<p>此篇博客将讨论PHP中static和self的区别，<a href="http://php.net/manual/zh/language.oop5.late-static-bindings.php" target="_blank" rel="external">PHP文档</a>有很详细的说明，这里简单描述一下。</p>
<a id="more"></a>
<h2 id="self-and-static"><a href="#self-and-static" class="headerlink" title="self and static"></a>self and static</h2><p>self一般用于静态变量或静态方法引用，static也是，那么它们区别在哪里，我们用一个例子展示一下<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">who</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">// 魔术变量 返回当前类的名称</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__CLASS__</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;br/&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">showSelf</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">self</span>::who();</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">showStatic</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">static</span>::who();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">extends</span> <span class="title">D</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">who</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__CLASS__</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;br/&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">C::showSelf();</span><br><span class="line">C::showStatic();</span><br></pre></td></tr></table></figure></p>
<p>以上输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">D</span><br><span class="line">C</span><br></pre></td></tr></table></figure></p>
<p>为什么有这样的效果呢？这就有关于static后期静态绑定的原因，具体可查看<a href="http://php.net/manual/zh/language.oop5.late-static-bindings.php" target="_blank" rel="external">PHP文档</a>，我就说一下我的理解吧。</p>
<h2 id="我的理解"><a href="#我的理解" class="headerlink" title="我的理解"></a>我的理解</h2><blockquote>
<p>self可以看作PHP的编译器会解析为绑定当前类，就是说self在哪个类出现，那么它就是指向那个类，比如上面self出现在D类中，那么就是指向D类，通过self::who()就是调用D类的who方法，故<code>__CLASS__</code>的值为D。</p>
<p>static的绑定就比较灵活了，它可以指向继承链上所有的类，而最终的指向是看哪一个类作为静态调用，比如上面的，我们是通过C类调用，那么static是指向C类，自然static::who()就是调用C类的who()方法，不过这里我们需要注意，我们是在C类重写了who方法，所以C::who()时，才不是调用父类的who方法，所以<code>__CLASS__</code>的值才为C，如果没有重写，则会调用父类的who方法，那样显示的就是D，因为<code>__CLASS__</code>并不是一个运行时常量，而是一个根据上下文确定的常量。</p>
</blockquote>
<h2 id="new-self-and-new-static"><a href="#new-self-and-new-static" class="headerlink" title="new self and new static"></a>new self and new static</h2><p>又看一个例子<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getSelf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">self</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getStatic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">static</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">extends</span> <span class="title">D</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// get_class 获得对象的类名</span></span><br><span class="line"><span class="keyword">echo</span> get_class(C::getSelf()) . <span class="string">'&lt;br/&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> get_class(C::getStatic()) . <span class="string">'&lt;br/&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> get_class(D::getStatic()) . <span class="string">'&lt;br/&gt;'</span>;</span><br></pre></td></tr></table></figure></p>
<p>以上输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">D</span><br><span class="line">C</span><br><span class="line">D</span><br></pre></td></tr></table></figure></p>
<h2 id="对于输出的解释"><a href="#对于输出的解释" class="headerlink" title="对于输出的解释"></a>对于输出的解释</h2><blockquote>
<p>于是我们知道new self和new static就是返回一个对象，与平常通过类名常见对象一样，区别在于self和static，与上面类似，就是查看self和static指向哪一个类而已，我们就知道通过关键字new创建哪一个类的对象。</p>
</blockquote>
<hr>
<p>更新：static不仅可以用于静态方法，也可以用于非静态方法<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">who</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">// 魔术变量 返回当前类的名称</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__CLASS__</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;br/&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showStatic</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">static</span>::who();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">extends</span> <span class="title">D</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">who</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__CLASS__</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;br/&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$c = <span class="keyword">new</span> C();</span><br><span class="line">$c-&gt;showStatic();</span><br></pre></td></tr></table></figure></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Homestead添加多站点的坑]]></title>
      <url>https://blog.chenjunwu.cn/2017/04/03/homestead/</url>
      <content type="html"><![CDATA[<p>当配置Homestead多站点时，发现直接在Homestead.yaml配置是不可以的。当执行了<code>homestead provision</code>后面的站点会覆盖前面的站点，导致配置的多站点无法生效，这是一个坑呀。</p>
<a id="more"></a>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><ol>
<li><p>如果我们开启homestead之后，使用ssh登录，就会找到多站点配置的地方<code>/etc/nginx/sites-enable/</code>。</p>
</li>
<li><p>之后我们通过命令<code>ls /vagrant/scripts</code>发现有一个脚本<code>serve-laravel.sh</code>。</p>
</li>
<li><p>所以我们通过命令<code>sudo /vagrant/scripts/serve-laravel.sh application.app /home/vagrant/Code/application/public</code>，这样<code>/etc/nginx/sites-enable/</code>就会多出<code>application.app</code>文件夹，此时由于homestead的fpm模块配置错误，我们还需要进入<code>application.app</code>修改nginx的fpm配置，这样重启homestead之后，就可以通过<code>http://application.app</code>访问你的应用了。</p>
</li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[简单工厂，工厂和抽象工厂的区别]]></title>
      <url>https://blog.chenjunwu.cn/2017/03/26/factory-pattern/</url>
      <content type="html"><![CDATA[<p>最近在看设计模式相关的书籍，然后看到工厂模式就搞混了头了，久久不能理解简单工厂，工厂模式和抽象工厂模式的区别，后来<a href="https://my.oschina.net/hanzhankang/blog/195150" target="_blank" rel="external">这里</a>的两三句话点醒了我。</p>
<a id="more"></a>
<h2 id="三者简介"><a href="#三者简介" class="headerlink" title="三者简介"></a>三者简介</h2><h3 id="简单工厂"><a href="#简单工厂" class="headerlink" title="简单工厂"></a>简单工厂</h3><p><img src="/images/asset/2017/2017-03-26_204709.png" alt=""></p>
<p>向工厂请求产品，通过传入的参数来获得不同的产品，伪代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 一般使用静态方法 假设0代表获得戴尔品牌鼠标，1代表获得Hp品牌鼠标</span><br><span class="line"></span><br><span class="line">MouseFactory::createMouse(0); // 戴尔品牌鼠标</span><br><span class="line">MouseFactory::createMouse(1); // Hp品牌鼠标</span><br></pre></td></tr></table></figure>
<h3 id="工厂"><a href="#工厂" class="headerlink" title="工厂"></a>工厂</h3><p><img src="/images/asset/2017/2017-03-26_205308.png" alt=""></p>
<p>向对应的具体产品的工厂实例请求接口，以求获得相应的产品，伪代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MouseFactory DellMouseFactory = new DellMouseFactory();</span><br><span class="line">MouseFactory HpMouseFactory = new HpMouseFactory();</span><br><span class="line"></span><br><span class="line">DellMouseFactory.createMouse();  // 戴尔品牌鼠标</span><br><span class="line">HpMouseFactory.createMouse();  // Hp品牌鼠标</span><br></pre></td></tr></table></figure>
<h3 id="抽象工厂"><a href="#抽象工厂" class="headerlink" title="抽象工厂"></a>抽象工厂</h3><p><img src="/images/asset/2017/2017-03-26_213046.png" alt=""></p>
<p>每个工厂都需要生产一类产品，当需要某类产品时实例化具体的工厂通过产品接口获得，<span id="abstract-factory">伪代码：</span></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PcFactory DellFactory = new DellFactory();</span><br><span class="line">PcFactory HpFactory = new HpFactory();</span><br><span class="line"></span><br><span class="line">DellFactory.createMouse(); // 戴尔品牌鼠标</span><br><span class="line">DellFactory.createKeybo(); // 戴尔品牌键盘</span><br><span class="line"></span><br><span class="line">HpFactory.createMouse(); // Hp品牌鼠标</span><br><span class="line">HpFactory.createKeybo(); // Hp品牌键盘</span><br></pre></td></tr></table></figure>
<h2 id="三者区别"><a href="#三者区别" class="headerlink" title="三者区别"></a>三者区别</h2><p><strong>简单工厂</strong>好理解，就是通过参数不同获取对应的实例，这是很容易想到的，但也是最难扩展的，扩展会涉及修改工厂，破坏开放封闭原则。一般只适合用于结构简单，变更少的工厂模式。</p>
<p><strong>工厂与抽象工厂</strong>比较难看出区别，在我看来，工厂模式关注点在于为每一个产品提供一个工厂，于是乎工厂模式下对于扩展产品类型时只要我们另外提供一个工厂类就可以了，比如上面例子，假设我们需要增加键盘时，我们应该新提供一个工厂类专门生产键盘：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class DellKeyboFactory extends KeyboFactory </span><br><span class="line">&#123;</span><br><span class="line">    public function createKeybo()</span><br><span class="line">    &#123;</span><br><span class="line">        // ...</span><br><span class="line">        return new DellKeybo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们需要戴尔的键盘时如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">KeyboFactory DellKeyboFactory = new DellKeyboFactory();</span><br><span class="line"></span><br><span class="line">DellKeyboFactory.createKeybo(); // 戴尔品牌键盘</span><br></pre></td></tr></table></figure>
<p>所以对于工厂模式下，在同一等级结构中，支持增加任意产品，且不会破坏开放封闭原则，表明工厂模式关注点在于添加任意产品，但是对于纵向扩展工厂产品线时，在不破坏开放封闭原则下却无能为力。这就是与抽象工厂的区别所在。</p>
<p><strong>抽象工厂模式</strong>就是为了纵向扩展产品线对工厂模式进行改造，表明抽象工厂模式关注点在于扩展生产线，也就是关注添加任意的产品族，关注同一产品族下产品之间内在的关系，如上<a href="#abstract-factory">伪代码</a>，当我需要扩展其他工厂产品线时比如华为公司的鼠标和键盘，那样只需要扩展一个属于华为的工厂进行生产就可以了，伪代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class HuaWeiFactory extends PcFactory</span><br><span class="line">&#123;</span><br><span class="line">    public function createMouse()</span><br><span class="line">    &#123;</span><br><span class="line">        // ...</span><br><span class="line">        return new HuaWeiMouse();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function createKeybo()</span><br><span class="line">    &#123;</span><br><span class="line">        // ...</span><br><span class="line">        return new HuaWeiKeybo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用时也如上<a href="#abstract-factory">伪代码</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PcFactory HuaWeiFactory = new HuaWeiFactory();</span><br><span class="line"></span><br><span class="line">HuaWeiFactory.createMouse(); // 华为品牌鼠标</span><br><span class="line">HuaWeiFactory.createKeybo(); // 华为品牌键盘</span><br></pre></td></tr></table></figure>
<p>但是抽象工厂模式下缺点也很明显，无法进行产品类的扩展（不破坏开放封闭原则），可以粗滤地说工厂模式与抽象工厂模式是两种优劣势相反的模式，具体使用还需看业务扩展情况而定。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><strong>简单工厂：</strong>同一结构下可以生产任意产品，不限产品类别，但是不能增加产品。<br><strong>工厂：</strong>同一结构下可以增加生产任意产品，但不能添加产品线。<br><strong>抽象工厂：</strong>可以用来生产不同类型的产品族（添加产品线），但不能增加产品族。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[php-Q&A-1]]></title>
      <url>https://blog.chenjunwu.cn/2017/03/17/php-Q-A-1/</url>
      <content type="html"><![CDATA[<p>mdzz…由于我的centos服务器上需要使用composer部署laravel项目，而使用composer需要开启ssl，这时php需要开启扩展openssl，我的php版本是5.6.22，手动编译的，此时只要进入安装包相应的extension进行编译安装即可，然而神奇的事情发生了。</p>
<a id="more"></a>
<h2 id="问题所在"><a href="#问题所在" class="headerlink" title="问题所在"></a>问题所在</h2><h3 id="安装过程"><a href="#安装过程" class="headerlink" title="安装过程"></a>安装过程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ cd ~/php5/ext/openssl</span><br><span class="line"></span><br><span class="line">$ mv config0.m4 config.m4</span><br><span class="line"></span><br><span class="line">$ phpize</span><br><span class="line"></span><br><span class="line">$ ./configure</span><br><span class="line"></span><br><span class="line">$ make &amp;&amp; make test</span><br><span class="line"></span><br><span class="line">$ make install</span><br></pre></td></tr></table></figure>
<p>这样会提示安装完毕</p>
<p>openssl.so文件也自动添加到对应的extension目录中，但是重启服务器后查看phpinfo却没有开启openssl，我以为没有把路径添加到php.ini中，于是打开对应的php.ini加入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extension=/usr/..../openssl.so</span><br></pre></td></tr></table></figure>
<p>重启服务器然后查看phpinfo，还是没有！纳闷了！然后Google了好久，试了好多方法还是不行！</p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>偶然地一次在shell命令上打<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ php -v</span><br></pre></td></tr></table></figure></p>
<p>发现如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PHP Warning:  PHP Startup: openssl: Unable to initialize module</span><br><span class="line">Module compiled with module API=.....</span><br><span class="line">PHP    compiled with module API=.....</span><br></pre></td></tr></table></figure></p>
<p>貌似是module里的API版本与PHP的API版本不一致，神奇呀！！我都没有重新下过其他版本的PHP，于是我只好去官网重新下载对应的版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://cn2.php.net/distributions/php-5.6.22.tar.gz</span><br><span class="line"></span><br><span class="line">$ tar zxvf php-5.6.22.tar.gz</span><br></pre></td></tr></table></figure>
<p>之后像上面那样重新安装openssl，并没有重新编译安装PHP，然后执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ php -v</span><br></pre></td></tr></table></figure>
<p>没有警告了！！！于是我把服务器重启一下，查看一下phpinfo，成功了！！！<br><img src="/images/asset/2017/2017-03-17_110222.png" alt=""></p>
<p>具体原因为什么会使我之前的PHP包里的module API与PHP版本的API不一致尚未清楚，所以当我们需要手动安装PHP时，扩展与PHP版本必须一致可以降低各种疑难杂症地发生。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Android学习记录]]></title>
      <url>https://blog.chenjunwu.cn/2017/03/11/android-learning/</url>
      <content type="html"><![CDATA[<p>最近看着郭婶的《第一行代码 第二版》的书开始学习Android，从头到尾一步一步来敲代码，理解概念，感觉特别适合我这种Android开发小白，理论与实践都有，偏重实践，推荐大家支持郭神的新书，我是在京东买的，特便宜，链接如下：<a href="https://item.jd.com/11054290852.html" target="_blank" rel="external">https://item.jd.com/11054290852.html</a></p>
<a id="more"></a>
<h2 id="gradle文件详解"><a href="#gradle文件详解" class="headerlink" title="gradle文件详解"></a>gradle文件详解</h2><p>一个Android Studio的项目工程一般有两个gradle文件，最外层gradle文件如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath &apos;com.android.tools.build:gradle:2.2.0&apos;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>buildscript</code>的<code>repositories</code>闭包里的<code>jcenter()</code>是引用Android的代码库，Android许多开源库都托管在这里，可以便于使用开源库。<br><code>dependencies</code>闭包是指依赖，依赖一个gradle插件，Android Studio是使用gradle来构建Android项目的。<br><code>allprojects</code>的<code>repositories</code>闭包里的<code>jcenter()</code>同理</p>
<p>app目录下的gradle文件如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: &apos;com.android.application&apos;</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion 25</span><br><span class="line">    buildToolsVersion &quot;25.0.2&quot;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId &quot;com.coolweather.android&quot;</span><br><span class="line">        minSdkVersion 15</span><br><span class="line">        targetSdkVersion 25</span><br><span class="line">        versionCode 1</span><br><span class="line">        versionName &quot;1.0&quot;</span><br><span class="line">        testInstrumentationRunner &quot;android.support.test.runner.AndroidJUnitRunner&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled false</span><br><span class="line">            proguardFiles getDefaultProguardFile(&apos;proguard-android.txt&apos;), &apos;proguard-rules.pro&apos;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile fileTree(dir: &apos;libs&apos;, include: [&apos;*.jar&apos;])</span><br><span class="line">    androidTestCompile(&apos;com.android.support.test.espresso:espresso-core:2.2.2&apos;, &#123;</span><br><span class="line">        exclude group: &apos;com.android.support&apos;, module: &apos;support-annotations&apos;</span><br><span class="line">    &#125;)</span><br><span class="line">    testCompile &apos;junit:junit:4.12&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>apply plugin</code>表示应用插件，两种选择，application表示应用模块，library表示库模块。两者最大区别在于，一个可以直接运行，一个只能作为代码库依附于别的应用程序模块来运行。</p>
<p><code>android</code>闭包：1. compileSdkVersion配置编译版本，25表示使用Android7.1.1版本编译，具体查看可以使用Android Studio的SDK Manager查看。</p>
<ol>
<li>buildToolsVersion用于指定项目构建工具版本</li>
<li><code>defaultConfig</code>闭包的applicationId指项目包名，minSdkVersion指项目最低兼容的<code>Android</code>系统版本，这里指定成15表示最低兼容到Android 4.0系统。targetSdkVersion指定的值表示你在该目标版本上已经做过充分测试，系统就会为应用启用一些最新的功能和特性。比如说，Android 6.0系统中引入了运用时权限这个功能，如果你将targetSdkVersion指定成23或者更高，那么系统就会为你的程序启用这个功能，但是如果指定22，说明你的应用只在Android 5.1系统上做过充分测试，那么系统以上版本的新功能就不会启用。versionCode和versionName用于指定项目的版本名，这两个属性在生成安装文件的时候非常重要。</li>
<li><code>buildTypes</code>闭包中用于指定两个子闭包，一个是debug，一个是release。debug闭包用于指定生成测试版安装文件的配置，release闭包用于指定生成正式版安装文件配置，里面的minifyEnabled用于指定是否对项目代码进行混淆，true为是，false为否，proguardFiles是指定混淆代码的规则，默认规则在Android SDK目录下，第二个文件可以用来自定义应用的混淆规则，文件在当前根目录下local.properties。</li>
<li><code>dependencies</code>闭包分为本地依赖，远程依赖，库依赖。文件第一行的compile fileTree(dir: ‘libs’, include: [‘*.jar’])就是本地依赖，依赖本项目的libs目录下所有.jar后缀的文件，都会添加到项目构建当中来。后面的依赖就是远程依赖，AS版本不同导致gradle版本不同或许写法上有些许差别。库依赖是compile project后面加上要依赖的库名称，比如说有一个库模块叫helper，那么依赖就写为compile project(‘:helper’)。</li>
</ol>
<h2 id="用到的开源库记录"><a href="#用到的开源库记录" class="headerlink" title="用到的开源库记录"></a>用到的开源库记录</h2><h3 id="Litepal"><a href="#Litepal" class="headerlink" title="Litepal"></a>Litepal</h3><ol>
<li><p>介绍<br>Android操作sqlite数据库的orm框架，github地址：<a href="https://github.com/LitePalFramework/LitePal" target="_blank" rel="external">https://github.com/LitePalFramework/LitePal</a></p>
</li>
<li><p>简单用法<br>首先必须在AndroidManifest.xml文件中为application标签添加属性android:name=”org.litepal.LitePalApplication”，这样的目的是为了让litepal内部拿到context，当然如果你有自己的application配置，为了让litepal可以正常工作我们可以在自己的application的onCreate方法中初始化，LitePal.initialize(context)，这里context=getApplicationContext()</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span></span><br><span class="line">    <span class="attr">android:name</span>=<span class="string">"org.litepal.LitePalApplication"</span></span><br><span class="line">    <span class="attr">android:allowBackup</span>=<span class="string">"true"</span></span><br><span class="line">    <span class="attr">android:icon</span>=<span class="string">"@mipmap/logo"</span></span><br><span class="line">    <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span></span><br><span class="line">    <span class="attr">android:roundIcon</span>=<span class="string">"@mipmap/ic_launcher_round"</span></span><br><span class="line">    <span class="attr">android:supportsRtl</span>=<span class="string">"true"</span></span><br><span class="line">    <span class="attr">android:theme</span>=<span class="string">"@style/AppTheme"</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>之后使用实体类继承Litepal框架里的DataSupport类，接着需要实体类映射到指定的表中<br>在main目录下建文件夹assets目录，在此目录下建文件litepal.xml，</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">litepal</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbname</span> <span class="attr">value</span>=<span class="string">"cool_weather"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapping</span> <span class="attr">class</span>=<span class="string">"com.coolweather.android.db.Province"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapping</span> <span class="attr">class</span>=<span class="string">"com.coolweather.android.db.City"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapping</span> <span class="attr">class</span>=<span class="string">"com.coolweather.android.db.County"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">litepal</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>dbname指数据库名，version指版本号，变更版本号可以升级数据库，比如当你希望在表中添加一列，此时在实体类中添加一属性之后，只要升级版本号，当进行一次数据库操作时litepal就会自动更新表，而且表中的数据并不会被删掉</p>
<h3 id="Okhttp"><a href="#Okhttp" class="headerlink" title="Okhttp"></a>Okhttp</h3><ol>
<li><p>介绍<br>okhttp是由square公司开发的java网络请求库。github地址：<a href="https://github.com/square/okhttp" target="_blank" rel="external">https://github.com/square/okhttp</a></p>
</li>
<li><p>简单用法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">                .url(url)</span><br><span class="line">                .build();</span><br><span class="line">        Response response = client.newCall(request).execute();</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="Gson"><a href="#Gson" class="headerlink" title="Gson"></a>Gson</h3><ol>
<li><p>介绍<br>gson是由google公司提供的java语言对json数据解析的开源库，github地址：<a href="https://github.com/google/gson" target="_blank" rel="external">https://github.com/google/gson</a></p>
</li>
<li><p>简单用法</p>
</li>
</ol>
<p>将json字符串映射到实体类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析json</span></span><br><span class="line"><span class="keyword">new</span> Gson().fromJson(jsonString, Entity.class);   <span class="comment">//返回值为Entity的一个实例对象</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成json</span></span><br><span class="line"><span class="keyword">new</span> Gson().toJson(<span class="keyword">new</span> Entity(...));     <span class="comment">// 返回以Entity为实体类的json字符串</span></span><br></pre></td></tr></table></figure></p>
<p>具体使用可以查看<a href="http://www.jianshu.com/p/e740196225a4" target="_blank" rel="external">这里</a></p>
<h3 id="Butterknife"><a href="#Butterknife" class="headerlink" title="Butterknife"></a>Butterknife</h3><ol>
<li><p>介绍<br>由square公司JakeWharton员工开发，配合AS插件Android BufferKnife Zelezny使用<br>，可以让layout的view通过butterknife自动注入，再也不用写一大堆findViewById。</p>
</li>
<li><p>简单使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BindView</span>(R.id.send_request)</span><br><span class="line">    Button sendRequest;</span><br><span class="line">    <span class="meta">@BindView</span>(R.id.response_text)</span><br><span class="line">    TextView responseText;</span><br><span class="line">    <span class="meta">@BindView</span>(R.id.get_url)</span><br><span class="line">    EditText getUrl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        ButterKnife.bind(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClick</span>(R.id.send_request)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSendRequest</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="Glide"><a href="#Glide" class="headerlink" title="Glide"></a>Glide</h3><ol>
<li><p>介绍<br>这是一个图片加载库，为什么需要它呢，因为在Android端展示图片，如果图片像素太高会操作应用内存溢出，而这个库能够对图片进行处理再加载，有效防止因加载图片而发生的内存溢出问题，当然这个还有很多神奇好玩的特性有待尝试，github地址：<a href="https://github.com/bumptech/glide" target="_blank" rel="external">https://github.com/bumptech/glide</a></p>
</li>
<li><p>简单使用</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Glide.with(Context).load(URL).into(ImageView);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一句代码就搞定，是不是很简单，</span></span><br><span class="line"><span class="comment">// with()方法传入一个Context，Activity或者Fragment参数，</span></span><br><span class="line"><span class="comment">// 然后调用load()方法去加载图片，这里可以传入一个URL地址，本地图片路径或者一个资源id，</span></span><br><span class="line"><span class="comment">// 最后调用into()方法将图片设置到具体到某一个ImageView中就可以了。</span></span><br></pre></td></tr></table></figure>
<p>未完，待续。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[phpstorm-psr2]]></title>
      <url>https://blog.chenjunwu.cn/2017/01/13/phpstorm-psr2/</url>
      <content type="html"><![CDATA[<p>是时候规范自己的代码了！！！</p>
<h2 id="Just-Standard！！"><a href="#Just-Standard！！" class="headerlink" title="Just Standard！！"></a>Just Standard！！</h2><a id="more"></a>
<h3 id="一、安装phpcs与phpstorm配置"><a href="#一、安装phpcs与phpstorm配置" class="headerlink" title="一、安装phpcs与phpstorm配置"></a><a href="http://www.jianshu.com/p/4cf8a1548b95" target="_blank" rel="external">一、安装phpcs与phpstorm配置</a></h3><h3 id="二、phpstorm-配置-php-cs-fixer"><a href="#二、phpstorm-配置-php-cs-fixer" class="headerlink" title="二、phpstorm 配置 php-cs-fixer"></a>二、phpstorm 配置 php-cs-fixer</h3><p><code>composer</code>全局安装：<code>composer global require fabpot/php-cs-fixer</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php-cs-fixer --version</span><br><span class="line"></span><br><span class="line">PHP CS Fixer version 2.0.0 by Fabien Potencier and Dariusz Ruminski</span><br></pre></td></tr></table></figure>
<p>点击<code>File----&gt;Settings----&gt;External Tools</code></p>
<p><img src="/images/asset/2017/2017-01-13_203118.png" alt="展示1"></p>
<p>点击以下箭头：<br><img src="/images/asset/2017/2017-01-13_203441.png" alt="展示2"><br><img src="/images/asset/2017/2017-01-13_203607.png" alt="展示3"></p>
<p>名字和介绍可以随便填，<code>Program</code>一列就填上你全局安装<code>php-cs-fixer</code>的路径</p>
<p><code>Parameters</code>一行填上你的参数，配置参数可以在<a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer" target="_blank" rel="external">github</a>上找，最后<code>fix</code>跟上<code>$FileDir</code>和<code>$FileName</code>表示当前的目录名和文件名，<code>Working directory</code>填上<code>$ProjectFileDir$</code>表示当前工作目录，配置完点击<code>OK</code></p>
<p>设置快捷键<code>File----&gt;Settings----&gt;Keymap</code><br><img src="/images/asset/2017/2017-01-13_212238.png" alt="设置快捷键"></p>
<p>测试：<br><img src="/images/asset/2017/QQ截图20170113211850.png" alt="测试1"></p>
<p>我设置了快捷键<code>Ctrl+1</code>可以直接格式化成符合<a href="https://psr.phphub.org/" target="_blank" rel="external">规范的代码风格</a></p>
<p><img src="/images/asset/2017/2017-01-13_212040.png" alt="测试2"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[2016年总结]]></title>
      <url>https://blog.chenjunwu.cn/2016/12/30/summarize2016/</url>
      <content type="html"><![CDATA[<p>今天是2016年12月30日，离2017年还剩下2天时间，时间飞逝呀！！想当年刚刚进入大学一年级的情况还历历在目，如今已经大三了…</p>
<h2 id="物是人非事事休，欲语泪先流！"><a href="#物是人非事事休，欲语泪先流！" class="headerlink" title="物是人非事事休，欲语泪先流！"></a>物是人非事事休，欲语泪先流！</h2><a id="more"></a>
<p>一年快过去了，算起来我也加入袂卓快2年了，在这里结识了很多的小伙伴，在袂卓奋斗了两年了，从刚进大学的懵懂小子，到现在学有所成，其实更加的感激这里的所有人，让我逐渐的变强。</p>
<p>一年前，自己定下了许许多多的目标，例如找实习，买iphone，买mac等等，但其实，也只有一个目标是完成了的…在今年10月份成功收入了一台iphone se…算是成功完成一个心愿吧，然而这并不够的，其实我最想实现的目的是参加一个开源项目成为开发者，能够非常光荣的写进简历中，这才是最想的…然而实力不足，还真没有太大能力参与开源项目的开发，只能默默地想，默默地学习。</p>
<p>这一年，我花了很多时间在前端学习上，其实算是把前端的几个很火的框架搞了一遍，一开始在暑假的时候捣鼓了<code>AngularJS</code>，然后直接捣鼓到学期开始，然后接到保卫处的官网需要开干，然后与祥子商量直接上手<code>AngularJS</code>吧，搞了大概三个星期。后台基本噼里啪啦的curd接口就出来了，然后整合祥子写好的页面，配合Angular做成了单页面，客户满意是满意，但老是无端端地加需求，是老师没办法，做就做好憋，前后折腾了四个星期可以交付了，然后我们需要帮他部署，我都准备好了，他居然说不要了！不要了！理由是学校不允许他们私自找人重构网站，如需要上报学校！我x他了，我们都做好了，居然不要！做好之前还xx的多要求要我们改，那时真的很火气，之后就直接不干了。</p>
<p>接下来呢，软设，软设，要开始准备了，但其实心里不是很想参加，但其实又不是，反正就是一种矛盾的心情参加了，之后反正就在复赛的时候就失败终结了，然后看起来像是没有事一样，但其实内心还是很伤心的。输了还输了，其实自己也学到东西吧，那个物流帮其实是自己用<code>ionic + laravel</code>写的，虽然才写了30%，但其实自己也学到怎么使用<code>ionic</code>与<code>laravel</code>，收获还蛮大的。</p>
<p>再接下来呢，有空了，听说<code>TypeScript</code>与<code>Angular</code>都发布了2.0版本，于是又兴致勃勃地去学习，先是把<code>TypeScript</code>学了基础的一遍，紧接着就开始学习<code>Angular2</code>，跟着中文网的英雄指南敲了一遍，大概清楚开发流程，感觉<code>Angular2</code>比之前的<code>AngularJS</code>简化了很多概念，但是因为引入了<code>TypeScript</code>，增加了不少的学习成本，上手容易，但是真正用来开发还是有不少难度，类似于<code>Java</code>的语法加上<code>RxJS</code>等概念，当自己做东西时候就会感到吃力了。接着，因为王老师突然叫我做个小东西来提高他的工作效率，于是中断了学习。</p>
<p>当做完了王老师的项目，然后偶然的机会听说了<code>vue</code>也出了<code>2.0</code>版本，然后兴致奋奋地看文档了，只能说<code>vue</code>太像<code>AngularJS</code>了，但是又比<code>AngularJS</code>简单了很多，文档如果看得快基本一天就可以看完了，然后感觉<code>vue</code>比<code>AngularJS</code>爽多了。接着招新开始了，我们需要做一个线上报名系统，然后我觉得<code>vue</code>学得可以，就用上<code>vue</code>开始干吧。</p>
<p>就一个页面…干了也没什么卵用，然后就想了想，要不加个签到系统？自动排队自动签到，然后又开始干干…其实到现在(2017年1月12日)也还没有干完……</p>
<p>就这么，一年差不多就过完了，来到大三第一学期结尾，最紧张就是考试了，不过今天(2016年1月12日)也结束了，回想了过去一年，好像过得很充实没有遗憾，但好像什么都没有一样。时间过得真快，两年了，刚进大学什么都不懂，到现在会为生活着想，会想着一件事奋斗，谢谢工作室的所有师兄和小伙伴，没有你们的帮助我也不会成长那么快，也谢谢父母对我的理解，这学期真的很少回家哦，谢谢你们时刻地挂念，爱你们。还有一个人，我真的十分感谢你，我的女朋友，谢谢两年以来你的不离不弃，尽管我们聚少离多，但也从来没有减退你的爱意，谢谢你的爱，我做什么都想为你带来更好的生活，谢谢你的理解。</p>
<p>谢谢很多很多人，希望你们都可以好好的，2017年，新年快乐！</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Redis安装与使用(一)]]></title>
      <url>https://blog.chenjunwu.cn/2016/09/25/redis/</url>
      <content type="html"><![CDATA[<p>Redis是一个key-value存储系统。和Memcached类似，它支持存储的value类型相对更多，包括string(字符串)、list(链表)、set(集合)、zset(sorted set –有序集合)和hash（哈希类型）。这些数据类型都支持push/pop、add/remove及取交集并集和差集及更丰富的操作，而且这些操作都是原子性的。在此基础上，redis支持各种不同方式的排序。与memcached一样，为了保证效率，数据都是缓存在内存中。区别的是redis会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件，并且在此基础上实现了master-slave(主从)同步……好了不胡乱扯了…</p>
<h2 id="Begin"><a href="#Begin" class="headerlink" title="Begin!"></a>Begin!</h2><a id="more"></a>
<h2 id="一、在windows下安装"><a href="#一、在windows下安装" class="headerlink" title="一、在windows下安装"></a>一、在windows下安装</h2><p>额…这个就不说了，简单且在github上有说明，<a href="https://github.com/MSOpenTech/redis" target="_blank" rel="external">传送门</a>再次，简单介绍就是redis官方不支持windows平台，然后微软的小伙伴就自己搞了一套放在github上开源，拯救了常年活在windows下又想试试redis的小伙伴。</p>
<h2 id="二、在linux下安装"><a href="#二、在linux下安装" class="headerlink" title="二、在linux下安装"></a>二、在linux下安装</h2><p>我是直接从官方下载再编译安装的，官方做得好，编译安装并不像其他一样各种依赖没有处理。几条命令就可以了(此时最新版3.2.3)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://download.redis.io/releases/redis-3.2.3.tar.gz</span><br><span class="line">$ tar xzf redis-3.2.3.tar.gz</span><br><span class="line">$ cd redis-3.2.3</span><br><span class="line">$ make install</span><br></pre></td></tr></table></figure>
<p>如果发现自己执行最后一条命令时报错，可能是你并没有安装gcc编译，只要你安装gcc在make一次就可以了，安装gcc也是直接一条命令即可(我的linux是centos7发行版)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install gcc</span><br></pre></td></tr></table></figure></p>
<p>注意：网上说是执行<code>make</code>，其实都可以，只是<code>make install</code>会把redis的执行脚本也安装在<code>/usr/local/bin</code>目录下，便于我们在全局使用。</p>
<p>此时只要我们执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ redis-server</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/asset/2016/2016-09-25_204748.png" alt="redis-server效果"></p>
<p>但是这样占据了我们所有的命令行，不方便，这时我们需要让redis运行在后台，需要将redis当作服务来运行。</p>
<p>首先我们在解压文件<code>redis-3.2.3</code>下找到文件夹<code>utils</code>，找到文件<code>redis_init_script</code></p>
<p><img src="/images/asset/2016/2016-09-25_205819.png" alt="utils/redis_init_script"></p>
<p>将此文件复制到目录<code>/etc/rc.d/init.d/</code>下，改名为<code>redisd</code>，此目录下脚本为系统自动执行脚本(能够称为脚本，务必检查有木有头<code>#!/bin/sh</code>)。</p>
<p>注意到上图，保证<code>/usr/local/bin/</code>存在<code>redis-server</code>与<code>redis-cli</code>，<code>/etc/redis/</code>存在<code>6379.conf</code>文件(6379.conf即为redis.conf文件，如果<code>/etc/下没有reids目录就自行新建即可</code>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ service redisd start</span><br></pre></td></tr></table></figure>
<p>执行后仍然出现redis占满的介绍，此时只要回车即可，那么redis就在后台跑起来了，我们可以检测一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli</span><br></pre></td></tr></table></figure>
<p><img src="/images/asset/2016/2016-09-25_211519.png" alt="redis执行检测"></p>
<p>或者这样检测，检测到6379端口应用即为后台运行的redis服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ netstat -an | grep 6379</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/asset/2016/2016-09-25_212211.png" alt="redis执行检测"></p>
<p>此时大工搞成，当然我们新安装的redis是默认不需要认证就可以使用，我们可以修改配置文件(我这里是<code>/etc/redis/6379.conf</code>文件)</p>
<p><img src="/images/asset/2016/2016-09-25_212708.png" alt="6379.conf"></p>
<p>当然，如果你要远程操控redis还必须改</p>
<p><img src="/images/asset/2016/2016-09-25_212934.png" alt="redis远程访问"></p>
<p>此时搞好了，别忘了重启redis<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ service redisd stop</span><br><span class="line">$ service redisd start</span><br></pre></td></tr></table></figure></p>
<p>有时会出现无法终止redis，此时可以试试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -a your_password shutdown # your_password 是你设的密码, 没有就忽略</span><br><span class="line">$ service redisd start</span><br></pre></td></tr></table></figure></p>
<p>最后推荐一款redis图形化管理工具<a href="https://redisdesktop.com/download" target="_blank" rel="external">RedisDesktopManager</a>，C++编写，打开效率高，操作简单，跨平台，实力杠杠的。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Provider, Factory, Service之间比较]]></title>
      <url>https://blog.chenjunwu.cn/2016/08/10/provider-factory-service%E4%B9%8B%E9%97%B4%E6%AF%94%E8%BE%83/</url>
      <content type="html"><![CDATA[<p>刚刚学习Angular的时候，接触到服务(Service)这块时，我们知道可以自定义服务，但是又会感到疑惑，因为Angular提供了三个方式让我们自定义服务：<code>provider</code>, <code>factory</code>与<code>service</code>，那到底我们怎么选择？还有这三者之间有什么关系语句区别？这就是本文讨论的主题。</p>
<h2 id="Talking-About-Service"><a href="#Talking-About-Service" class="headerlink" title="Talking About Service!"></a>Talking About Service!</h2><a id="more"></a>
<h2 id="一、Provider-Factory与Service关系"><a href="#一、Provider-Factory与Service关系" class="headerlink" title="一、Provider, Factory与Service关系"></a>一、Provider, Factory与Service关系</h2><p>说实话，其实这三者，本质上都是<code>provider</code>，后者<code>factory</code>与<code>service</code>你可以看做是<code>provider</code>的语法糖，我这么说根据在哪？   就在源码上</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">factory</span>(<span class="params">name, factoryFn, enforce</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> provider(name, &#123;</span><br><span class="line">    $get: enforce !== <span class="literal">false</span> ? enforceReturnValue(name, factoryFn) : factoryFn</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">service</span>(<span class="params">name, constructor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> factory(name, [<span class="string">'$injector'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$injector</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $injector.instantiate(<span class="keyword">constructor</span>);</span><br><span class="line">  &#125;]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从源码上可以看出<code>factory</code>是闭包返回<code>provider</code>函数，而<code>service</code>是对<code>factory</code>进一步封装，那么我们会看到<code>provider</code>里<code>$get</code>，这个有什么用呢？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">provider</span>(<span class="params">name, provider_</span>) </span>&#123;</span><br><span class="line">  assertNotHasOwnProperty(name, <span class="string">'service'</span>);</span><br><span class="line">  <span class="keyword">if</span> (isFunction(provider_) || isArray(provider_)) &#123;</span><br><span class="line">    provider_ = providerInjector.instantiate(provider_);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!provider_.$get) &#123;</span><br><span class="line">    <span class="keyword">throw</span> $injectorMinErr(<span class="string">'pget'</span>, <span class="string">"Provider '&#123;0&#125;' must define $get factory method."</span>, name);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> providerCache[name + providerSuffix] = provider_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面<code>provider</code>源码可见，我们必须定义<code>$get</code>，否则Angular会直接抛出异常，当我们定义了<code>$get</code>后，Angular会利用<code>$get</code>返回一个<code>provider</code>实例，允许我们通过注入的方式使用该实例。</p>
<p>而<code>service</code>中，使用到了注射器服务通过<code>instantiate</code>的API实例化了构造函数<code>constructor</code>，因此在<code>service</code><br>定义服务会比较简单，你只需要定义一个构造函数作为回调函数即可。</p>
<h2 id="二、在应用上看Provider-Factory与Service"><a href="#二、在应用上看Provider-Factory与Service" class="headerlink" title="二、在应用上看Provider, Factory与Service"></a>二、在应用上看Provider, Factory与Service</h2><h3 id="Provider"><a href="#Provider" class="headerlink" title="Provider"></a><strong>Provider</strong></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'myApp'</span>, []);</span><br><span class="line"></span><br><span class="line">app.provider(<span class="string">'myProvider'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// injecting service where you need...</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        $get: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                log: <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.controller(<span class="string">'myCtrl'</span>, [<span class="string">'$scope'</span>, <span class="string">'myProvider'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$scope,myProvider</span>)</span>&#123;</span><br><span class="line">    myProvider.log(<span class="string">"provider"</span>);</span><br><span class="line">&#125;]);</span><br></pre></td></tr></table></figure>
<p><img src="/images/asset/2016/2016-08-10_556.png" alt="console"></p>
<p>而且我们在定义<code>provider</code>时，回调函数是否设置返回值均可以，即可以这样写</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">app.provider(<span class="string">'myProvider'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// injecting service where you need...</span></span><br><span class="line">    <span class="keyword">this</span>.$get = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            log: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"provider"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>而且在<code>porvider</code>定义里，当需要依赖其他服务时，不需要声明式地注入，而是哪里需要哪里进行注入，这也是和<code>factory</code>或<code>service</code>创建服务的区别。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">app.provider(<span class="string">'myProvider'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// injecting service where you need...</span></span><br><span class="line">    <span class="keyword">this</span>.$get = <span class="function"><span class="keyword">function</span> (<span class="params">$rootScope</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            log: <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"$rootScope.value: "</span> + value);</span><br><span class="line">            &#125;,</span><br><span class="line">            setValue: <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">                $rootScope.value = value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/images/asset/2016/2016-08-10_0612.png" alt="sublime"><br><img src="/images/asset/2016/2016-08-10_612.png" alt="console"></p>
<h3 id="Factory"><a href="#Factory" class="headerlink" title="Factory"></a><strong>Factory</strong></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">app.factory(<span class="string">'myFactory'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> factory = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    factory.log = <span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> factory;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.controller(<span class="string">'myCtrl'</span>, [<span class="string">'myFactory'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">myFactory</span>)</span>&#123;</span><br><span class="line">    myFactory.log(<span class="string">"factory"</span>);</span><br><span class="line">&#125;]);</span><br></pre></td></tr></table></figure>
<p><img src="/images/asset/2016/2016-08-10_621.png" alt="console"></p>
<p><code>factory</code>还可以这样定义：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">app.factory(<span class="string">'myFactory'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.log = <span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>如果这样定义，相当于返回一个构造函数，当我们注入该服务时，会得到一个构造函数，新建实例需要我们自己创建。</p>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a><strong>Service</strong></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app.service(<span class="string">'myService'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.log = <span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.controller(<span class="string">'myCtrl'</span>, [<span class="string">'myService'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">myService</span>) </span>&#123;</span><br><span class="line">    myService.log(<span class="string">'Service'</span>);</span><br><span class="line">&#125;]);</span><br></pre></td></tr></table></figure>
<p><img src="/images/asset/2016/2016-08-10_0705.png" alt="console"></p>
<h2 id="三、Provider-Factory与Service区别"><a href="#三、Provider-Factory与Service区别" class="headerlink" title="三、Provider, Factory与Service区别"></a>三、Provider, Factory与Service区别</h2><p><code>provider</code>与<code>factory</code>, <code>service</code>不同的是，<code>provider</code>可以进行配置，而<code>factory</code>与<code>service</code>不可以。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">app.provider(<span class="string">'myProvider'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// injecting service where you need...</span></span><br><span class="line">    <span class="keyword">this</span>.$get = <span class="function"><span class="keyword">function</span> (<span class="params">$rootScope</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            log: <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"$rootScope.value: "</span> + value);</span><br><span class="line">            &#125;,</span><br><span class="line">            setValue: <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">                $rootScope.value = value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.set = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"In config"</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Setting"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.config(<span class="function"><span class="keyword">function</span>(<span class="params">myProviderProvider</span>) </span>&#123;</span><br><span class="line">    myProviderProvider.set();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/images/asset/2016/2016-08-10_0718.png.png" alt="console"></p>
<p>而需要这样的是：在应用开始前对service进行配置的时候就需要使用到<code>provider()</code>。比如，我们需要配置服务在不同的部署环境里面（开发，演示，生产）使用不同的后端处理的时候就可以使用到了；当我们需要独立出来开发大型的服务时，我们可以考虑用<code>provider</code>，这样做的好处是可以把配置项独立出来放在<code>config</code>进行配置。</p>
<p>而<code>factory</code>与<code>service</code>在使用上基本没有什么区别，只是<code>factory</code>会比<code>service</code>更灵活一些，建议不熟悉时多使用<code>service</code>，可以简化操作。</p>
<hr>
<p>推荐阅读博文：<a href="https://segmentfault.com/a/1190000003096933" target="_blank" rel="external">https://segmentfault.com/a/1190000003096933</a><br>Angular源码：<a href="https://code.angularjs.org/1.4.12/angular.js" target="_blank" rel="external">https://code.angularjs.org/1.4.12/angular.js</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[$watch, $apply, $digest的关系]]></title>
      <url>https://blog.chenjunwu.cn/2016/08/08/$watch-$apply-$digest/</url>
      <content type="html"><![CDATA[<p>AngularJS中我们熟知的双向数据绑定，可是它到底怎么运作的，就和这几个概念有关，然而这几个概念很容易混淆视听，而且几个概念之间关系也很容易搞得扑朔迷离，但是看了一篇博文之后茅塞顿开，今天就来分享一下算是读后感吧。</p>
<h2 id="Let’s-start-from-the-beginning"><a href="#Let’s-start-from-the-beginning" class="headerlink" title="Let’s start from the beginning!"></a>Let’s start from the beginning!</h2><a id="more"></a>
<h2 id="一、浏览器事件与AngularJS的扩展"><a href="#一、浏览器事件与AngularJS的扩展" class="headerlink" title="一、浏览器事件与AngularJS的扩展"></a>一、浏览器事件与AngularJS的扩展</h2><p>我们的浏览器都是等待事件，例如我们触发一个按钮或者表单的输入，这些事件都会带有一个回调机制来通知我们浏览器接下来要做什么，所以在回调函数中我们可以对相应的DOM进行操作，等到回调完毕，浏览器就会相应对DOM做出变化。AngularJS扩展了这个机制，不但但是回调，而是事件循环生成一个有时成为AngularJS的上下文执行环境</p>
<h2 id="二、-watch队列"><a href="#二、-watch队列" class="headerlink" title="二、$watch队列"></a>二、$watch队列</h2><p>任何时候当你在视图上绑定了AngularJS事件时，都会在<code>$watch</code>队列插入一个<code>$watch</code>。这个<code>$watch</code>可以检测到model上的变化。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">ng-model</span>=<span class="string">"user"</span> /&gt;</span></span><br><span class="line">Password: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">ng-model</span>=<span class="string">"password"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.controller(<span class="string">"myCtrl"</span>, [<span class="string">'$scope'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $scope.user = <span class="string">"jim"</span>;</span><br><span class="line">    $scope.password = <span class="number">123</span>;</span><br><span class="line">&#125;]);</span><br></pre></td></tr></table></figure>
<p>在这里我们就会有<code>$scope.user</code>与<code>$scope.password</code>，负责绑定视图上的对应的输入框，这样我们就有了两个<code>$watch</code></p>
<p>我们再看看下面例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.controller(<span class="string">"myCtrl"</span>, [<span class="string">'$scope'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $scope.world = <span class="string">"World"</span>;</span><br><span class="line">    $scope.foo = <span class="string">"Foo"</span>;</span><br><span class="line">&#125;]);</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello, &#123;&#123;world&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>在这里我们只是为一个视图绑定(尽管<code>$scope</code>上绑定两个值)，但是这里还只是创建了一个<code>$watch</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.controller(<span class="string">"myCtrl"</span>, [<span class="string">'$scope'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $scope.people = [...];</span><br><span class="line">&#125;]);</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">ng-repeat</span>=<span class="string">"person in people"</span>&gt;</span></span><br><span class="line">        &#123;&#123;person.name&#125;&#125; - &#123;&#123;person.age&#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在这里<code>ng-repeat</code>指令是在循环<code>$scope.people</code>数组，假设数组有10个元素，在视图上每个元素都绑定了两个<code>$watch</code>，注意还有一个<code>$watch</code>是来自于<code>ng-repeat</code>指令，所以<code>$watch队列</code>中总共有 <code>(2 * 10) + 1</code> 个<code>$watch</code>，也就是21个。</p>
<p>那么只要视图上有一事件进行绑定就有一个<code>$watch</code>创建，那什么时候创建<code>$watch</code></p>
<p>我们Angular应用执行分为三个阶段( 加载load-编译compile-链接link )，在编译阶段Angular会遍历所有指令然后创建所有需要的<code>$watch</code>，创建后那接下来怎么样呢？</p>
<h2 id="三、-digest循环"><a href="#三、-digest循环" class="headerlink" title="三、$digest循环"></a>三、$digest循环</h2><p>之前说到Angular扩展了事件循环，当浏览器接收到能通过Angular应用的上下文处理的事件时<code>$digest</code>循环就会触发，这个循环分为两个小循环。一个是<code>$evalAsync</code>队列然后另外一个是<code>$watch</code>队列，在<code>$watch</code>队列循环中，就会进行一个“脏值检测”( <code>dirty-checking</code> )过程，通过至少两次循环来检测<code>$watch</code>是否发生变化，没有发生变化就能确定<code>$watch</code>不再变化，就会退出循环。但是如果一直变化，Angular也不会一直触发循环。当循环次数超过10次时，它会抛出一个异常，防止应用陷入无限循环中。当<code>$digest</code>循环结束时，DOM就会做出相应地变化。</p>
<p>例子：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ng-controller</span>=<span class="string">"myCtrl"</span>&gt;</span></span><br><span class="line">    &#123;&#123;name&#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">ng-click</span>=<span class="string">"change()"</span>&gt;</span>Change<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="javascript"></span><br><span class="line">    ...</span><br><span class="line">    app.controller(<span class="string">'myCtrl'</span>, [<span class="string">'$scope'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$scope</span>) </span>&#123;</span><br><span class="line">        $scope.name = <span class="string">"Jane"</span>;</span><br><span class="line">        $scope.change = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            $scope.name = <span class="string">"Jim"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;]);</span><br><span class="line"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>在这里只有一个<code>$watch</code>，因为<code>ng-click</code>不会创建<code>$watch</code>(函数是不会发生变化的)<br>那么分析如下：</p>
<ul>
<li>当我们点击按钮时</li>
<li>浏览器接收到一个进入Angular上下文的事件</li>
<li>由于检测<code>$scope.name</code>变化的<code>$watch</code>报告了变化，就会触发另外一次<code>$digest</code>循环</li>
<li>直到新的循环报告没有发生变化时</li>
<li>浏览器得到控制权然后更新与<code>$scope.name</code>相关的DOM部分</li>
</ul>
<p>从这里我们可以知道一个重要信息，当每一个进入Angular上下文的事件触发时都会触发新的一轮<code>$digest</code>循环，这意味着我们在输入框输入每一个字母，数字或符号时都触发<code>$digest</code>循环检测整个页面的每一个<code>$watch</code>变化。</p>
<h2 id="四、-watch应用"><a href="#四、-watch应用" class="headerlink" title="四、$watch应用"></a>四、$watch应用</h2><p>那我们什么时候需要用到手动使用<code>$watch</code>创建Angular上下文事件呢？我们看一下这个例子</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">number: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">ng-model</span>=<span class="string">"number"</span> /&gt;</span>&amp;nbsp;&amp;nbsp;&#123;&#123;number&#125;&#125;</span><br><span class="line">price-per-unit: &#123;&#123;per&#125;&#125; </span><br><span class="line">total-price: &#123;&#123;price&#125;&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="javascript"></span><br><span class="line">    <span class="keyword">var</span> app = angular.module(<span class="string">'myApp'</span>, []);</span><br><span class="line">    app.controller(<span class="string">'myCtrl'</span>, [<span class="string">'$scope'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$scope</span>) </span>&#123;</span><br><span class="line">        $scope.per = <span class="number">10</span>;</span><br><span class="line">        $scope.number = <span class="number">0</span>;</span><br><span class="line">        $scope.price = $scope.number * $scope.per;</span><br><span class="line">    &#125;]);</span><br><span class="line"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们初始化了数量以及单价，相应计算总价，然而我们会发现，当我们在视图上改变数量时，我们发现只有<code>$scope.number</code>发现了改变反应到视图上，而<code>$scope.price</code>并没有发生变化所以在视图上没有变化。为什么呢？</p>
<p>原因在于指令<code>ng-model</code>，具体原因等下再说，那现在我们怎么办呢？</p>
<p>其实我们有两种办法：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">number: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">ng-model</span>=<span class="string">"number"</span> <span class="attr">ng-change</span>=<span class="string">"totalCount()"</span>/&gt;</span></span><br><span class="line">&amp;nbsp;&amp;nbsp;&#123;&#123;number&#125;&#125;</span><br><span class="line">price-per-unit: &#123;&#123;per&#125;&#125; </span><br><span class="line">total-price: &#123;&#123;price&#125;&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="javascript"></span><br><span class="line">    ...</span><br><span class="line">    app.controller(<span class="string">'myCtrl'</span>, [<span class="string">'$scope'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$scope</span>) </span>&#123;</span><br><span class="line">        $scope.per = <span class="number">10</span>;</span><br><span class="line">        $scope.number = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        $scope.totalCount = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            $scope.price = $scope.number * $scope.per;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;]);</span><br><span class="line"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/asset/2016/2016-08-08_0231.png" alt="browser"><br><img src="/images/asset/2016/2016-08-08_231.png" alt="console"></p>
<p>至于为什么使用<code>ng-change</code>指令也可以呢，其实从源码可以看出<code>ng-change</code>指令是依赖于<code>ng-model</code>指令，所以还是等会从<code>ng-model</code>指令入手</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ngChangeDirective = valueFn(&#123;</span><br><span class="line">  restrict: <span class="string">'A'</span>,</span><br><span class="line">  <span class="built_in">require</span>: <span class="string">'ngModel'</span>,</span><br><span class="line">  link: <span class="function"><span class="keyword">function</span>(<span class="params">scope, element, attr, ctrl</span>) </span>&#123;</span><br><span class="line">    ctrl.$viewChangeListeners.push(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      scope.$<span class="built_in">eval</span>(attr.ngChange);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>第二种方法呢我们就是调用$watch函数监控变化</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">number: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">ng-model</span>=<span class="string">"number"</span> /&gt;</span></span><br><span class="line">&amp;nbsp;&amp;nbsp;&#123;&#123;number&#125;&#125;</span><br><span class="line">price-per-unit: &#123;&#123;per&#125;&#125; </span><br><span class="line">total-price: &#123;&#123;price&#125;&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="javascript"></span><br><span class="line">    ...</span><br><span class="line">    app.controller(<span class="string">'myCtrl'</span>, [<span class="string">'$scope'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$scope</span>) </span>&#123;</span><br><span class="line">        $scope.per = <span class="number">10</span>;</span><br><span class="line">        $scope.number = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        $scope.$watch(<span class="string">'number'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">newValue, oldValue, scope</span>) </span>&#123;</span><br><span class="line">            scope.price = scope.number * scope.per;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;]);</span><br><span class="line"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/asset/2016/2016-08-08_251.png" alt="browser"><br><img src="/images/asset/2016/2016-08-08_0251.png" alt="console"></p>
<p>这里的意思就是检测<code>$scope.number</code>的变化，当<code>$scope.number</code>发生变化时就会触发回调函数，而且还会触发<code>$digest</code>循环，所以可以说我们就为<code>$scope.price</code>定义一个Angular上下文事件，触发条件就是<code>$scope.number</code>变化，从回调函数我们也可以看出，<code>$watch</code>内部会将上一次的值<code>oldValue</code>缓存起来，就可以猜测到<code>$digest</code>循环是可以获取到上一次的值作比较的。</p>
<p>我们一直强调Angular上下文环境，那怎么才会进入Angular上下文环境呢？</p>
<h2 id="五、通过-apply进入Angular上下文环境"><a href="#五、通过-apply进入Angular上下文环境" class="headerlink" title="五、通过$apply进入Angular上下文环境"></a>五、通过$apply进入Angular上下文环境</h2><p>当事件触发时，调用<code>$apply</code>就会进入Angular上下文环境，但是如果你不调用就不会进入，就好比<code>ng-click</code>指令，当你点击带有此指令的按钮时，Angular会自动帮你封装到<code>$apply</code>中调用，使得进入Angular上下文才能让view与model建立数据绑定。</p>
<p>那么现在我们可以回答刚刚<code>ng-model</code>指令的问题了：其实<code>ng-model</code>中也是Angular封装在<code>$apply</code>中调用，可以从源码看出</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这是NgModelController中的方法</span></span><br><span class="line"><span class="comment">// 这里的value就是我们输入框的输入的value</span></span><br><span class="line"><span class="comment">// 这里ctrl是this的拷贝，this指向NgModelController</span></span><br><span class="line"><span class="keyword">this</span>.$setViewValue = <span class="function"><span class="keyword">function</span>(<span class="params">value, trigger</span>) </span>&#123;</span><br><span class="line">    ctrl.$viewValue = value;</span><br><span class="line">    <span class="keyword">if</span> (!ctrl.$options || ctrl.$options.updateOnDefault) &#123;</span><br><span class="line">      <span class="comment">// 方法具体在下面  </span></span><br><span class="line">      ctrl.$$debounceViewValueCommit(trigger);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.$$debounceViewValueCommit = <span class="function"><span class="keyword">function</span>(<span class="params">trigger</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> debounceDelay = <span class="number">0</span>,</span><br><span class="line">        options = ctrl.$options,</span><br><span class="line">        debounce;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options &amp;&amp; isDefined(options.debounce)) &#123;</span><br><span class="line">      debounce = options.debounce;</span><br><span class="line">      <span class="keyword">if</span> (isNumber(debounce)) &#123;</span><br><span class="line">        debounceDelay = debounce;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isNumber(debounce[trigger])) &#123;</span><br><span class="line">        debounceDelay = debounce[trigger];</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isNumber(debounce[<span class="string">'default'</span>])) &#123;</span><br><span class="line">        debounceDelay = debounce[<span class="string">'default'</span>];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $timeout.cancel(pendingDebounce);</span><br><span class="line">    <span class="keyword">if</span> (debounceDelay) &#123;</span><br><span class="line">      pendingDebounce = $timeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        ctrl.$commitViewValue();</span><br><span class="line">      &#125;, debounceDelay);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ($rootScope.$$phase) &#123;</span><br><span class="line">      ctrl.$commitViewValue();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      $scope.$apply(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;    <span class="comment">// 我们看到这里的$apply</span></span><br><span class="line">        ctrl.$commitViewValue();</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们从<code>$setViewValue</code>方法可知获取到输入的value值后直接赋值给<code>ngModelController</code>方法的属性<code>$viewValue</code>然后调用了<code>$$debounceViewValueCommit</code>方法，我们聚焦到最后，直接调用了<code>$apply</code>执行视图的更新，调用了<code>$commitViewValue()</code>，从解析上看是把未更新的数据提交给<code>$modelValue</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * @ngdoc method</span><br><span class="line">   * @name ngModel.NgModelController#$commitViewValue</span><br><span class="line">   *</span><br><span class="line">   * @description</span><br><span class="line">   * Commit a pending update to the `$modelValue`.</span><br><span class="line">   *</span><br><span class="line">   * Updates may be pending by a debounced event or because the input is waiting for a some future</span><br><span class="line">   * event defined in `ng-model-options`. this method is rarely needed as `NgModelController`</span><br><span class="line">   * usually handles calling this in response to input events.</span><br><span class="line">   */</span><br></pre></td></tr></table></figure>
<p>然后继续查看会发现最终调用<code>ngModelController</code>一个方法<code>$$writeModelToScope</code>，从源码看，最终它把<code>$modelValue</code>绑定到Scope上，于是建立起了<code>model-view</code>的关系</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">this.$$writeModelToScope = function() &#123;</span><br><span class="line">    ngModelSet($scope, ctrl.$modelValue);   // 这里</span><br><span class="line">    forEach(ctrl.$viewChangeListeners, function(listener) &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        listener();</span><br><span class="line">      &#125; catch (e) &#123;</span><br><span class="line">        $exceptionHandler(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="六、什么时候Angular不会自动为我们调用-apply"><a href="#六、什么时候Angular不会自动为我们调用-apply" class="headerlink" title="六、什么时候Angular不会自动为我们调用$apply"></a>六、什么时候Angular不会自动为我们调用$apply</h2><p>其实很通俗来说，只要你触发的事件属于Angular管辖范围，都会进入Angular上下文环境，也就是说若触发的事件不属于Angular的，这时为了进入Angular上下文我们就必须手动调用<code>$apply</code>，比如说我用第三方库(JQuery)为DOM绑定各种事件时，这些事件就不属于Angular管辖，若想要触发这些事件时进入Angular上下文环境，就必须调用<code>$apply</code>才会进入<code>$digest</code>循环</p>
<p>例子：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ng-controller</span>=<span class="string">"myCtrl"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">clickable</span> <span class="attr">foo</span>=<span class="string">"foo"</span> <span class="attr">bar</span>=<span class="string">"bar"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="javascript"></span><br><span class="line">    <span class="keyword">var</span> app = angular.module(<span class="string">'myApp'</span>, []);</span><br><span class="line"></span><br><span class="line">    app.directive(<span class="string">'clickable'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            restrict: <span class="string">"E"</span>,</span><br><span class="line">            scope: &#123;</span><br><span class="line">                foo: <span class="string">"="</span>,</span><br><span class="line">                bar: <span class="string">"="</span></span><br><span class="line">            &#125;,</span><br><span class="line">            template: <span class="string">'&lt;ul style="background-color: lightblue"&gt;&lt;li&gt;&#123;&#123;foo&#125;&#125;&amp;nbsp;&amp;nbsp;&lt;button&gt;触发&lt;/button&gt;&lt;/li&gt;&lt;li&gt;&#123;&#123;bar&#125;&#125;&amp;nbsp;&amp;nbsp;&lt;button&gt;触发&lt;/button&gt;&lt;/li&gt;&lt;/ul&gt;'</span>,</span><br><span class="line">            link: <span class="function"><span class="keyword">function</span>(<span class="params">scope, element, attrs</span>) </span>&#123;</span><br><span class="line">                element.bind(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                    scope.foo++;</span><br><span class="line">                    scope.bar++;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"foo="</span> + scope.foo + <span class="string">"/bar="</span> + scope.bar);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    app.controller(<span class="string">'myCtrl'</span>, [<span class="string">'$scope'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$scope</span>) </span>&#123;</span><br><span class="line">        $scope.foo = <span class="number">0</span>;</span><br><span class="line">        $scope.bar = <span class="number">0</span>;</span><br><span class="line">    &#125;]);    </span><br><span class="line"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><img src="/images/asset/2016/2016-08-08_532.png" alt="browser"><br><img src="/images/asset/2016/2016-08-08_0532.png" alt="console"></p>
<p>我们在link函数中对DOM绑定一个事件，每次点击元素时都会使<code>foo</code>和<code>bar</code>自增1</p>
<p>无论我们怎么触发，我们可以发现model上的值是发生了改变，可是没有反应到view上，因为没有进行<code>$digest</code>循环，监视<code>foo</code>和<code>bar</code>的<code>$watch</code>没有执行。也就是说我们必须手动执行<code>$apply</code>，这样<code>$watch</code>才会知道变化并通知DOM的更新。</p>
<p>我们必须改写<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">element.bind(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    scope.foo++;</span><br><span class="line">    scope.bar++;</span><br><span class="line">    scope.$apply();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/asset/2016/2016-08-08_543.png" alt="browser"><br><img src="/images/asset/2016/2016-08-08_0532.png" alt="console"></p>
<p>当然我们拥有更好的写法就是</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">element.bind(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    scope.$apply(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        scope.foo++;</span><br><span class="line">        scope.bar++;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>原因在于<code>$apply</code>内部封装了一套<code>try-catch</code>异常处理，我们的逻辑代码如果出现异常可以直接交给Angular处理，所以更加建议这样的写法。</p>
<p>所以说白了，只要是第三方库(例如<code>JQuery</code>)更新绑定的数据，Angular就无法知道，这时我们就必须调用<code>$apply</code>通知Angular。</p>
<hr>
<p>博客原文：<a href="http://angular-tips.com/blog/2013/08/watch-how-the-apply-runs-a-digest/" target="_blank" rel="external">http://angular-tips.com/blog/2013/08/watch-how-the-apply-runs-a-digest/</a><br>Angular源码：<a href="https://code.angularjs.org/1.4.12/angular.js" target="_blank" rel="external">https://code.angularjs.org/1.4.12/angular.js</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[关于AngularJS的$q]]></title>
      <url>https://blog.chenjunwu.cn/2016/08/06/q-AngularJS/</url>
      <content type="html"><![CDATA[<p>最近爱上了AngularJS这个前端框架，上手快，而且设计思想前卫，完全不同于JQuery开发模式，而且引入了后端开发依赖注入的优秀思想，十分出色的框架让人深深感受到JavaScript语言的魅力，而且AngularJS的模块化，双向数据绑定等特性相当出色，而且在客户端还有不俗的效率，而现在我想说说AngularJS里头比较神奇的服务<code>$q</code></p>
<h2 id="Hello-AngularJS"><a href="#Hello-AngularJS" class="headerlink" title="Hello AngularJS!"></a>Hello AngularJS!</h2><a id="more"></a>
<h2 id="一、什么是服务呢？"><a href="#一、什么是服务呢？" class="headerlink" title="一、什么是服务呢？"></a>一、什么是服务呢？</h2><p><strong>概念：</strong>在Angular中，服务会是一个函数或者对象，允许你通过依赖注入的方式注入到需要用到服务Angular应用中，Angular内置许多服务例如，数据绑定的$scope与$rootScope，关于http通信服务的$http, $resource等等, 当然Angular允许我们自定义我们的服务，直接调用Angular设计好的API, provider,factory或service来创建我们的服务 <a href="https://segmentfault.com/a/1190000003096933" target="_blank" rel="external"><strong>三者区别点击这里</strong></a></p>
<h2 id="二、什么是-q"><a href="#二、什么是-q" class="headerlink" title="二、什么是$q"></a>二、什么是$q</h2><p><strong>概念：</strong>$q 是Angular内置的众多服务之一，这是一个能帮助你异步地运行函数，并且在他们仍在进程中的时候使用他们的返回值（或者捕捉异常）的服务</p>
<h2 id="三、-q的使用"><a href="#三、-q的使用" class="headerlink" title="三、$q的使用"></a>三、$q的使用</h2><h3 id="1-观看下面例子："><a href="#1-观看下面例子：" class="headerlink" title="1. 观看下面例子："></a>1. 观看下面例子：</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 此例中，我们假设变量`$ q`和`okToGreet`已经存在于当前作用域</span></span><br><span class="line"><span class="comment">// 他们可以通过依赖注入和传递参数来获取</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asyncGreet</span>(<span class="params">name</span>) </span>&#123; </span><br><span class="line">  <span class="comment">// 执行一些异步操作</span></span><br><span class="line">  <span class="comment">// 适当的时候解析(resolve)或者阻止(reject) Promise. </span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> $q(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123; </span><br><span class="line"></span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (okToGreet(name)) &#123; </span><br><span class="line">        resolve(<span class="string">'Hello, '</span> + name + <span class="string">'!'</span>); </span><br><span class="line">      &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        reject(<span class="string">'Greeting '</span> + name + <span class="string">' is not allowed.'</span>);</span><br><span class="line">      &#125; </span><br><span class="line"></span><br><span class="line">    &#125;, <span class="number">1000</span>); </span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> promise = asyncGreet(<span class="string">'Robin Hood'</span>);</span><br><span class="line"></span><br><span class="line">promise.then(<span class="function"><span class="keyword">function</span>(<span class="params">greeting</span>) </span>&#123; </span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Success: '</span> + greeting);</span><br><span class="line"></span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">reason</span>) </span>&#123; </span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Failed: '</span> + reason);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="2-在函数asyncGreet中，我们直接向-q中传入一个函数，那么我们从源码v1-4-12分析，我们定位到angular-js文件下的-Q"><a href="#2-在函数asyncGreet中，我们直接向-q中传入一个函数，那么我们从源码v1-4-12分析，我们定位到angular-js文件下的-Q" class="headerlink" title="2. 在函数asyncGreet中，我们直接向$q中传入一个函数，那么我们从源码v1.4.12分析，我们定位到angular.js文件下的 $Q"></a>2. 在函数asyncGreet中，我们直接向$q中传入一个函数，那么我们从<a href="https://code.angularjs.org/1.4.12/angular.js" target="_blank" rel="external">源码v1.4.12</a>分析，我们定位到angular.js文件下的 <code>$Q</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> $Q = <span class="function"><span class="keyword">function</span> <span class="title">Q</span>(<span class="params">resolver</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 工具函数isFunction(), 判断传入参数是否是函数, 不是就会抛出异常</span></span><br><span class="line">    <span class="keyword">if</span> (!isFunction(resolver)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> $qMinErr(<span class="string">'norslvr'</span>, <span class="string">"Expected resolverFn, got '&#123;0&#125;'"</span>, resolver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 允许直接调用构造函数进行创建新对象</span></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 然后return deferred.promise可以把deferred.promise对象的引用</span><br><span class="line">     * 赋值给创建的对象引用</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> Q)) &#123;</span><br><span class="line">      <span class="comment">// More useful when $Q is the Promise itself.</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Q(resolver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个deferred对象，类似于promise</span></span><br><span class="line">    <span class="keyword">var</span> deferred = <span class="keyword">new</span> Deferred();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//以下两个函数都是私有的工具函数，分别用来初始化deferred对象里成功与失败的响应</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">resolveFn</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">      deferred.resolve(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">rejectFn</span>(<span class="params">reason</span>) </span>&#123;</span><br><span class="line">      deferred.reject(reason);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//向传入函数传入两个工具函数允许调用时进行初始化</span></span><br><span class="line">    resolver(resolveFn, rejectFn);</span><br><span class="line">    <span class="comment">// 返回 deferred 里的promise对象</span></span><br><span class="line">    <span class="keyword">return</span> deferred.promise;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="3-所以我们找到例子中这段代码"><a href="#3-所以我们找到例子中这段代码" class="headerlink" title="3. 所以我们找到例子中这段代码"></a>3. 所以我们找到例子中这段代码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asyncGreet</span>(<span class="params">name</span>) </span>&#123; </span><br><span class="line">  <span class="comment">// 执行一些异步操作</span></span><br><span class="line">  <span class="comment">// 适当的时候解析(resolve)或者阻止(reject) Promise. </span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// function(resolve, reject) 即为源码中的resolver函数，</span></span><br><span class="line">  <span class="comment">//我们可以获得工具函数返回deferred对象的resolve和reject函数自定义配置信息，</span></span><br><span class="line">  <span class="comment">//最后从`$Q`返回deferred.promise可见，$q()会得到一个promise对象</span></span><br><span class="line">  <span class="keyword">return</span> $q(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123; </span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">      <span class="keyword">if</span> (okToGreet(name)) &#123; </span><br><span class="line">        resolve(<span class="string">'Hello, '</span> + name + <span class="string">'!'</span>); </span><br><span class="line">      &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        reject(<span class="string">'Greeting '</span> + name + <span class="string">' is not allowed.'</span>);</span><br><span class="line">      &#125; </span><br><span class="line">    &#125;, <span class="number">1000</span>); </span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此当我们调用asyncGreet函数时，返回值就是一个promise对象，因此我们的变量promise就可以直接调用promise对象的then方法进行操作，实现ES6规范中promises</p>
<h3 id="4-进一步分析源代码"><a href="#4-进一步分析源代码" class="headerlink" title="4. 进一步分析源代码"></a>4. 进一步分析源代码</h3><p>我们在 <code>$Q</code> 中找到 <code>Deferred</code> ,我们定位到 <code>Deferred</code> 中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Deferred</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 我们看这里，找到promise对象</span></span><br><span class="line">    <span class="keyword">this</span>.promise = <span class="keyword">new</span> <span class="built_in">Promise</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 下面simpleBind函数是对this指向改变</span></span><br><span class="line">    <span class="comment">//Necessary to support unbound execution :/</span></span><br><span class="line">    <span class="keyword">this</span>.resolve = simpleBind(<span class="keyword">this</span>, <span class="keyword">this</span>.resolve);</span><br><span class="line">    <span class="keyword">this</span>.reject = simpleBind(<span class="keyword">this</span>, <span class="keyword">this</span>.reject);</span><br><span class="line">    <span class="keyword">this</span>.notify = simpleBind(<span class="keyword">this</span>, <span class="keyword">this</span>.notify);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续找Promise构造方法<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Promise</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.$$state = &#123; status: <span class="number">0</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/asset/2016/2016-08-06_747.png" alt="console"></p>
<p>于是我们找到<code>$q(fn)</code>的返回对象，至于其他属性或方法追溯源代码查看即可</p>
<h3 id="5-我们再看一个例子"><a href="#5-我们再看一个例子" class="headerlink" title="5. 我们再看一个例子"></a>5. 我们再看一个例子</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asyncGreet</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 我们聚焦这里，直接调用$q.defer()方法</span></span><br><span class="line">  <span class="keyword">var</span> deferred = $q.defer();</span><br><span class="line"></span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    deferred.notify(<span class="string">'About to greet '</span> + name + <span class="string">'.'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (okToGreet(name)) &#123;</span><br><span class="line">      deferred.resolve(<span class="string">'Hello, '</span> + name + <span class="string">'!'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      deferred.reject(<span class="string">'Greeting '</span> + name + <span class="string">' is not allowed.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> deferred.promise;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实在刚刚展示源代码<code>$Q</code>方法下面我们看到</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$Q.defer = defer;</span><br><span class="line">$Q.reject = reject;</span><br><span class="line">$Q.when = when;</span><br><span class="line">$Q.resolve = resolve;</span><br><span class="line">$Q.all = all;</span><br></pre></td></tr></table></figure>
<p>是对<code>$Q</code>进行绑定属性和方法，我们继续追溯到外层的函数可以看到</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">qFactory</span>(<span class="params">nextTick, exceptionHandler</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 只截取部分源代码</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// defer方法</span></span><br><span class="line">    <span class="keyword">var</span> defer = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Deferred();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">var</span> $Q = <span class="function"><span class="keyword">function</span> <span class="title">Q</span>(<span class="params">resolver</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 省略...</span></span><br><span class="line">        <span class="keyword">return</span> deferred.promise;</span><br><span class="line">    &#125;;</span><br><span class="line">    $Q.defer = defer;</span><br><span class="line">    $Q.reject = reject;</span><br><span class="line">    $Q.when = when;</span><br><span class="line">    $Q.resolve = resolve;</span><br><span class="line">    $Q.all = all;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $Q;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以当我们直接调用<code>$q.defer()</code>方法时也可以创建一个包含promise对象的deferred对象，而且这个deferred对象向我们公开reject与resolve方法，所以通过这个deferred对象来配置我们的reject与resolve方法，最后自行返回这个deferred对象里的promise对象即可。</p>
<h3 id="6-神奇依旧继续"><a href="#6-神奇依旧继续" class="headerlink" title="6. 神奇依旧继续"></a>6. 神奇依旧继续</h3><p>我们来观察一下 <code>$q.resolve()</code> 与 <code>$q.reject()</code> 方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> reject = <span class="function"><span class="keyword">function</span>(<span class="params">reason</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">new</span> Deferred();</span><br><span class="line">    result.reject(reason);</span><br><span class="line">    <span class="keyword">return</span> result.promise;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> when = <span class="function"><span class="keyword">function</span>(<span class="params">value, callback, errback, progressBack</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">new</span> Deferred();</span><br><span class="line">    result.resolve(value);</span><br><span class="line">    <span class="keyword">return</span> result.promise.then(callback, errback, progressBack);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> resolve = when;</span><br></pre></td></tr></table></figure>
<p>从源码我们很容易知道，当我们直接使用服务<code>$q</code>调用resolve与reject时，它也是创建了一个deferred对象，然后从deferred对象检索出promise对象返回，所以我们的<code>$q.resolve()</code> 与 <code>$q.reject()</code>的返回值均是一个promise对象，这样子的话，我们可以利用这样的特性写出一套异步编程的异常处理，相当实现了<code>try-catch-throw</code>的异步模式( promise API 或者 deferred API 都是异步的 )</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">var app = angular.module(&apos;myApp&apos;, []);</span><br><span class="line">app.factory(&apos;asyncExceptionHandler&apos;,[&apos;$q&apos;, </span><br><span class="line">    function($q) &#123;</span><br><span class="line">        return function() &#123;</span><br><span class="line">            // ...</span><br><span class="line">            if(...) &#123;</span><br><span class="line">                // ...</span><br><span class="line">                return $q.resolve(&quot;success&quot;);</span><br><span class="line">            &#125;else &#123;</span><br><span class="line">                // 异常处理或者返回</span><br><span class="line">                return $q.reject(&quot;fail&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">app.controller(&apos;exceptionCtrl&apos;, [&apos;asyncExceptionHandler&apos;, </span><br><span class="line">    function(asyncExceptionHandler) &#123;</span><br><span class="line">        var promise = asyncExceptionHandler();</span><br><span class="line">        promise</span><br><span class="line">            .then(function(success) &#123;</span><br><span class="line">                console.log(success)   //&quot;success&quot;</span><br><span class="line">                // success handler</span><br><span class="line">            &#125;, function(fail) &#123;</span><br><span class="line">                console.log(fail)   //&quot;fail&quot;</span><br><span class="line">                // fail handler</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
<p>最终从源码的角度分析了AngularJS中<code>$q</code>的作用以及分析其API的特征和使用技巧，其中还有涉及的很大部分源码可以自行查阅，看懂关键代码及思想即可把AngularJS的核心思想掌握。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[接口回调]]></title>
      <url>https://blog.chenjunwu.cn/2016/06/23/java-interface-callback/</url>
      <content type="html"><![CDATA[<p>最近考试周，我们有java这门课，然而……我没有去上过一节课，那么学期末算是…预习吧，看着看着，看到接口这一部分，一个名字让我想到了很多，“接口回调”，专业性很强的术语，而且也很难让人明白它的真谛以及用处，可是搞懂了之后确实恍然大悟。</p>
<h2 id="System-out-println-“Fighting-”"><a href="#System-out-println-“Fighting-”" class="headerlink" title="System.out.println(“Fighting!”);"></a>System.out.println(“Fighting!”);</h2><a id="more"></a>
<h2 id="1-什么是接口回调"><a href="#1-什么是接口回调" class="headerlink" title="1. 什么是接口回调"></a>1. 什么是接口回调</h2><p><strong>概念: </strong> 首先我们这么理解，当我们定义一个接口时，我们再定义一个类来实现该接口，当我们创建该类的对象时，把对象的引用直接存放在接口声明的变量中，那么我们的接口变量就可以直接调用类中已经实现了的接口的方法（注意：只限于接口定义的方法，不包括类里新增加的方法），这个过程相当于通知相应对象调用这个方法。</p>
<h3 id="用两张图说明一切吧"><a href="#用两张图说明一切吧" class="headerlink" title="用两张图说明一切吧:"></a>用两张图说明一切吧:</h3><p><img src="/images/asset/2016/2016-06-23_231623.png" alt="回调"><br><img src="/images/asset/2016/2016-06-23_231702.png" alt="回调"></p>
<h2 id="2-上转型与接口回调"><a href="#2-上转型与接口回调" class="headerlink" title="2. 上转型与接口回调"></a>2. 上转型与接口回调</h2><p>我们于是可以发现，这与我们接触的上转类型有点相似，上转类型讲的是把子类的对象引用a赋予给父类声明的对象变量b，这样就称为b是a的上转型对象，此时b实际是由子类创建的对象，但是由于是上转型，b只能调用子类继承或重写的方法，继承或隐藏的属性。</p>
<p>貌似两者之间实现了同一种效果，只是表现形式不一样而已。引用别人一句话：<a href="http://blog.csdn.net/hack_bug/article/details/7625646" target="_blank" rel="external">接口回调的概念，强调使用接口来实现回调对象方法使用权的功能。而向上转型则牵涉到多态和运行期绑定的范畴。</a></p>
<h2 id="3-用-Java-接口实现回调函数的等价功能"><a href="#3-用-Java-接口实现回调函数的等价功能" class="headerlink" title="3. 用 Java 接口实现回调函数的等价功能"></a>3. 用 Java 接口实现回调函数的等价功能</h2><p>在Java对象模型中不支持方法指针，Java 的接口支持提供了一种获得回调的等价功能的机制。技巧在于定义一个接口，并且声明我们会调用的方法。</p>
<p>例如一个例子中：我们需要某件事发生时得到一个通知<br>定义一个接口，声明通知的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sample;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InterestingEvent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">interestingEvent</span> <span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样的话，我们的接口不必关心外部怎么实现，相当于我们不关心通知的内容，我们之后可以根据不同的消息实现不同的通知消息，因此发出事件信号的类必须等待实现了 InterestingEvent 接口的对象，并在适当时候调用 interestingEvent() 方法。</p>
<p>我们先定义事件，还有事件发生响应的通知。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sample;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventNotifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> InterestingEvent ie;	<span class="comment">//声明通知接口变量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> somethingHappened;	<span class="comment">//判断事件是否发生的标志</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EventNotifier</span><span class="params">(InterestingEvent event)</span> </span>&#123;</span><br><span class="line">         ie = event; <span class="comment">// 保存事件对象以备后用。</span></span><br><span class="line">         somethingHappened = <span class="keyword">false</span>; <span class="comment">// 还没有要报告的事件。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (somethingHappened) &#123; <span class="comment">// 检查设置的谓词。</span></span><br><span class="line">           ie.interestingEvent();<span class="comment">// 通过调用接口的这个方法发出事件信号。</span></span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHappened</span><span class="params">()</span></span>&#123;<span class="comment">//设置谓词。</span></span><br><span class="line">         somethingHappened = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>例如我们定义事件发生时应该通知我<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sample;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CallMe</span> <span class="keyword">implements</span> <span class="title">InterestingEvent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</span><br><span class="line">    <span class="keyword">private</span> EventNotifier en;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CallMe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="comment">// 注意 EventNotifier (InterestingEvent event)，应该传递一个接口类型。</span></span><br><span class="line">         <span class="comment">// 而下面将this，即实现了InterestingEvent接口的CallMe实例传递给</span></span><br><span class="line"><span class="comment">//EventNotifier。也就是所谓的接口回调了。</span></span><br><span class="line">         en = <span class="keyword">new</span> EventNotifier(<span class="keyword">this</span>); <span class="comment">// 创建事件通知程序，并将自身引用传递给它。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为事件定义实际的处理程序。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">interestingEvent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Call me to do it."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在这个方法里我们实现 InterestingEvent 接口的 interestingEvent 方法，我们可以测试一下接口回调的效果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sample;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">/**</span><br><span class="line">    	 * new CallMe() 对象直接赋予给 EventNotifier 构造函数第一个参数，回忆上面 </span><br><span class="line">    	 *EventNotifier 类的定义，定义了构造函数的第一个参数为 InterestingEvent</span><br><span class="line">    	 *类型的接口变量，所以当传入实现接口类的对象引用时，那么对于 EventNotifier</span><br><span class="line">    	 *类内部而言会通知接口变量ie可以调用 CallMe 类已经实现的 interestingEvent</span><br><span class="line">    	 *方法</span><br><span class="line">    	 */</span></span><br><span class="line">     	EventNotifier en=<span class="keyword">new</span> EventNotifier(<span class="keyword">new</span> CallMe());</span><br><span class="line">     	en.setHappened();</span><br><span class="line">     	en.doWork();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果如图：<br><img src="/images/asset/2016/2016-06-24_003826.png" alt="intellij idea显示结果"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[UEditor使用]]></title>
      <url>https://blog.chenjunwu.cn/2016/06/06/UEditor/</url>
      <content type="html"><![CDATA[<p>最近因为需要学了一下UEditor使用，UEditor感觉做得还可以，而且版本1.4.3以下还可以兼容IE6/7，更重要的是功能齐全还可以自我定制，这是<a href="http://ueditor.baidu.com/website/index.html" target="_blank" rel="external">UEditor官网</a>，这是<a href="http://ueditor.baidu.com/website/onlinedemo.html" target="_blank" rel="external">UEditor演示</a>，这是<a href="https://github.com/fex-team/ueditor" target="_blank" rel="external">UEditor的github地址</a></p>
<h2 id="Let’s-Go"><a href="#Let’s-Go" class="headerlink" title="Let’s Go!!"></a>Let’s Go!!</h2><a id="more"></a>
<h2 id="一、引入文件"><a href="#一、引入文件" class="headerlink" title="一、引入文件"></a>一、引入文件</h2><p><img src="/images/asset/2016/2016-06-06_202002.png" alt="引入文件"></p>
<h2 id="二、配置文件"><a href="#二、配置文件" class="headerlink" title="二、配置文件"></a>二、配置文件</h2><p><img src="/images/asset/2016/2016-06-06_202903.png" alt="配置文件"></p>
<p><code>ueditor.config.js</code>还会涉及很多的配置</p>
<h2 id="三、开始使用"><a href="#三、开始使用" class="headerlink" title="三、开始使用"></a>三、开始使用</h2><h3 id="1-在需要调用editor的地方加上"><a href="#1-在需要调用editor的地方加上" class="headerlink" title="1. 在需要调用editor的地方加上"></a>1. 在需要调用editor的地方加上</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">id</span>=<span class="string">"editor"</span> <span class="attr">type</span>=<span class="string">"text/plain"</span> <span class="attr">style</span>=<span class="string">"width:1024px;height:500px;"</span> &gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- id自己定义 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 样式可自己定义 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="javascript"></span><br><span class="line"><span class="comment">//直接实例化，创建和引用编辑器的实例</span></span><br><span class="line">	<span class="keyword">var</span> ue = UE.getEditor(<span class="string">'editor'</span>);</span><br><span class="line"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>就可以得到如下效果</p>
<p><img src="/images/asset/2016/2016-06-06_204017.png" alt="展示"></p>
<h3 id="2-实例化编辑器时也可对ueditor配置"><a href="#2-实例化编辑器时也可对ueditor配置" class="headerlink" title="2. 实例化编辑器时也可对ueditor配置"></a>2. 实例化编辑器时也可对ueditor配置</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="javascript"></span><br><span class="line"><span class="comment">//自定义功能栏目</span></span><br><span class="line">	<span class="keyword">var</span> ue = UE.getEditor(<span class="string">'editor'</span>, &#123;</span><br><span class="line">		toolbars: [[</span><br><span class="line">			<span class="comment">// ...</span></span><br><span class="line">		]]</span><br><span class="line">	&#125;);</span><br><span class="line"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>更多配置可以查看 <a href="http://fex.baidu.com/ueditor/" target="_blank" rel="external">document</a></p>
<h3 id="3-上传图片注意"><a href="#3-上传图片注意" class="headerlink" title="3. 上传图片注意"></a>3. 上传图片注意</h3><p>ueditor上传图片时默认用demo包里的 <code>php/controller.php</code>, 上传后默认存到demo包里的<code>php/upload/image</code></p>
<p>如果用demo里的controller.php上传管理图片，也可以在目录下<code>php/config.json</code><br>如下文件进行配置上传路径等：<br><img src="/images/asset/2016/2016-06-06_210706.png" alt="config.json"></p>
<h3 id="4-如何保存编辑器内容"><a href="#4-如何保存编辑器内容" class="headerlink" title="4. 如何保存编辑器内容"></a>4. 如何保存编辑器内容</h3><p>如下编辑好后<br><img src="/images/asset/2016/2016-06-06_211313.png" alt="编辑好"></p>
<p>可以这样获得内容</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="javascript"></span><br><span class="line">	<span class="keyword">var</span> content = UE.getEditor(<span class="string">'your editor ID'</span>).getContent();</span><br><span class="line"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="4-获得html文本直接放在ueditor上显示"><a href="#4-获得html文本直接放在ueditor上显示" class="headerlink" title="4. 获得html文本直接放在ueditor上显示"></a>4. 获得html文本直接放在ueditor上显示</h3><p>获得的内容是html文本<br><img src="/images/asset/2016/2016-06-06_212123.png" alt="html文本"></p>
<p>然后把内容传给后端进行保存可以，若需要获取后台返回的html文本放在ueditor上显示，可以这调用API<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="javascript"></span><br><span class="line">	UE.getEditor(<span class="string">'your editor ID'</span>).setContent(<span class="string">'your contentString'</span>);</span><br><span class="line"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>ueditor更多API调用点击 <a href="http://ueditor.baidu.com/doc/" target="_blank" rel="external">这里</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[phalcon的依赖注入]]></title>
      <url>https://blog.chenjunwu.cn/2016/05/13/phalcon_di/</url>
      <content type="html"><![CDATA[<p>最近都在学习一个用C语言以扩展形式写成的高性能php框架，phalcon，接触了一个新概念，<a href="https://en.wikipedia.org/wiki/Dependency_injection" target="_blank" rel="external">Dependency Injection</a>，中文叫依赖注入，相信学习java的同学不会陌生，如今博主想聊聊自己对依赖注入的理解</p>
<h2 id="注入主题！"><a href="#注入主题！" class="headerlink" title="注入主题！"></a>注入主题！</h2><a id="more"></a>
<h2 id="一、情景模拟"><a href="#一、情景模拟" class="headerlink" title="一、情景模拟"></a>一、情景模拟</h2><h3 id="1-我们开发一个组件，需要用到数据库的连接，我们可以这样做"><a href="#1-我们开发一个组件，需要用到数据库的连接，我们可以这样做" class="headerlink" title="1. 我们开发一个组件，需要用到数据库的连接，我们可以这样做"></a>1. 我们开发一个组件，需要用到数据库的连接，我们可以这样做</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Component</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createConnect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> \Phalcon\Db\Adapter\Pdo\Mysql(<span class="keyword">array</span>(</span><br><span class="line">			<span class="string">"host"</span> =&gt; <span class="string">"..."</span>,</span><br><span class="line">			<span class="string">"username"</span> =&gt; <span class="string">"..."</span>,</span><br><span class="line">			<span class="string">"password"</span> =&gt; <span class="string">"..."</span>,</span><br><span class="line">			<span class="string">"dbname"</span> =&gt; <span class="string">"..."</span>,</span><br><span class="line">		));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$component = <span class="keyword">new</span> Component();</span><br><span class="line">$component-&gt;createConnect();</span><br></pre></td></tr></table></figure>
<p>这样可以完成我们的需求，但是存在这样的问题，每次都会创建一个新的数据库连接不说，我们把数据库的配置写在组件里，这样很不利于该组件的复用，因为该组件除了业务逻辑处理还与数据库连接高度耦合，我们利用该组件时不能脱离此连接，因此这样设计不切实际。</p>
<h3 id="2-那么我们是不是可以把配置数据库放在外部连接，然后注入组件"><a href="#2-那么我们是不是可以把配置数据库放在外部连接，然后注入组件" class="headerlink" title="2. 那么我们是不是可以把配置数据库放在外部连接，然后注入组件"></a>2. 那么我们是不是可以把配置数据库放在外部连接，然后注入组件</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Component</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> $_connection;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setConnection</span><span class="params">($connection)</span> </span>&#123;</span><br><span class="line">		$this-&gt;$_connection = $connection;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sometask</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		$connection = $this-&gt;$_connection;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$component = <span class="keyword">new</span> Component();</span><br><span class="line"></span><br><span class="line">$component-&gt;setConnection(<span class="keyword">new</span> \Phalcon\Db\Adapter\Pdo\Mysql(<span class="keyword">array</span>(</span><br><span class="line">	<span class="string">"host"</span> =&gt; <span class="string">"..."</span>,</span><br><span class="line">	<span class="string">"username"</span> =&gt; <span class="string">"..."</span>,</span><br><span class="line">	<span class="string">"password"</span> =&gt; <span class="string">"..."</span>,</span><br><span class="line">	<span class="string">"dbname"</span> =&gt; <span class="string">"..."</span>,</span><br><span class="line">)));</span><br><span class="line"></span><br><span class="line">$component-&gt;sometask();</span><br></pre></td></tr></table></figure>
<p>貌似可以解决我们可以在外部修改数据库配置的需要，但是仍然存在不好的问题。假设我们在程序不同地方使用该组件，那么每次使用时都会新建一次数据库连接，造成资源浪费。</p>
<h3 id="3-如果我们能够把组件的数据库连接分享就可以解决问题，就像全局注册表。"><a href="#3-如果我们能够把组件的数据库连接分享就可以解决问题，就像全局注册表。" class="headerlink" title="3. 如果我们能够把组件的数据库连接分享就可以解决问题，就像全局注册表。"></a>3. 如果我们能够把组件的数据库连接分享就可以解决问题，就像全局注册表。</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Register</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> \Phalcon\Db\Adapter\Pdo\Mysql(<span class="keyword">array</span>(</span><br><span class="line">			<span class="string">"host"</span> =&gt; <span class="string">"..."</span>,</span><br><span class="line">			<span class="string">"username"</span> =&gt; <span class="string">"..."</span>,</span><br><span class="line">			<span class="string">"password"</span> =&gt; <span class="string">"..."</span>,</span><br><span class="line">			<span class="string">"dbname"</span> =&gt; <span class="string">"..."</span>,</span><br><span class="line">		));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Component</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> $_connection;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setConnection</span><span class="params">($connection)</span> </span>&#123;</span><br><span class="line">		$this-&gt;$_Connection = $connection;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sometask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$connection = $this-&gt;$_connection;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$component = <span class="keyword">new</span> Component();</span><br><span class="line">$component-&gt;setConnection(Register::getConnection());</span><br><span class="line"></span><br><span class="line">$component-&gt;sometask();</span><br></pre></td></tr></table></figure>
<p>于是我们可以进一步来说，在组件内部建立两种方法，一种方法可以新建一个连接，另一种是可以分享一个已有连接。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Register</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> $_connection;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">_createConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> \Phalcon\Db\Adapter\Pdo\Mysql(<span class="keyword">array</span>(</span><br><span class="line">			<span class="string">"host"</span> =&gt; <span class="string">"..."</span>,</span><br><span class="line">			<span class="string">"username"</span> =&gt; <span class="string">"..."</span>,</span><br><span class="line">			<span class="string">"password"</span> =&gt; <span class="string">"..."</span>,</span><br><span class="line">			<span class="string">"dbname"</span> =&gt; <span class="string">"..."</span>,</span><br><span class="line">		));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getSharedConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">self</span>::$_connection === <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">self</span>::$_connection = <span class="keyword">self</span>::_createConnection();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">self</span>::$_connection;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getNewConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">self</span>::_createConnection();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Component</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> $_connection;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setConnection</span><span class="params">($connection)</span> </span>&#123;</span><br><span class="line">		$this-&gt;_connection = $connection;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sometask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$connection = $this-&gt;_connection;</span><br><span class="line"></span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$some = <span class="keyword">new</span> Component();</span><br><span class="line"></span><br><span class="line">$some-&gt;setConnection(Register::getSharedConnection());</span><br><span class="line"></span><br><span class="line">$some-&gt;sometask();</span><br><span class="line"></span><br><span class="line">$some-&gt;setConnection(Register::getNewConnection());</span><br></pre></td></tr></table></figure>
<p>这样我们相当创建一个专门连接数据库的组件，与我们原先创建的组件分离，在代码外部创建依赖关系，降低耦合度。但是还存在问题，倘若我们需要用到很多依赖组件，我们就要创建很多setter或者传递很多参数给构造函数，而且每次用到组件时我们都去创建依赖组件，造成代码冗余过大。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$connection = <span class="keyword">new</span> \Phalcon\Db\Adapter\Pdo\Mysql();</span><br><span class="line">$session = <span class="keyword">new</span> Session();</span><br><span class="line">$fileSystem = <span class="keyword">new</span> FileSystem();</span><br><span class="line">$filter = <span class="keyword">new</span> Filter();</span><br><span class="line">$selector = <span class="keyword">new</span> Selector();</span><br><span class="line"></span><br><span class="line">$sometask = <span class="keyword">new</span> SomeComponent(</span><br><span class="line">	$connection, $session, $fileSystem, $filter, $selector</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">//或者这样</span></span><br><span class="line">$sometask-&gt;setConnection($connection);</span><br><span class="line">$sometask-&gt;setSession($session);</span><br><span class="line">$sometask-&gt;setFileSystem($fileSystem);</span><br><span class="line">$sometask-&gt;setFilter($filter);</span><br><span class="line">$sometask-&gt;setSelector($selector);</span><br></pre></td></tr></table></figure>
<p>于是我们就有了使用容器的依赖注入，phalcon就有了di的组件完成我们的工作</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Component</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> $_di;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($di)</span> </span>&#123;</span><br><span class="line">		$this-&gt;_di = $di;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sometask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$connection = $this-&gt;_di-&gt;get(<span class="string">'db'</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">someOthertask</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		$connection = $this-&gt;_di-&gt;get(<span class="string">'db'</span>);</span><br><span class="line"></span><br><span class="line">	 	$filter = $this-&gt;_di-&gt;get(<span class="string">'filter'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$di = <span class="keyword">new</span> Phalcon\DI();</span><br><span class="line"></span><br><span class="line"><span class="comment">//向容器注册一个db服务</span></span><br><span class="line">$di-&gt;set(<span class="string">'db'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> \Phalcon\Db\Adapter\Pdo\Mysql(<span class="keyword">array</span>(</span><br><span class="line">		<span class="string">"host"</span> =&gt; <span class="string">"..."</span>,</span><br><span class="line">        <span class="string">"username"</span> =&gt; <span class="string">"..."</span>,</span><br><span class="line">        <span class="string">"password"</span> =&gt; <span class="string">"..."</span>,</span><br><span class="line">        <span class="string">"dbname"</span> =&gt; <span class="string">"..."</span></span><br><span class="line">	));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//向容器注册一个filter服务</span></span><br><span class="line">$di-&gt;set(<span class="string">'filter'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Filter();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$component = <span class="keyword">new</span> Component($di);</span><br><span class="line"></span><br><span class="line">$component-&gt;sometask();</span><br></pre></td></tr></table></figure>
<p>我们把需要用到的服务预先注册到容器中，然后通过构造函数把容器注入到我们的组件中，而且，当我们组件内部用到服务时才会初始化服务，大大减少不必要资源的开销，而且di组件与我们的组件是高度解耦，di组件行为不会影响我们组件本身。</p>
<p>如果你觉得这样配置数据库，认为外部改变实例化的参数而不该注册服务很困难：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Phalcon</span>\<span class="title">Db</span>\<span class="title">Adapter</span>\<span class="title">Pdo</span>\<span class="title">Mysql</span> <span class="title">as</span> <span class="title">PdoMysql</span>;</span><br><span class="line"></span><br><span class="line">$di-&gt;set(<span class="string">'db'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> <span class="title">use</span><span class="params">($config)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> PdoMysql(<span class="keyword">array</span>(</span><br><span class="line">		<span class="string">"host"</span> =&gt; $config-&gt;host,</span><br><span class="line">        <span class="string">"username"</span> =&gt; $config-&gt;username,</span><br><span class="line">        <span class="string">"password"</span> =&gt; $config-&gt;password,</span><br><span class="line">        <span class="string">"dbname"</span> =&gt; $config-&gt;dbname</span><br><span class="line">	));</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这样当你写好配置文件映射成一个对象，通过关键字use引入匿名函数内部进行配置。</p>
<h2 id="二、Phalcon-DI组件"><a href="#二、Phalcon-DI组件" class="headerlink" title="二、Phalcon\DI组件"></a>二、Phalcon\DI组件</h2><h3 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h3><p>Phalcon\DI是一个实现服务的依赖注入功能的组件，它本身也是一个容器。</p>
<p>由于Phalcon高度解耦，Phalcon\DI 是框架用来集成其他组件的必不可少的部分，开发人员也可以使用这个组件依赖注入和管理应用程序中不同类文件的实例。</p>
<p>基本上，这个组件实现了 Inversion of Control 模式。基于此，对象不再以构造函数接收参数或者使用setter的方式来实现注入，而是直接请求服务的依赖注入。这就大大降低了整体程序的复杂性，因为只有一个方法用以获得所需要的一个组件的依赖关系。</p>
<p>此外，这种模式增强了代码的可测试性，从而使它不容易出错。</p>
<p>参考: <a href="https://docs.phalconphp.com/zh/reference/di.html#id3" target="_blank" rel="external">phalcon中文网</a></p>
<h2 id="三、容器中注册服务"><a href="#三、容器中注册服务" class="headerlink" title="三、容器中注册服务"></a>三、容器中注册服务</h2><h3 id="1-框架本身或者我们本身都可以向容器注册服务，这种方式的优点总结一下就是"><a href="#1-框架本身或者我们本身都可以向容器注册服务，这种方式的优点总结一下就是" class="headerlink" title="1. 框架本身或者我们本身都可以向容器注册服务，这种方式的优点总结一下就是:"></a>1. 框架本身或者我们本身都可以向容器注册服务，这种方式的优点总结一下就是:</h3><blockquote>
<p>A. 我们可以更换一个组件，从他们本身或者第三方轻松创建。<br>B. 在组件发布之前，我们可以充分的控制对象的初始化，并对对象进行各种设置。<br>C. 我们可以使用统一的方式从组件得到一个结构化的全局实例</p>
</blockquote>
<p>我们注册服务有几种方式:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建注入容器</span></span><br><span class="line">$di = <span class="keyword">new</span> Phalcon\DI();</span><br><span class="line"></span><br><span class="line"><span class="comment">//1. 类名注入</span></span><br><span class="line">$di-&gt;set(<span class="string">"request"</span>, <span class="string">"Phalcon\Http\Request"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//2. 匿名函数注入</span></span><br><span class="line">$di-&gt;set(<span class="string">"request"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Phalcon\Http\Request();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//3. 直接创建对象注入</span></span><br><span class="line">$di-&gt;set(<span class="string">"request"</span>, <span class="keyword">new</span> Phalcon\Http\Request());</span><br><span class="line"></span><br><span class="line"><span class="comment">//4. 数组方式注入，好处：不用实例化/解析服务，就可以改变定义服务</span></span><br><span class="line">$di-&gt;set(<span class="string">"request"</span>, <span class="keyword">array</span>(</span><br><span class="line"></span><br><span class="line">	<span class="string">"className"</span> =&gt; <span class="string">"Phalcon\Http\Request"</span></span><br><span class="line">));</span><br></pre></td></tr></table></figure>
<p>以上四种方式都会向$di容器注入”request”服务，像以类名字符串注入，方便但缺乏灵活性，数组就相反，而匿名函数是综合两者，一般很少直接创建对象注入，这样会导致di组件不能提供延迟加载，有可能浪费空间资源，因为延迟加载可以让服务被需要时才初始化。</p>
<h3 id="2-Phalcon-DI用法"><a href="#2-Phalcon-DI用法" class="headerlink" title="2. Phalcon\DI用法"></a>2. Phalcon\DI用法</h3><h4 id="从容器得到获取一个服务是一件简单的事情，只要通过“get”方法就可以。这将返回一个服务的新实例："><a href="#从容器得到获取一个服务是一件简单的事情，只要通过“get”方法就可以。这将返回一个服务的新实例：" class="headerlink" title="从容器得到获取一个服务是一件简单的事情，只要通过“get”方法就可以。这将返回一个服务的新实例："></a>从容器得到获取一个服务是一件简单的事情，只要通过“get”方法就可以。这将返回一个服务的新实例：</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$request = $di-&gt;get(<span class="string">"request"</span>);</span><br></pre></td></tr></table></figure>
<p>或者魔术方法获取</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$request = $di-&gt;getRequest();</span><br></pre></td></tr></table></figure>
<p>又或者数组的方式获取<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$request = $di[<span class="string">'request'</span>];</span><br></pre></td></tr></table></figure></p>
<p>参数可以传递到构造函数中，通过添加一个数组的参数到get方法中：(过于复杂)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回new MyComponent("some-parameter", "other");</span></span><br><span class="line">$component = $di-&gt;get(<span class="string">"MyComponent"</span>, <span class="keyword">array</span>(<span class="string">"some-parameter"</span>, <span class="string">"other"</span>));</span><br></pre></td></tr></table></figure>
<h4 id="共享服务"><a href="#共享服务" class="headerlink" title="共享服务"></a>共享服务</h4><p>当服务注册成“shared”类型服务时，意味着这个服务将使用【单例模式】，即服务只有一个实例并能被重复使用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Phalcon</span>\<span class="title">Session</span>\<span class="title">Adapter</span>\<span class="title">Files</span> <span class="title">as</span> <span class="title">SessionFiles</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 把session服务注册成“shared”类型</span></span><br><span class="line">$di-&gt;setShared(<span class="string">'session'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    $session = <span class="keyword">new</span> SessionFiles();</span><br><span class="line">    $session-&gt;start();</span><br><span class="line">    <span class="keyword">return</span> $session;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//第二种实现“shared”类型</span></span><br><span class="line"><span class="comment">// 把session服务注册成“shared”类型</span></span><br><span class="line">$di-&gt;set(<span class="string">'session'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$session = $di-&gt;get(<span class="string">'session'</span>); <span class="comment">// 第一次获取session服务时，session服务将实例化</span></span><br><span class="line">$session = $di-&gt;getSession();   <span class="comment">// 第二次获取时，不再实例化，直接返回第一次实例化的对象</span></span><br></pre></td></tr></table></figure>
<p>倘若不想注册“shared”也可以运用DI组件的getShared方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$request = $di-&gt;getShared(<span class="string">"request"</span>);</span><br></pre></td></tr></table></figure>
<h4 id="通过服务容器实例化类"><a href="#通过服务容器实例化类" class="headerlink" title="通过服务容器实例化类"></a>通过服务容器实例化类</h4><p>当你向服务容器中请求一个服务，如果找不到服务，容器会尝试加载以这个服务为名称的类，这个类的一个实例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 把一个控制器注册为服务</span></span><br><span class="line">$di-&gt;set(<span class="string">'IndexController'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    $component = <span class="keyword">new</span> Component();</span><br><span class="line">    <span class="keyword">return</span> $component;</span><br><span class="line">&#125;, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 把一个控制器注册为服务</span></span><br><span class="line">$di-&gt;set(<span class="string">'MyOtherComponent'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 实际上返回另外一个组件</span></span><br><span class="line">    $component = <span class="keyword">new</span> AnotherComponent();</span><br><span class="line">    <span class="keyword">return</span> $component;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取通过服务容器创建的对象</span></span><br><span class="line">$myComponent = $di-&gt;get(<span class="string">'MyOtherComponent'</span>);</span><br></pre></td></tr></table></figure>
<p>这样的做的好处是把DI组件当作一个类的自动加载器，只要注入了DI容器，那么你可以自由在任意地方切换任意类来获取它的一个实例化对象</p>
<h4 id="如果你自定义的组件需要用到DI组件时，可以通过实现Phalcon-Di-InjectionAwareInterface接口，这样就可以在实例化这个类的对象时自动注入DI的服务"><a href="#如果你自定义的组件需要用到DI组件时，可以通过实现Phalcon-Di-InjectionAwareInterface接口，这样就可以在实例化这个类的对象时自动注入DI的服务" class="headerlink" title="如果你自定义的组件需要用到DI组件时，可以通过实现Phalcon\Di\InjectionAwareInterface接口，这样就可以在实例化这个类的对象时自动注入DI的服务"></a>如果你自定义的组件需要用到DI组件时，可以通过实现<a href="https://docs.phalconphp.com/zh/latest/api/Phalcon_Di_InjectionAwareInterface.html" target="_blank" rel="external">Phalcon\Di\InjectionAwareInterface</a>接口，这样就可以在实例化这个类的对象时自动注入DI的服务</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Component</span> <span class="keyword">implements</span> <span class="title">InjectionAwardInterFace</span></span><br><span class="line"></span>&#123;</span><br><span class="line"> 	<span class="keyword">protected</span> $_di;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setDi</span><span class="params">($di)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        $this-&gt;_di = $di;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDi</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $this-&gt;_di;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>按照上面这样，一旦服务被解析，$di对象将自动传递到setDi()方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 注册服务</span></span><br><span class="line">$di-&gt;set(<span class="string">'myClass'</span>, <span class="string">'MyClass'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析服务（注意：将自动调用$myClass-&gt;setDi($di)方法）</span></span><br><span class="line">$myClass = $di-&gt;get(<span class="string">'myClass'</span>);</span><br></pre></td></tr></table></figure>
<h4 id="默认工厂-Factory-Default-DI"><a href="#默认工厂-Factory-Default-DI" class="headerlink" title="默认工厂(Factory Default DI)"></a>默认工厂(Factory Default DI)</h4><p>phalcon里提供一种DI变种的组件，叫<a href="https://docs.phalconphp.com/zh/latest/api/Phalcon_Di_FactoryDefault.html" target="_blank" rel="external">Phalcon\Di\FactoryDefault</a>。这个组件本身就注册相应常用的服务，可以创获得这个组件的一个实例进行操作。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Phalcon</span>\<span class="title">Di</span>\<span class="title">FactoryDefault</span>;</span><br><span class="line"></span><br><span class="line">$di = <span class="keyword">new</span> FactoryDefault();</span><br></pre></td></tr></table></figure>
<h4 id="自定义注入器-一般很少需要自己创建注入器"><a href="#自定义注入器-一般很少需要自己创建注入器" class="headerlink" title="自定义注入器(一般很少需要自己创建注入器)"></a>自定义注入器(一般很少需要自己创建注入器)</h4><p>如果你要创建一个自定义注入器或者继承一个已有的，接口<a href="https://docs.phalconphp.com/zh/latest/api/Phalcon_DiInterface.html" target="_blank" rel="external">Phalcon\DiInterface</a> 必须被实现。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Thinkphp]]></title>
      <url>https://blog.chenjunwu.cn/2016/05/11/thinkphp/</url>
      <content type="html"><![CDATA[<p>这次想分享一下thinkphp如何优雅地写API开发，增加代码的复用性，更加符合thinkphp的MVC模式设计</p>
<h2 id="Just-Think-It！"><a href="#Just-Think-It！" class="headerlink" title="Just Think It！"></a>Just Think It！</h2><a id="more"></a>
<h2 id="一、用composer安装thinkphp"><a href="#一、用composer安装thinkphp" class="headerlink" title="一、用composer安装thinkphp"></a>一、用composer安装thinkphp</h2><h3 id="1-windows下采用git-bash安装"><a href="#1-windows下采用git-bash安装" class="headerlink" title="1. windows下采用git-bash安装"></a>1. windows下采用git-bash安装</h3><p><img src="/images/asset/2016/2016-05-11_231903.png" alt="安装"></p>
<h3 id="2-文件目录"><a href="#2-文件目录" class="headerlink" title="2. 文件目录"></a>2. 文件目录</h3><p><img src="/images/asset/2016/2016-05-11_232413.png" alt="目录"></p>
<p>第一次访问<a href="http://localhost:80/myapp" target="_blank" rel="external">http://localhost:80/myapp</a>，thinkphp会自动生成以下目录</p>
<p><img src="/images/asset/2016/2016-05-12_085002.png" alt="第一次访问后"></p>
<ul>
<li>Common : 一般存放自定义配置文件和公共函数，我们也把Model层存放着</li>
<li>Home : 一般存放Home模块的controller(控制器])文件</li>
<li>Runtime : 存放缓存文件，注意部署时切记删除，不然出现各种问题情况</li>
</ul>
<p>一般情况一个应用系统还有管理后台，我们需要自行添加Admin模块，如果我们有特别需要加入其它模块，请查阅thinkphp手册配置 <a href="http://www.kancloud.cn/manual/thinkphp/1867" target="_blank" rel="external">document</a> </p>
<h2 id="二、步入正题"><a href="#二、步入正题" class="headerlink" title="二、步入正题"></a>二、步入正题</h2><h2 id="1-举例说明"><a href="#1-举例说明" class="headerlink" title="1. 举例说明"></a>1. 举例说明</h2><p>假设我们存在这样的需求，我们做一个商城系统某个功能模块，需要向用户展示货物列表那么我们可以这样设计，在Common目录下建立Controller目录存放BaseController.class.php文件作为公共Controller(这样的让所有Controller继承便于添加共有方法属性，BaseContrller继承Tp自带的Controller即可)，在Home目录下建<code>Controller</code>目录，在目录里建立GoodsListController.class.php文件</p>
<p>首先展示Common/function.php文件<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sc_json_success</span><span class="params">($msg=<span class="string">'operate successfully'</span>, $code=<span class="number">20000</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">'code'</span> =&gt; $code,</span><br><span class="line">		<span class="string">'response'</span> =&gt; $msg</span><br><span class="line">	);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sc_json_error</span><span class="params">($msg=<span class="string">'operate error'</span>, $code=<span class="number">40000</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">'code'</span> =&gt; $code,</span><br><span class="line">		<span class="string">'response'</span> =&gt; $msg</span><br><span class="line">	);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sc_json_error_request</span><span class="params">($data = <span class="string">'request method error'</span>, $code = <span class="number">40001</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">    	<span class="string">'code'</span>=&gt; $code,</span><br><span class="line">    	<span class="string">'response'</span>=&gt;$data</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>展示BaseController.class.php文件<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Common</span>\<span class="title">Contrller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Contrller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseContrller</span> <span class="keyword">extends</span> <span class="title">Contrller</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">reqGet</span><span class="params">(array $requert = array<span class="params">()</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(! IS_GET)&#123;</span><br><span class="line">			$this-&gt;ajaxReturn(sc_json_error_request());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//判断必要字段</span></span><br><span class="line">		<span class="keyword">if</span>($requert) &#123;</span><br><span class="line">			<span class="keyword">foreach</span>($request <span class="keyword">as</span> $key) &#123;</span><br><span class="line">				$_k = I(<span class="string">'get.'</span>.$key, <span class="keyword">null</span>);<span class="comment">//过滤xss攻击</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (is_null($_k)) &#123;</span><br><span class="line"></span><br><span class="line">                    $this-&gt;ajaxReturn(td_json_error_request(<span class="string">"require params "</span>.$key.<span class="string">" value"</span>));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(I(<span class="string">'get.'</span>.$key) == <span class="string">''</span>)</span><br><span class="line">                    $this-&gt;ajaxReturn(td_json_error_request(<span class="string">"Params "</span>.$key.<span class="string">" can not be empty"</span>));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> I();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//GoodsListController.class.php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Contrller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Common</span>\<span class="title">Contrller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsListController</span> <span class="keyword">extends</span> <span class="title">BaseContrller</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * [goodsList 展示货物列表]</span><br><span class="line">	 * <span class="doctag">@return</span> &#123;[type]&#125; [json字符串，以json数据交互]</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">goodsList</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		$data = $this-&gt;reqGet();</span><br><span class="line">		<span class="comment">//reqGet()方法在BaseController定义，主要判断请方式是否是GET请求以及接受GET的参数，具体实现可以自己写</span></span><br><span class="line">		...</span><br><span class="line">		......</span><br><span class="line"></span><br><span class="line">		$this-&gt;ajaxReturn(D(<span class="string">'Goods'</span>)-&gt;showGoodsList($data));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在Common\Model目录下我们同样建立BaseModel.class.php与GoodsModel.class.php，BaseModel继承Tp的Model，GoodsModel继承BaseModel</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//GoodsModel.class.php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodsModel</span> <span class="keyword">extends</span> <span class="title">BaseModel</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * [showGoodsList model层从数据库读取数据]</span><br><span class="line">	 * <span class="doctag">@param</span>  &#123;[type]&#125; array $data         [Controller传递数据]</span><br><span class="line">	 * <span class="doctag">@return</span> &#123;[type]&#125;       [返回数据以及读取状态]</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showGoodsList</span><span class="params">(array $data)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//条件查询</span></span><br><span class="line">		$where = <span class="keyword">array</span>(</span><br><span class="line">			...</span><br><span class="line">		);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//过滤查询</span></span><br><span class="line">		$field = <span class="keyword">array</span>(</span><br><span class="line">			...</span><br><span class="line">		);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//分页</span></span><br><span class="line">		$page = ...;		<span class="comment">//当前页码</span></span><br><span class="line">		$page_show = <span class="number">5</span>;		<span class="comment">//每页显示条目</span></span><br><span class="line">		$total_pages = ceil($this-&gt;where($where)-&gt;count()/$page_show);	<span class="comment">//总页数</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 假设操作数据表名为`sc_goods`，则在Controller运用D()方法时，</span></span><br><span class="line">		<span class="comment">// 当 \Home\Model\UserModel 类不存在的时候，D函数会尝试实例化公共模块下面的 \Common\Model\UserModel 模型类，同时对数据表`sc_goods`具有CURD操作</span></span><br><span class="line"></span><br><span class="line">		$status = $this</span><br><span class="line">			-&gt;where($where)</span><br><span class="line">			-&gt;field($field)</span><br><span class="line">			-&gt;page($page,$page_show)</span><br><span class="line">			-&gt;select();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">//sc_json_success() sc_json_error()均在公共函数文件定义，具有成功和失败的状态码</span></span><br><span class="line">		<span class="keyword">if</span>($status) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> sc_json_success(<span class="keyword">array</span>(</span><br><span class="line">				<span class="string">'page'</span> =&gt; $page,</span><br><span class="line">				<span class="string">'page_show'</span> =&gt; $page_show,</span><br><span class="line">				<span class="string">'total_pages'</span> =&gt; $total_pages,</span><br><span class="line">				<span class="string">'data'</span> =&gt; $status</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> sc_json_error();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样当前端以Ajax方式请求<code>/Home/GoodsList/goodsList</code>，满足条件就会返回一段json数据，貌似很好的完成了工作，但是我们设想一下:<br>当我们做管理后台时，发现管理员要管理货物同样需要货物列表，但是管理员获取的字段，获取的条件会跟普通用户需要的字段有差别，比如管理员可以获取到货物敏感的信息，如商家隐私信息以及货物来源等等，而这些不可以让普通用户知道，但是我们把筛选条件以及过滤字段都放在model层中，如果普通用户与管理员的Controller调用同一个model时必定获取到每件货物相同的信息，怎么办呢？</p>
<blockquote>
<p>A. 当然我们可以为管理员在model层再写一个方法返回特定的数据给管理员，但是这样代码的复用性降低，造成代码冗余不利于维护。</p>
<p>B. 我们也可以在model层利用session判断登录状态，判断当前获取数据者是普通用户还是管理员，根据这个为where条件或field筛选添加不同字段，但是这样会加重model层的逻辑，使得model层逻辑趋于Controller加model，于是我有第三套方案。</p>
<p>C. 我会把model层的条件当作参数传入，只把model层当作与数据库之间进行通讯桥梁，至于我需要什么数据的逻辑我交给Controller控制。</p>
</blockquote>
<p><strong> 改写GoodsModel的方法showGoodsList </strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showGoodsList</span><span class="params">(array $data, $where=array<span class="params">()</span>, $field=array<span class="params">()</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//分页</span></span><br><span class="line">	$page = ...;		<span class="comment">//当前页码</span></span><br><span class="line">	$page_show = <span class="number">5</span>;		<span class="comment">//每页显示条目，如果你觉得分页每页也不同同样也可以交给Controller控制</span></span><br><span class="line">	$total_pages = ceil($this-&gt;where($where)-&gt;count()/$page_show);	<span class="comment">//总页数</span></span><br><span class="line"></span><br><span class="line">	$status = $this</span><br><span class="line">		-&gt;where($where)</span><br><span class="line">		-&gt;field($field)</span><br><span class="line">		-&gt;page($page,$page_show)</span><br><span class="line">		-&gt;select();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>($status) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> sc_json_success(<span class="keyword">array</span>(</span><br><span class="line">			<span class="string">'page'</span> =&gt; $page,</span><br><span class="line">			<span class="string">'page_show'</span> =&gt; $page_show,</span><br><span class="line">			<span class="string">'total_pages'</span> =&gt; $total_pages,</span><br><span class="line">			<span class="string">'data'</span> =&gt; $status</span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> sc_json_error();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong> 改写Home/Controller/GoodsListController下goodsList方法 </strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">goodsList</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	$data = $this-&gt;reqGet();</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	$where = <span class="keyword">array</span>(</span><br><span class="line">		...</span><br><span class="line">	);</span><br><span class="line"></span><br><span class="line">	$field = <span class="keyword">array</span>(</span><br><span class="line">		...</span><br><span class="line">	);</span><br><span class="line"></span><br><span class="line">	$this-&gt;ajaxReturn(</span><br><span class="line">		D(<span class="string">'Goods'</span>)-&gt;showGoodsList($data, $where, $field)</span><br><span class="line">	);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同理我们在Admin模块下建立管理员管理列表时我们向model传递不同的条件就可以获取不同的数据，使得model层代码的复用性增强，降低代码重复，我们也可以少写垃圾代码了哈哈！！！</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[同步，异步，阻塞，非阻塞]]></title>
      <url>https://blog.chenjunwu.cn/2016/05/11/synchronous-blocking-asynchronous-non-blocking/</url>
      <content type="html"><![CDATA[<p>博主想谈谈自己对于同步，异步，阻塞，非阻塞四个概念认识和理解，语言以JavaScript为基础展开谈论，初学，有错纠正。</p>
<h2 id="开始啦！"><a href="#开始啦！" class="headerlink" title="开始啦！"></a>开始啦！</h2><!-- ![异步与同步](/images/asset/2016/c10f0ff42939d0.png) -->
<a id="more"></a>
<h2 id="一、同步与异步"><a href="#一、同步与异步" class="headerlink" title="一、同步与异步"></a>一、同步与异步</h2><h3 id="1-概念解析"><a href="#1-概念解析" class="headerlink" title="1. 概念解析"></a>1. 概念解析</h3><h4 id="A-同步"><a href="#A-同步" class="headerlink" title="A. 同步"></a>A. 同步</h4><p><strong>概念</strong>: 指程序运行时发出一个函数调用，在没有得到结果前，该调用不会被返回</p>
<p>按照概念，大多数函数调用都是同步调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i &lt; <span class="number">1000</span>;i++)&#123;</span><br><span class="line">		<span class="keyword">if</span>(i==<span class="number">999</span>) &#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">'f1调用'</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'f2调用'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f1();</span><br><span class="line">f2();</span><br></pre></td></tr></table></figure>
<p>以上定义了两个函数f1，f2，分别先后调用f1，f2，控制台输出结果如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">f1调用</span><br><span class="line">f2调用</span><br></pre></td></tr></table></figure>
<p>f2需要等待f1执行结果才开始执行，如果f1是一个耗时的功能调用，那么就会阻碍到程序的继续运行，所以我们有异步的引入</p>
<h4 id="B-异步"><a href="#B-异步" class="headerlink" title="B. 异步"></a>B. 异步</h4><p><strong> 概念 </strong>: 指程序运行时发出一个函数调用，调用者不会立即得到结果。实际处理这个调用的部件是在调用发出后，通过状态、通知来通知调用者，或通过回调函数处理这个调用。</p>
<p>最典型的就是JavaScript的Ajax请求，以jQuery为例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$.ajax(&#123;</span><br><span class="line">	url: <span class="string">"http://hostname:port/dirname"</span>,</span><br><span class="line">	type: <span class="string">"POST"</span>,</span><br><span class="line">	dataType: <span class="string">"json"</span>,</span><br><span class="line">	success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(data);</span><br><span class="line"></span><br><span class="line">		...</span><br><span class="line">	&#125;,</span><br><span class="line">	error: <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(err);</span><br><span class="line"></span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>当成功发出Ajax请求后，响应的结果会通过success回调函数进行返回，而无需等待请求响应时间，实现异步操作，当然JavaScript的Ajax也可以同步操作，具体用法点击<a href="http://www.w3school.com.cn/jquery/ajax_ajax.asp" target="_blank" rel="external">这里</a></p>
<h3 id="C-三种返回结果途经（从IO的角度）"><a href="#C-三种返回结果途经（从IO的角度）" class="headerlink" title="C. 三种返回结果途经（从IO的角度）"></a>C. 三种返回结果途经（从IO的角度）</h3><p>执行部件和调用者通过三种途经得到结果:</p>
<blockquote>
<p>a. 状态</p>
<p>b. 通知</p>
<p>c. 回调函数</p>
</blockquote>
<p>a: 如果用状态来通知，那么调用者就需要每隔一定时间检查一次，效率就很低</p>
<p>b:  如果是使用通知的方式，效率则很高，因为执行部件几乎不需要做额外的操作。</p>
<p>c: 至于回调函数，和通知没太多区别。</p>
<h3 id="2-抽象例子"><a href="#2-抽象例子" class="headerlink" title="2. 抽象例子"></a>2. 抽象例子</h3><p>进一步抽象现实说明: 假设你去银行办理业务的事件</p>
<p>当你到银行后，有两种方式：<br>(1)到ATM机排队等候            —-(排队等候)同步等待消息<br>(2)大厅取号，等到到你的号时，柜台人员会通知你去办理            —(等待别人通知)异步等待消息</p>
<p><strong> 所以同步与异步中，不同的在于消息通知的机制。</strong></p>
<p>异步消息通知机制中，等待消息者(你)通过注册一个回调机制，让等待的事件(办理业务)触发时由触发机制(柜台人员)通过某种机制(你一开始取的号码)找到等待消息者并通知</p>
<p>同步/异步关注的是消息通知的机制，换而言之通知方式不同，至于怎么处理消息，并不在关注内</p>
<h2 id="二、阻塞与非阻塞"><a href="#二、阻塞与非阻塞" class="headerlink" title="二、阻塞与非阻塞"></a>二、阻塞与非阻塞</h2><h3 id="1-概念解释"><a href="#1-概念解释" class="headerlink" title="1. 概念解释"></a>1. 概念解释</h3><h4 id="A-阻塞"><a href="#A-阻塞" class="headerlink" title="A. 阻塞"></a>A. 阻塞</h4><p><strong> 概念 </strong>: 阻塞调用指调用结果返回之前，当前线程被挂起，函数只有在得到结果之后才返回。</p>
<p>或许会觉得阻塞调用与同步调用等同，实际上是两个不同的概念。</p>
<p>对于同步调用，很多时候同步调用不一定造成阻塞状态，当前线程还处于激活，只是因为同步调用当前函数没有结果返回进入等待状态。</p>
<h4 id="B-非阻塞"><a href="#B-非阻塞" class="headerlink" title="B. 非阻塞"></a>B. 非阻塞</h4><p><strong> 概念 </strong>: 非阻塞调用指调用时不能立即得到结果之前，该函数不会阻塞当前线程而会立即返回。</p>
<h3 id="2-抽象例子-1"><a href="#2-抽象例子-1" class="headerlink" title="2. 抽象例子"></a>2. 抽象例子</h3><p>拿上面排队的例子继续，无论是排队还是等待柜员通知，你都不能干其他事情，那么就相当于阻塞状态，表现在程序里就是该程序一直阻塞在当前函数不能继续执行</p>
<p>相反，当你排队或者等待柜员通知时，你还可以做其他事，比如打电话聊微信，那么就相当于非阻塞状态，表现在程序里就是该程序不会阻塞在当前函数或通知上，而是一边继续执行，一边等待。</p>
<h2 id="三、易混淆点"><a href="#三、易混淆点" class="headerlink" title="三、易混淆点"></a>三、易混淆点</h2><h3 id="1-同步与阻塞"><a href="#1-同步与阻塞" class="headerlink" title="1. 同步与阻塞"></a>1. 同步与阻塞</h3><p><strong> 区别 </strong>: 上述说过两者不等同，同步关注消息通知机制，阻塞强调当前状态，用上面例子再次说明一下，同步相当于你是以排队的方式办理业务，阻塞相当于你在排队或者等待别人通知到你时之前你什么都不能干的状态;</p>
<p>由于两者不同，所以可以组合，就有同步阻塞和同步非阻塞两种:</p>
<p>a: 同步阻塞调用效率低下，因为当程序运行调用某功能时除了等待结果返回当前线程被挂起不能干其他事，运行时间都浪费在等待结果上</p>
<p>b: 同步非阻塞貌似比同步阻塞好，实际上同样效率低下，想象一下刚刚上面提到的例子，当你排队等待时除了时不时观察是否到自己办理业务之外还做其他事情，要在两种行为之间来回切换，在程序上表现在等待过程中不断检测返回结果同时还<del>切换到其他线程上执行</del>，博主对此尚有保留，以JavaScript为例，JavaScript是单线程的但是<a href="https://www.zhihu.com/question/39565359" target="_blank" rel="external">有人</a>实现了同步非阻塞，博主感到神奇，有待研究</p>
<h3 id="2-异步与非阻塞"><a href="#2-异步与非阻塞" class="headerlink" title="2. 异步与非阻塞"></a>2. 异步与非阻塞</h3><p><strong> 区别 </strong>: 与同步和阻塞的区别一样，所以也分异步阻塞与异步非阻塞</p>
<p>a: 异步阻塞指当前程序等待消息通知时没有执行任何事情，当前线程仍处于激活但被挂起</p>
<p>b: 异步非阻塞指当前程序等待消息通知时正在执行其他事情，当前线程不被挂起</p>
<p>异步阻塞与同步阻塞实现效果类似，不同在于API是异步执行还是同步</p>
<hr>
<p>参考: <a href="http://blog.chinaunix.net/uid-26000296-id-3754118.html" target="_blank" rel="external">IO中同步、异步与阻塞、非阻塞的区别</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[10分钟避坑搭建git服务器]]></title>
      <url>https://blog.chenjunwu.cn/2016/05/03/learn-to-make-git-server/</url>
      <content type="html"><![CDATA[<p>这次博主总结了一下自己如何在Linux上搭建自己的git服务器，并且可以完成自动部署<br>本次用到Linux的发行版centos7</p>
<h2 id="废话不多说，动手是关键！"><a href="#废话不多说，动手是关键！" class="headerlink" title="废话不多说，动手是关键！"></a>废话不多说，动手是关键！</h2><a id="more"></a>
<h3 id="1-本机创建公钥和私钥"><a href="#1-本机创建公钥和私钥" class="headerlink" title="1. 本机创建公钥和私钥"></a>1. 本机创建公钥和私钥</h3><p>  <strong>windows下借用git-bash</strong></p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh -keygen -t rsa</span><br></pre></td></tr></table></figure>
<p> 默认在本用户目录下生成公钥和私钥,过程中会要求设置ssh访问的密码，为了方便我们可以设置为空，一路回车即可</p>
<p>  <strong>Linux下操作基本一致</strong></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ28d7lnghjZ ~]# ssh -keygen -t rsa</span><br></pre></td></tr></table></figure>
<p> 这里我们快速略过</p>
<h3 id="2-在服务器上创建git用户"><a href="#2-在服务器上创建git用户" class="headerlink" title="2. 在服务器上创建git用户"></a>2. 在服务器上创建git用户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ28d7lnghjZ ~]# adduser git</span><br><span class="line">[root@iZ28d7lnghjZ ~]# passwd git 	//这里可以修改git用户密码</span><br></pre></td></tr></table></figure>
<h3 id="3-服务器上录入公钥"><a href="#3-服务器上录入公钥" class="headerlink" title="3. 服务器上录入公钥"></a>3. 服务器上录入公钥</h3><ul>
<li>把所有公钥复制到<code>/home/git/.ssh/authorized_keys</code>文件里，一行一个。</li>
<li>注：没有.ssh与authorized_keys文件可自行创建,创建.ssh时记得更改拥有者和权限</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ28d7lnghjZ git]# ls -al</span><br><span class="line">total 24</span><br><span class="line">drwx------  3 git  git  4096 Apr  4 10:12 .</span><br><span class="line">drwxr-xr-x. 3 root root 4096 Apr  4 09:59 ..</span><br><span class="line">-rw-r--r--  1 git  git    18 Nov 20 13:02 .bash_logout</span><br><span class="line">-rw-r--r--  1 git  git   193 Nov 20 13:02 .bash_profile</span><br><span class="line">-rw-r--r--  1 git  git   231 Nov 20 13:02 .bashrc</span><br><span class="line">drwx------  2 root  root  4096 Apr  4 13:37 .ssh</span><br><span class="line">[root@iZ28d7lnghjZ git]# chown -R git:git .ssh </span><br><span class="line">[root@iZ28d7lnghjZ git]# chmod 700 .ssh </span><br><span class="line">[root@iZ28d7lnghjZ git]# ls -al</span><br><span class="line">total 24</span><br><span class="line">drwx------  3 git  git  4096 Apr  4 10:12 .</span><br><span class="line">drwxr-xr-x. 3 root root 4096 Apr  4 09:59 ..</span><br><span class="line">-rw-r--r--  1 git  git    18 Nov 20 13:02 .bash_logout</span><br><span class="line">-rw-r--r--  1 git  git   193 Nov 20 13:02 .bash_profile</span><br><span class="line">-rw-r--r--  1 git  git   231 Nov 20 13:02 .bashrc</span><br><span class="line">drwx------  2 git  git  4096 Apr  4 13:37 .ssh</span><br><span class="line">[root@iZ28d7lnghjZ git]# cd .ssh/</span><br><span class="line">[root@iZ28d7lnghjZ .ssh]# chmod 600 authorized_keys</span><br></pre></td></tr></table></figure>
<ul>
<li>客户端生成id_rsa.pub文件的命令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@git ~]# cat /home/git/.ssh/authorized_keys</span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAwMU4FKB6NRc3XSoIunWsdvVVuSoncbVb5Al6lB3ciswBVd++YmJFhqwkITNGccrO5sycROs9+Fbjgd6oBSzNuaBtCIbwNNsEyM/henTl2euI3XsnJQ/ITr6c/q0P3WoGl4E2QFQ2kZqs+1eDC0CgHcBrqvFv1Jr414sVYK9lfZwIF+jDdtaBOrSJuq1Agx9pGUFUEB4tQfkXxsWm/MvOmKAVvduKDE1eenUEL9zzyeELPcSXLe3NOoTjZhkX6EEXxQR1ZiZRFywLpfM4qopZ10to2KIUyVtzw6hx6V3cg7kn40lYVW0EAMATw9dVldwcRUI+kJzJSKUTKDVSwY3/+Q== root@CHENMINGQIAN</span><br><span class="line"></span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAsmmJuR+KhRSpdSirCiL30RA8WbfgicY1z7itWVnKHJW6hTuJFhzruY59FilVjJR1hbQBluP9JnK3XPSK9PSg+bwiJ2iQRa39rXck35r+trVOLyNbPyfKVRfOemD8YuykMlyr5JeW8gZjsHEuLnJ8//RiCiYzd3RT/SSUQ4yawDoIIWkz3eUSL09xoCRZFBsAp+S/LD3vx2MN+FNOHwvqcE+yK3oRNIqjWwLoKE0e5TRnqNgrPQ95PJYB3XPUulzaeMwsWPZs7jIUMl/5yEqSgAkioa8SVMOsikYJG/erv99NNVgFmpCBIiWqKEGkNrIpYzLLHDSYQ4g5Gbci/RZ54Q== Administrator@WIN2003X323</span><br><span class="line"></span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA6NwUHeNNi+PC6KlrcJrXXDmKxRMmgHIPp79sgX6zqfdSlmNj7rBPQeyEKS9Wg8yI6jd8aG2jsUx99Vjti2VK2vEXKkRHxwID7ri69gE71RfDtv6ekafnzLo14J8hAp0spMk+N3wEAQRYDmcYo1wmnm/jMBedGrHj4NJQ1vYy1hVtJasGMSzjcMrlz9qvaluWnQ5tQjKFQVVwKsRRRzs8qTvzVhLJt4NQ+CAN45tqfsRuf58Uba9QNK7/6xSUiIKXQiILz8PMGJ3MnlV+eN3wx2aeztdevxu9plggtG05SMmd8GNVzXrN1IaxXSvz0UwjQ2kygu7aCqO8AZWH49rouw== leo@LEO-PC</span><br></pre></td></tr></table></figure>
<ul>
<li>说明：我这里有三个用户登录服务器，所以我这里就有三个ssh-rsa，大家可以看一下。</li>
</ul>
<h3 id="4-禁用shell登录"><a href="#4-禁用shell登录" class="headerlink" title="4. 禁用shell登录"></a>4. 禁用shell登录</h3><ul>
<li><p>注，出于安全考虑，创建的git用户不允许登录shell，这可以通过编辑/etc/passwd文件完成。找到类似下面的一行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ28d7lnghjZ ~]# cat /etc/passwd | grep git</span><br><span class="line">git:x:1000:1000:git version control:/home/git:/usr/bin/bash</span><br></pre></td></tr></table></figure>
<p><strong>改为：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ28d7lnghjZ ~]# vim /etc/passwd</span><br><span class="line">git:x:1000:1000:git version control:/home/git:/usr/bin/git-shell</span><br></pre></td></tr></table></figure>
</li>
<li><p>这样，git用户可以正常通过ssh使用git，但无法登录shell，因为我们为git用户指定的git-shell每次一登录就自动退出。</p>
</li>
</ul>
<h3 id="5-如以上配置不行，请注意这里"><a href="#5-如以上配置不行，请注意这里" class="headerlink" title="5. 如以上配置不行，请注意这里"></a>5. 如以上配置不行，请注意这里</h3><p> 到<code>/etc/ssh/</code>目录下查看sshd_config配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ28d7lnghjZ ~]# vim /etc/passwd/sshd_config</span><br></pre></td></tr></table></figure></p>
<p>找到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RSAAuthentication yes # 这行</span><br><span class="line">PubkeyAuthentication yes # 这行</span><br><span class="line"></span><br><span class="line"># The default is to check both .ssh/authorized_keys and .ssh/authorized_keys2</span><br><span class="line"># but this is overridden so installations will only check .ssh/authorized_keys</span><br><span class="line">AuthorizedKeysFile      .ssh/authorized_keys</span><br></pre></td></tr></table></figure>
<ul>
<li>看看有没有开启<code>RSAAuthentication</code>和<code>PubkeyAuthentication</code>，去掉前面的<code>#</code>，<code>AuthorizedKeysFile</code>表示公钥在服务器上的位置</li>
</ul>
<h3 id="6-初始化Git仓库"><a href="#6-初始化Git仓库" class="headerlink" title="6. 初始化Git仓库"></a>6. 初始化Git仓库</h3><p> 先选定一个目录作为Git仓库，假定是/srv/project.git，在/srv目录下输入命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ28d7lnghjZ git]# git init --bare project.git</span><br></pre></td></tr></table></figure></p>
<p> 执行以上命令 Git命令，会创建一个裸仓库，裸仓库没有工作区，因为服务器上的Git仓库纯粹是为了共享，所以不让用户直接登录到服务器上去改工作区，并且服务器上的Git仓库通常都以.git结尾。然后，把owner改为git：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ28d7lnghjZ git]# chown -R git.git project.git</span><br><span class="line">[root@iZ28d7lnghjZ git]# ls -l</span><br><span class="line">[root@iZ28d7lnghjZ git]# </span><br><span class="line">total 4</span><br><span class="line">drwxr-xr-x 7 git git 4096 Apr  4 09:59 project.git</span><br></pre></td></tr></table></figure></p>
<p> <strong>在本地clone下来</strong></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git clone git@yourHost /srv/project.git </span><br><span class="line"># git 以git管理员访问主机</span><br><span class="line"># yourHost 你的主机名</span><br><span class="line"># /srv/project.git 项目在主机上的路径</span><br></pre></td></tr></table></figure>
<h3 id="7-自动化部署代码"><a href="#7-自动化部署代码" class="headerlink" title="7. 自动化部署代码"></a>7. 自动化部署代码</h3><ul>
<li>如果git服务器与web服务器是同一台机子，可以参考一下代码自动化部署</li>
<li>代码部署不是由git服务器处理的，但是强大的git为我们提供了钩子(hooks)功能，让我们尽情发挥自己的想象</li>
<li><p>关于hooks，这里有传送门 <a href="https://git-scm.com/book/zh/v2/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-Git-%E9%92%A9%E5%AD%90" target="_blank" rel="external">Git Hooks</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ28d7lnghjZ ~]# cd /srv/git/baowei.git/hooks</span><br><span class="line"># 题主git服务器的仓库在/srv/git/, baowei.git为项目</span><br><span class="line"></span><br><span class="line">[root@iZ28d7lnghjZ hooks]# vim post-receive</span><br><span class="line"># 如果不存在post-receive可以通过touch post-receive命令创建，再通过chmod +x post-receive给予执行的权限，</span><br><span class="line"># post-receive 介绍: post-receive挂钩在整个过程完结以后运行，可以用来更新其他系统服务或者通知用户。它接受与 pre-receive 相同的标准输入数据。 它的用途包括给某个邮件列表发信，通知持续集成（continous integration）的服务器，或者更新问题追踪系统（ticket-tracking system） —— 甚至可以通过分析提交信息来决定某个问题（ticket）是否应该被开启，修改或者关闭。 该脚本无法终止推送进程，不过客户端在它结束运行之前将保持连接状态，所以如果你想做其他操作需谨慎使用它，因为它将耗费你很长的一段时间。</span><br><span class="line"></span><br><span class="line">#!/bin/sh</span><br><span class="line">unset GIT_DIR</span><br><span class="line">NowPath=`pwd`</span><br><span class="line">DeployPath=&quot;/var/www/html/baiwei&quot;</span><br><span class="line">ClonePath=&quot;/var/www/html/&quot;</span><br><span class="line"></span><br><span class="line"># echo &quot;Now path is :&quot;$NowPath</span><br><span class="line">echo &quot;Deploy path is :&quot;$DeployPath</span><br><span class="line"></span><br><span class="line"># 判断是否第一次部署项目，第一次直接clone，默认部署master分支</span><br><span class="line">if[ -d $DeployPath ]</span><br><span class="line">    then</span><br><span class="line">        cd $DeployPath</span><br><span class="line">        git add . -A &amp;&amp; git stash # remove local changes </span><br><span class="line">        git pull origin master # pull data from master</span><br><span class="line">    else</span><br><span class="line">        cd $ClonePath</span><br><span class="line">        git clone git@115.28.28.8:/srv/git/baowei.git</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># the follow line is also ok:</span><br><span class="line"># git add . &amp;&amp; git fetch origin &amp;&amp; git reset --hard origin/master</span><br><span class="line"></span><br><span class="line">echo &quot;Deploy Done.&quot;</span><br><span class="line">cd $NowPath</span><br><span class="line">echo &quot;It&apos;s fine.&quot;</span><br><span class="line"># --- Finished</span><br><span class="line">exit 0</span><br></pre></td></tr></table></figure>
</li>
<li><p>注意：部署目录/var/www/html/的权限最好全部至少是770，然后项目baowei的要拥有写的功能，所有者必须与部署所用用户一致，不然会出现<code>Permission Denied</code>之类的事情，例如：我的部署用户是git，所以baowei的所有者是git可以通过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ28d7lnghjZ html]# ls -l</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 3 git  git  4096 Apr  5 16:18 baowei</span><br></pre></td></tr></table></figure>
</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[您好, Jim_Chen]]></title>
      <url>https://blog.chenjunwu.cn/2016/05/03/hello-world/</url>
      <content type="html"><![CDATA[<p>欢迎来到 <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! 这是给您的第一份信息。可以到点击这里 <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> 获取更多信息。如果您使用Hexo时有任何问题，可以通过 <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> 找到您要的答案或者在 <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a> 给我留言。<br><!-- Welcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues). --></p>
<!-- ## Quick Start -->
<h2 id="让我们开始吧！"><a href="#让我们开始吧！" class="headerlink" title="让我们开始吧！"></a>让我们开始吧！</h2><a id="more"></a>
<!-- ### Create a new post -->
<h3 id="创建一份新的文档"><a href="#创建一份新的文档" class="headerlink" title="创建一份新的文档"></a>创建一份新的文档</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<!-- More info: [Writing](https://hexo.io/docs/writing.html) -->
<p>更多信息: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<!-- ### Run server -->
<h3 id="运行服务器"><a href="#运行服务器" class="headerlink" title="运行服务器"></a>运行服务器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<!-- More info: [Server](https://hexo.io/docs/server.html) -->
<p>更多信息: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<!-- ### Generate static files -->
<h3 id="生成静态文件"><a href="#生成静态文件" class="headerlink" title="生成静态文件"></a>生成静态文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<!-- More info: [Generating](https://hexo.io/docs/generating.html) -->
<p>更多信息: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<!-- ### Deploy to remote sites -->
<h3 id="部署到远程站点"><a href="#部署到远程站点" class="headerlink" title="部署到远程站点"></a>部署到远程站点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<!-- More info: [Deployment](https://hexo.io/docs/deployment.html) -->
<p>更多信息: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>
]]></content>
    </entry>
    
  
  
</search>
